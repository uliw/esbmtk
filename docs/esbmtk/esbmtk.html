<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.0.0"/>
    <title>esbmtk.esbmtk API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(:first-of-type){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section:first-of-type details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;esbmtk</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#Model">Model</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Model.__init__">Model</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.info">info</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.save_state">save_state</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.save_data">save_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.restart">restart</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.read_state">read_state</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.merge_temp_results">merge_temp_results</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.plot">plot</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.run">run</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.get_delta_values">get_delta_values</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.sub_sample_data">sub_sample_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.ode_uli">ode_uli</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.list_species">list_species</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.flux_summary">flux_summary</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.connection_summary">connection_summary</a>
                        </li>
                        <li>
                                <a class="function" href="#Model.clear">clear</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Element">Element</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Element.__init__">Element</a>
                        </li>
                        <li>
                                <a class="function" href="#Element.list_species">list_species</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Species">Species</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Species.__init__">Species</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ReservoirBase">ReservoirBase</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReservoirBase.__init__">ReservoirBase</a>
                        </li>
                        <li>
                                <a class="function" href="#ReservoirBase.get_process_args">get_process_args</a>
                        </li>
                        <li>
                                <a class="function" href="#ReservoirBase.info">info</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Reservoir">Reservoir</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Reservoir.__init__">Reservoir</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.concentration">concentration</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.delta">delta</a>
                        </li>
                        <li>
                                <a class="variable" href="#Reservoir.mass">mass</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Flux">Flux</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Flux.__init__">Flux</a>
                        </li>
                        <li>
                                <a class="function" href="#Flux.info">info</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceSink">SourceSink</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SourceSink.__init__">SourceSink</a>
                        </li>
                        <li>
                                <a class="variable" href="#SourceSink.delta">delta</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Sink">Sink</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#Source">Source</a>
                            <ul class="memberlist">
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a><wbr>.esbmtk    </h1>

                        <div class="docstring"><p>esbmtk: A general purpose Earth Science box model toolkit
Copyright (C), 2020 Ulrich G. Wortmann</p>

<p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     esbmtk: A general purpose Earth Science box model toolkit</span>
<span class="sd">     Copyright (C), 2020 Ulrich G. Wortmann</span>

<span class="sd">     This program is free software: you can redistribute it and/or modify</span>
<span class="sd">     it under the terms of the GNU General Public License as published by</span>
<span class="sd">     the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">     (at your option) any later version.</span>

<span class="sd">     This program is distributed in the hope that it will be useful,</span>
<span class="sd">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">     GNU General Public License for more details.</span>

<span class="sd">     You should have received a copy of the GNU General Public License</span>
<span class="sd">     along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">tp</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="k">as</span> <span class="nn">col</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

<span class="kn">from</span> <span class="nn">.esbmtk_base</span> <span class="kn">import</span> <span class="n">esbmtkBase</span>

<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">show_data</span><span class="p">,</span>
    <span class="n">plot_geometry</span><span class="p">,</span>
    <span class="n">get_plot_layout</span><span class="p">,</span>
    <span class="n">find_matching_strings</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.solver</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_l_mass</span><span class="p">,</span>
    <span class="n">execute</span><span class="p">,</span>
    <span class="n">execute_e</span><span class="p">,</span>
    <span class="n">get_delta_h</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">if</span> <span class="n">tp</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.extended_classes</span> <span class="kn">import</span> <span class="n">GasReservoir</span><span class="p">,</span> <span class="n">ExternalData</span><span class="p">,</span> <span class="n">DataField</span>
    <span class="kn">from</span> <span class="nn">.connections</span> <span class="kn">import</span> <span class="n">Connection</span>
    <span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="n">Process</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to specify a new model</span>

<span class="sd">    Example:</span>

<span class="sd">          esbmtkModel(name   =  &quot;Test_Model&quot;,</span>
<span class="sd">                      start    = &quot;0 yrs&quot;,    # optional: start time</span>
<span class="sd">                      stop     = &quot;10000 yrs&quot;, # end time</span>
<span class="sd">                      timestep = &quot;2 yrs&quot;,    # as a string &quot;2 yrs&quot;</span>
<span class="sd">                      offset = &quot;0 yrs&quot;,    # optional: time offset for plot</span>
<span class="sd">                      mass_unit = &quot;mol&quot;,   #required</span>
<span class="sd">                      volume_unit = &quot;l&quot;, #required</span>
<span class="sd">                      time_label = optional, defaults to &quot;Time&quot;</span>
<span class="sd">                      display_precision = optional, defaults to 0.01,</span>
<span class="sd">                      m_type = &quot;mass_only/both&quot;</span>
<span class="sd">                      plot_style = &#39;default&#39;, optional defaults to &#39;default&#39;</span>
<span class="sd">                      number_of_datapoints = optional, see below</span>
<span class="sd">                      step_limit = optional, see below</span>
<span class="sd">                      register = &#39;local&#39;, see below</span>
<span class="sd">                      save_flux_data = False, see below</span>
<span class="sd">                      ideal_water = False</span>
<span class="sd">                      use_ode = False</span>
<span class="sd">                    )</span>

<span class="sd">    ref_time: will offset the time axis by the specified amount, when</span>
<span class="sd">                 plotting the data, .i.e., the model time runs from to</span>
<span class="sd">                 100, but you want to plot data as if where from 2000</span>
<span class="sd">                 to 2100, you would specify a value of 2000. This is</span>
<span class="sd">                 for display purposes only, and does not affect the</span>
<span class="sd">                 model. Care must be taken that any external data</span>
<span class="sd">                 references the model time domain, and not the display</span>
<span class="sd">                 time.</span>

<span class="sd">    display precision: affects the on-screen display of data. It is</span>
<span class="sd">                       also cutoff for the graphicak output. I.e., the</span>
<span class="sd">                       interval f the y-axis will not be smaller than</span>
<span class="sd">                       the display_precision.</span>

<span class="sd">    m_type: enables or disables isotope calculation for the entire</span>
<span class="sd">            model.  The default value is &quot;Not set&quot; in this case</span>
<span class="sd">            isotopes will only be calculaten for reservoirs which set</span>
<span class="sd">            the isotope keyword. &#39;mass_only&#39; &#39;both&#39; will override the</span>
<span class="sd">            reservoir settings</span>

<span class="sd">    register = local/None. If set to &#39;None&#39; all objects are registered</span>
<span class="sd">               in the global namespace the default setting is local,</span>
<span class="sd">               i.e. all objects are registered in the model namespace.</span>

<span class="sd">    save_flux_data: Normally, flux data is not stored. Set this to True</span>
<span class="sd">               for debugging puposes. Note, Fluxes with signals are always</span>
<span class="sd">               stored. You can also enable this option for inidividual</span>
<span class="sd">               connections (fluxes).</span>

<span class="sd">    get_delta_values: Compute delta values as postprocessing step.</span>

<span class="sd">    All of the above keyword values are available as variables with</span>
<span class="sd">    Model_Name.keyword</span>

<span class="sd">    The user facing methods of the model class are</span>
<span class="sd">       - Model_Name.info()</span>
<span class="sd">       - Model_Name.save_data()</span>
<span class="sd">       - Model_Name.plot_data()</span>
<span class="sd">       - Model_Name.plot_reservoirs() takes an optional filename as argument</span>
<span class="sd">       - Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</span>
<span class="sd">       - Model_Name.save_state() Save the model state</span>
<span class="sd">       - Model_name.read_state() Initialize with a previous model state</span>
<span class="sd">       - Model_Name.run(), there are 2 optional arguments here, solver=&quot;hybrid&quot;</span>
<span class="sd">         and solver = &quot;numba&quot;. Both involve a 3 to 5 second overhead. The hybrid</span>
<span class="sd">         solver is compatible with all connection types, and about 3 times faster</span>
<span class="sd">         than the  regular solver. The numba solver is about 10 faster, but currently</span>
<span class="sd">         only supports a limited set of connection types.</span>
<span class="sd">       - Model_Name.list_species()</span>
<span class="sd">       - Model_name.flux_summary()</span>
<span class="sd">       - Model_Name.connection_summary()</span>


<span class="sd">    User facing variable are Model_Name.time which contains the time</span>
<span class="sd">    axis.</span>

<span class="sd">    Optional, you can provide the element keyword which will setup a</span>
<span class="sd">    default set of Species for Carbon and Sulfur. In this case, there</span>
<span class="sd">    is no need to define elements or species. The argument to this</span>
<span class="sd">    keyword are either &quot;Carbon&quot;, or &quot;Sulfur&quot; or both as a list</span>
<span class="sd">    [&quot;Carbon&quot;, &quot;Sulfur&quot;].</span>


<span class="sd">    Dealing with large datasets:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    1) Limiting the size of the data which is being saved with save_data()</span>

<span class="sd">         number_of_datapoints = 100 will only write every nth data point to file.</span>
<span class="sd">                                where n = timesteps/ number_of_datapoints</span>

<span class="sd">         this defaults to 1000 until set explicitly.</span>

<span class="sd">    2) Reducing the memory footprint</span>

<span class="sd">    Models with a long runtime can easily exceed the available</span>
<span class="sd">    computer memory, as much if it is goobled up storing the model</span>
<span class="sd">    results. In this case, one can set the optional parameter</span>

<span class="sd">       step_limit = 1E6</span>

<span class="sd">    The above will limit the total number of iterations to 1E6, then</span>
<span class="sd">    save the data up to this point, and then restart the</span>
<span class="sd">    model. Subsequent results will be appended to the results.</span>

<span class="sd">    Caveat Emptor: If your model uses a signal instance, all signal</span>
<span class="sd">    data must fit into a single iteration set. At present, there is no</span>
<span class="sd">    support for signals which extend beyond the step_limit.</span>

<span class="sd">    In order to prevent the creation of massive datafiles, number_of_datapoints</span>
<span class="sd">    defaults to 1000. Modify as needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="c1"># from . import ureg, Q_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m**3&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol/kg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Set&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;number_of_datapoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;step_limit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e9</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;use_ode&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lic</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of all reservoir type objects</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># set of flux processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># keep track of repeated solver calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/kg&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/l&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/liter&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="si">}</span><span class="s2"> must be either mol/l or mol/kg&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1"># self.start = self.start + self.offset</span>
        <span class="c1"># self.stop = self.stop + self.offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># calculate stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">species_definitions</span><span class="p">,</span> <span class="n">hypsometry</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="c1"># register elements and species with model</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
                <span class="c1"># get function handle</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">species_definitions</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register element with model</span>
                <span class="c1"># get element handle</span>
                <span class="n">eh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="c1"># register species with model</span>
                <span class="n">eh</span><span class="o">.</span><span class="n">__register_species_with_model__</span><span class="p">()</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="c1"># if &quot;index&quot; not in kwargs:</span>
        <span class="c1">#    index = 0</span>
        <span class="c1"># else:</span>
        <span class="c1"># index = kwargs[&quot;index&quot;]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>
<span class="sd">        append = True/False #</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;stride&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stride&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;stop&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="k">if</span> <span class="s2">&quot;append&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;append&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start = </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, stop = </span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">, stride=</span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">, append =</span><span class="si">{</span><span class="n">append</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="c1"># print(f&quot;R = {r.full_name}&quot;)</span>
            <span class="c1"># print(f&quot;start = {start}, stop = {stop}, stride={stride}, append ={append}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="c1"># for r in self.ldf:</span>
        <span class="c1">#     r.__write_data__(prefix, start, stop, stride, append)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing virtual reservoir data&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done writing&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restart the model with result of the last run.</span>
<span class="sd">        This is useful for long runs which otherwise would used</span>
<span class="sd">        to much memory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="c1"># print(f&quot;len of time {len(self.time)}, stride = {self.stride}&quot;)</span>
        <span class="c1"># print(f&quot;len of time with stride {len(self.time[0 : -2 : self.stride])}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new start = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, new stop = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time[0] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> time[-1] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># print(f&quot;len of timec {len(self.timec)}&quot;)</span>
        <span class="c1"># self.time = (arange(self.steps) * self.dt) + self.start</span>

    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)):</span>
                <span class="c1"># print(f&quot; reading from {r.full_name}&quot;)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="c1"># print(f&quot;lvr  reading from {r.full_name}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_temp_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the datafields which were used for an individual iteration</span>
<span class="sd">        with the data we saved from the previous iterations</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timec</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in pl</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># row, col</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>

        <span class="sd">&quot;&quot;&quot; The shape of the ax value of subplots depends on the figure</span>
<span class="sd">        geometry. So we need to ensure we are dealing with a 2-D array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># row=1, col=1 only one window</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># mutiple rows, one column</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 1 row, multiple columns</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>  <span class="c1"># mutiple rows and mutiple columns</span>

        <span class="c1"># ste plot parameters</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over objects</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># rows</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># columns</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">noo</span><span class="p">:</span>
                    <span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="c1"># new: np.ndarray = np.zeros(4)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over fluxes</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Iteration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting model&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge results&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_temp_results</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span>
            <span class="c1"># after merging, the model steps = number_of_datapoints</span>
        <span class="c1"># print(&quot;Saving data&quot;)</span>
        <span class="c1"># self.save_data(start=0, stop=self.number_of_datapoints, stride=1)</span>
        <span class="c1"># print(&quot;Done Saving&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This run used </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Gbytes of memory </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_delta_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the isotope ratios in the usual delta notation&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta_h</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># for vr in self.lvr:</span>
        <span class="c1">#     vr.d = get_delta_h(vr)</span>

        <span class="c1"># for f in self.lof:</span>
        <span class="c1">#     if f.save_flux_data:</span>
        <span class="c1">#         f.d = get_delta_h(f)</span>

    <span class="k">def</span> <span class="nf">sub_sample_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subsample the data. No need to save 100k lines of data You need to</span>
<span class="sd">        do this _after_ saving the state, but before plotting and</span>
<span class="sd">        saving the data</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stride</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
                <span class="n">vr</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">__run_solver__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.ODEINT_Solver</span> <span class="kn">import</span> <span class="n">run_solver</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;numba&quot;</span><span class="p">:</span>
            <span class="n">execute_e</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;odeint&quot;</span><span class="p">:</span>
            <span class="n">run_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;ode_uli&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ode_uli</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span>
            <span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Solver=</span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> is unkknown, use &#39;python/numba/odeint/ode_uli&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ode_uli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the ode solver based on Uli&#39;s approach&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">write_equations_2</span><span class="p">,</span> <span class="n">get_initial_conditions</span>
        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span><span class="p">,</span> <span class="n">solve_ivp</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">pathlib</span> <span class="k">as</span> <span class="nn">pl</span>

        <span class="c1"># build equation file</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span> <span class="o">=</span> <span class="n">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">icl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">cpl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipl</span> <span class="o">=</span> <span class="n">ipl</span>

        <span class="c1"># write equation system</span>
        <span class="n">eqs_file</span> <span class="o">=</span> <span class="n">write_equations_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loc = </span><span class="si">{</span><span class="n">eqs_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ensure that cwd is in the load path. Required for windows</span>
        <span class="n">cwd</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># import equation system</span>
        <span class="kn">from</span> <span class="nn">equations</span> <span class="kn">import</span> <span class="n">setup_ode</span>

        <span class="n">ode_system</span> <span class="o">=</span> <span class="n">setup_ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># create ode system instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span> <span class="o">=</span> <span class="n">ode_system</span>

        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RK23&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;stype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stype&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;solve_ivp&quot;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;solve_ivp&quot;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                <span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">R</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="c1"># t_eval=self.time,</span>
                <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                <span class="n">first_step</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="c1"># dense_output=True,</span>
                <span class="c1"># max_step=1,</span>
            <span class="p">)</span>

            <span class="c1"># interpolate signals into the ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># interpolate external data into ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="c1"># for ed in self.led:</span>
            <span class="c1">#     ed.y = np.interp(results.t, ed.x, ed.y)</span>

            <span class="c1"># assign results to the esbmtk variables</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">t</span>

            <span class="c1"># interpolate intermediate results to match the model</span>
            <span class="c1"># time scale. This only applies to data in virtual</span>
            <span class="c1"># data fields</span>
            <span class="k">for</span> <span class="n">gf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span>
                <span class="c1"># get cs instance handle</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">&quot;cs&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;table&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># get ode data</span>
                        <span class="c1"># print(f&quot;R = {gf.full_name} - {k}:\n&quot;</span>
                        <span class="c1">#       f&quot;len(fp) = {len(od[0 : self.ode_system.i])}, &quot;</span>
                        <span class="c1">#       f&quot;len(xp) = {len(self.ode_system.t)}, &quot;</span>
                        <span class="c1">#       f&quot;i = {self.ode_system.i}&quot;)</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                            <span class="n">od</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">i</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">od</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span> <span class="n">tfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># assign results</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">__step_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

    <span class="k">def</span> <span class="nf">__step_update_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>
        <span class="c1"># new = sum_fluxes(flux_list,r,i) # integrate all fluxes in self.lof</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">hs</span><span class="p">])</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
        <span class="c1"># new = new * (new &gt; 0)  # set negative values to zero</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional</span>
<span class="sd">                         conditions, i.e., all words must occur in a given name</span>

<span class="sd">        return_list: bool = False, if True return a list of fluxes matching the filter_by string.</span>

<span class="sd">        exclude:str = exclude all results matching this string</span>

<span class="sd">        Example:</span>

<span class="sd">              names = M.flux_summary(filter_by=&quot;POP A_sb&quot;, return_list=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fby</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">check_exlusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;exclude&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exclude&quot;</span><span class="p">]</span>
            <span class="n">check_exlusion</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;return_list&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over flux list</span>

            <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">check_exlusion</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rl</span>

    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional conditions</span>
<span class="sd">                         i.e., all words must occur in a given name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fby = </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># extract all connection groups. Note that loc contains all connections</span>
        <span class="c1"># i.e., not connection groups.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="c1"># if &quot;.&quot; in c.full_name:</span>
            <span class="c1"># if c.register not in self.cg_list and c.register != &quot;None&quot;:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">register</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a regular connnection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Group Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       run the following command to see more details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if all words of the fby list occur in c.full_name. If yes,</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fby</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete all model objects&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deleting </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">__builtins__</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more elements.  This class sets</span>
<span class="sd">    element specific properties</span>

<span class="sd">    Example::</span>

<span class="sd">            Element(name      = &quot;S &quot;           # the element name</span>
<span class="sd">                    model     = Test_model     # the model handle</span>
<span class="sd">                    mass_unit =  &quot;mol&quot;,        # base mass unit</span>
<span class="sd">                    li_label  =  &quot;$^{32$S&quot;,    # Label of light isotope</span>
<span class="sd">                    hi_label  =  &quot;$^{34}S&quot;,    # Label of heavy isotope</span>
<span class="sd">                    d_label   =  r&quot;$\delta^{34}$S&quot;,  # Label for delta value</span>
<span class="sd">                    d_scale   =  &quot;VCDT&quot;,       # Isotope scale</span>
<span class="sd">                    r         = 0.044162589,   # isotopic abundance ratio for element</span>
<span class="sd">                  )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set element properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize all instance variables&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;li_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;hi_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;d_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;d_scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="c1"># self.__initerrormessages__()</span>
        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">li_label</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_label</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_label</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_scale</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of species for this element.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List all species which are predefined for this element&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__register_species_with_model__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Bit of  hack, but makes model code more readable&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Species</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more species.  This class sets species</span>
<span class="sd">    specific properties</span>

<span class="sd">          Example::</span>

<span class="sd">                Species(name = &quot;SO4&quot;,</span>
<span class="sd">                        element = S,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set species properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize all instance variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">GasReservoir</span>

        <span class="c1"># provide a list of all known keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Element</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_as&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="k">if</span> <span class="s2">&quot;display_as&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ln</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">hn</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># ratio of isotope standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># element name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>  <span class="c1"># element handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span>  <span class="c1"># the display string.</span>

        <span class="c1"># self.mo.lsp.append(self)   # register self on the list of model objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register this species with the element</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ReservoirBase</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all Reservoir objects&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;ReservoirBase should never be used. Use the derived classes&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set_legacy_names__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move the below out of the way</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">get_box_geometry_parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># flux references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># flux name:direction pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list holding all processe references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements in thiis reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Species</span><span class="p">,</span> <span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># species flux pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataField</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of datafield objects</span>
        <span class="c1"># list of processes which calculate reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of reservoir</span>
        <span class="c1"># if &quot;register&quot; in self.kwargs:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># self.full_name = f&quot;{self.register.name}.{self.n}&quot;</span>
        <span class="c1"># else:</span>
        <span class="c1">#   self.pt = self.name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="c1"># right y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># set x-axis lable to model time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="c1"># legend_left is in __init__ !</span>

        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get flux data by index&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># update concentration and delta next. This is computationally inefficient</span>
        <span class="c1"># but the next time step may depend on on both variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># update concentration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># update concentration</span>

    <span class="k">def</span> <span class="nf">__update_mass__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Place holder function&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;__update_mass__ is not yet implmented&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the data structure which needs to be passed to the numba solver&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 3</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_mass__</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># some short hands</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># species name</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># species handle</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># sdn = self.sp.dn  # delta name</span>
        <span class="c1"># sds = self.sp.ds  # delta scale</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># mass</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># light isotope</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">cmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># concentration</span>

        <span class="n">fullname</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># Assemble the headers and data for the reservoir fluxes</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">in</span> <span class="n">fullname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> is a double&quot;</span><span class="p">)</span>
            <span class="n">fullname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">fmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># m</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">fmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># m</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># l</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;Reset data with {len(self.m)}, stride = {self.mo.reset_stride}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy the result of the last computation back to the beginning</span>
<span class="sd">        so that a new run will start with these values</span>

<span class="sd">        save the current results into the temp fields</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;Reset data with {len(self.m)}, stride = {self.mo.reset_stride}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>
        <span class="c1"># self.dc = np.append(self.dc, self.d[0 : -2 : self.mo.reset_stride])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>

        <span class="c1"># copy last result into first field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># self.h[0] = self.h[-2]</span>
        <span class="c1"># self.d[0] = self.d[-2]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span>
        <span class="c1"># self.d = self.dc</span>

    <span class="k">def</span> <span class="nf">__read_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read data from csv-file into a dataframe</span>

<span class="sd">        The CSV file must have the following columns</span>

<span class="sd">        Model Time     t</span>
<span class="sd">        Reservoir_Name m</span>
<span class="sd">        Reservoir_Name l</span>
<span class="sd">        Reservoir_Name h</span>
<span class="sd">        Reservoir_Name d</span>
<span class="sd">        Reservoir_Name c</span>
<span class="sd">        Flux_name m</span>
<span class="sd">        Flux_name l etc etc.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">is_name_in_list</span><span class="p">,</span> <span class="n">get_object_from_list</span>

        <span class="n">read</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">curr</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading state for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Flux </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> does not exist in Reservoir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># get a set of all current fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Adding Flux </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> to list of fluxes to read&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

        <span class="c1"># the headers contain the object name for each data in the</span>
        <span class="c1"># reservoir or flux thus, we must reduce the list to unique</span>
        <span class="c1"># object names first. Note, we must preserve order</span>
        <span class="n">header_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
                <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># loop over all columns</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># we ignore the time column</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># this finds the reservoir name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found reservoir data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign_reservoir_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># this loops over all fluxes in a reservoir</span>
            <span class="k">elif</span> <span class="n">is_name_in_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.lof&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;found object </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> adding flux data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">read</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign_flux_data__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find Flux </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if we missed any fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">read</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: Did not find values for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s2"> in saved state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__assign_flux_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the third last entry data to all values in flux</span>

<span class="sd">        parameters: df = dataframe</span>
<span class="sd">                    col = column number</span>
<span class="sd">                    res = true if reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># obj.fa[2] = df.iloc[0, col + 2]</span>
        <span class="c1"># obj.fa[3] = df.iloc[0, col + 3]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">__assign_reservoir_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the third last entry data to all values in reservoir</span>

<span class="sd">        parameters: df = dataframe</span>
<span class="sd">                    col = column number</span>
<span class="sd">                    res = true if reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">m</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">l</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># obj.h[:] = df.iloc[-3, col + 2]</span>
        <span class="c1"># obj.d[:] = df.iloc[-3, col + 3]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">==</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y1_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">==</span> <span class="s2">&quot;ppm&quot;</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">y1_label</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y1_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y1_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="c1"># add any external data if present</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">d</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">yd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this reservoir</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Connnections:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Fluxes:&quot;</span><span class="p">)</span>

        <span class="c1"># m = Q_(&quot;1 Sv&quot;).to(&quot;l/a&quot;).magnitude</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the info method on any of the above connections&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to see information on fluxes and processes&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Reservoir</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information.</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,      # Name of reservoir</span>
<span class="sd">                            species = S,          # Species handle</span>
<span class="sd">                            delta = 20,           # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            mass/concentration = &quot;1 unit&quot;  # species concentration or mass</span>
<span class="sd">                            volume/geometry = &quot;1E5 l&quot;,      # reservoir volume (m^3)</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            seawater_parameters= dict, optional</span>
<span class="sd">                            )</span>

<span class="sd">          You must either give mass or concentration.  The result will always be displayed</span>
<span class="sd">          as concentration though.</span>

<span class="sd">          You must provide either the volume or the geometry keyword. In the latter case</span>
<span class="sd">          provide a list where the first entry is the upper depth datum, the second entry is</span>
<span class="sd">          the lower depth datum, and the third entry is the area percentage. E.g., to specify</span>
<span class="sd">          the upper 200 meters of the entire ocean, you would write:</span>

<span class="sd">                 geometry=[0,-200,1]</span>

<span class="sd">          the corresponding ocean volume will then be calculated by the calc_volume method</span>
<span class="sd">          in this case the following instance variables will also be set:</span>

<span class="sd">                 self.volume in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">          Adding seawater_properties:</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">          If this optional parameter is specified, a SeaWaterConstants instance will be registered</span>
<span class="sd">          for this Reservoir as Reservoir.swc</span>
<span class="sd">          See the  SeaWaterConstants class for details how to specify the parameters, e.g.:</span>
<span class="sd">          seawater_parameters = {&quot;temperature&quot;: 2, &quot;pressure&quot;: 240, &quot;salinity&quot; : 35},</span>

<span class="sd">          Using a transform function</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">          In some cases, it is useful to transform the reservoir</span>
<span class="sd">          concentration data before plotting it.  A good example is the H+</span>
<span class="sd">          concentration in water which is better displayed as pH.  We can</span>
<span class="sd">          do this by specifying a function to convert the reservoir</span>
<span class="sd">          concentration into pH units::</span>

<span class="sd">              def phc(c :float) -&gt; float:</span>
<span class="sd">                  # Calculate concentration as pH. c can be a number or numpy array</span>

<span class="sd">                  import numpy as np</span>

<span class="sd">                  pH :float = -np.log10(c)</span>
<span class="sd">                  return pH</span>

<span class="sd">          this function can then be added to a reservoir as::</span>

<span class="sd">          hplus.plot_transform_c = phc</span>

<span class="sd">          You can modify the left legend to suit the transform via the legend_left keyword</span>

<span class="sd">          Note, at present the plot_transform_c function will only take one</span>
<span class="sd">          argument, which always defaults to the reservoir</span>
<span class="sd">          concentration. The function must return a single argument which</span>
<span class="sd">          will be interpreted as the transformed reservoir concentration.</span>

<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">any</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># steps = kwargs[&quot;species&quot;].mo.steps</span>
        <span class="c1"># self.m: np.ndarray =np.zeros(steps) + self.mass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ideal_water</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">swc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">SeawaterConstants</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
                    <span class="n">salinity</span><span class="o">=</span><span class="n">salinity</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">=</span> <span class="n">c</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

    <span class="nd">@concentration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>  <span class="c1"># caculate mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@mass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>


<span class="k">class</span> <span class="nc">Flux</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class which defines a flux object. Flux objects contain</span>
<span class="sd">    information which links them to an species, describe things like</span>
<span class="sd">    the mass and time unit, and store data of the total flux rate at</span>
<span class="sd">    any given time step. Similarly, they store the flux of the light</span>
<span class="sd">    and heavy isotope flux, as well as the delta of the flux. This</span>
<span class="sd">    is typically handled through the Connect object. If you set it up manually</span>

<span class="sd">    Flux = (name = &quot;Name&quot; # optional, defaults to _F</span>
<span class="sd">            species = species_handle,</span>
<span class="sd">            delta = any number,</span>
<span class="sd">            rate  = &quot;12 mol/s&quot; # must be a string</span>
<span class="sd">            display_precision = number, optional, inherited from Model</span>
<span class="sd">    )</span>

<span class="sd">     You can access the flux data as</span>
<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">AirSeaExchange</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Connect</span><span class="p">,</span>
            <span class="n">Connection</span><span class="p">,</span>
            <span class="n">Signal</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">GasReservoir</span><span class="p">,</span>
                    <span class="n">Connection</span><span class="p">,</span>
                    <span class="n">Connect</span><span class="p">,</span>
                    <span class="n">AirSeaExchange</span><span class="p">,</span>
                    <span class="n">Signal</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="c1"># if save_flux_data is unsepcified, use model default</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">save_flux_data</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="n">fluxrate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fluxrate</span><span class="p">,</span> <span class="n">li</span><span class="p">])</span>

        <span class="c1"># in case we want to keep the flux data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>  <span class="c1"># add the flux</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># setup dummy variables to keep existing numba data structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Connect</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_F&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_F&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="c1"># print(f&quot;f name set to {self.name}. fn =  {self.full_name}\n&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model flux list</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_without_isotopes__</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>
        <span class="c1"># return self.__get_data__(i)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">fa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;substracting two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">fa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot second axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy the result of the last computation back to the beginning</span>
<span class="sd">        so that a new run will start with these values.</span>

<span class="sd">        Also, copy current results into temp field</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>
            <span class="c1"># copy last element to first position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span>


<span class="k">class</span> <span class="nc">SourceSink</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup a Source/Sink objects. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">               species = SO4,</span>
<span class="sd">               display_precision = number, optional, inherited from Model</span>
<span class="sd">               delta = number or str. optional defaults to &quot;None&quot;</span>
<span class="sd">           )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">SourceGroup</span><span class="p">,</span>
                    <span class="n">SinkGroup</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">ConnectionGroup</span><span class="p">,</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>
        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add source to list of res type objects</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set/Update delta&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
            <span class="c1"># self.provided_kwargs.update({&quot;delta&quot;: d})</span>


<span class="k">class</span> <span class="nc">Sink</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Source(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="c1"># from .extended_classes import *</span>
<span class="c1"># from .connections import Connection, ConnectionGroup, Connect</span>
<span class="c1"># from .processes import *</span>
<span class="c1"># from .carbonate_chemistry import *</span>
<span class="c1"># from .sealevel import *</span>
<span class="c1"># from .solver import *</span>
</pre></div>

        </details>

            </section>
                <section id="Model">
                                <div class="attr class">
        <a class="headerlink" href="#Model">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Model</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is used to specify a new model</span>

<span class="sd">    Example:</span>

<span class="sd">          esbmtkModel(name   =  &quot;Test_Model&quot;,</span>
<span class="sd">                      start    = &quot;0 yrs&quot;,    # optional: start time</span>
<span class="sd">                      stop     = &quot;10000 yrs&quot;, # end time</span>
<span class="sd">                      timestep = &quot;2 yrs&quot;,    # as a string &quot;2 yrs&quot;</span>
<span class="sd">                      offset = &quot;0 yrs&quot;,    # optional: time offset for plot</span>
<span class="sd">                      mass_unit = &quot;mol&quot;,   #required</span>
<span class="sd">                      volume_unit = &quot;l&quot;, #required</span>
<span class="sd">                      time_label = optional, defaults to &quot;Time&quot;</span>
<span class="sd">                      display_precision = optional, defaults to 0.01,</span>
<span class="sd">                      m_type = &quot;mass_only/both&quot;</span>
<span class="sd">                      plot_style = &#39;default&#39;, optional defaults to &#39;default&#39;</span>
<span class="sd">                      number_of_datapoints = optional, see below</span>
<span class="sd">                      step_limit = optional, see below</span>
<span class="sd">                      register = &#39;local&#39;, see below</span>
<span class="sd">                      save_flux_data = False, see below</span>
<span class="sd">                      ideal_water = False</span>
<span class="sd">                      use_ode = False</span>
<span class="sd">                    )</span>

<span class="sd">    ref_time: will offset the time axis by the specified amount, when</span>
<span class="sd">                 plotting the data, .i.e., the model time runs from to</span>
<span class="sd">                 100, but you want to plot data as if where from 2000</span>
<span class="sd">                 to 2100, you would specify a value of 2000. This is</span>
<span class="sd">                 for display purposes only, and does not affect the</span>
<span class="sd">                 model. Care must be taken that any external data</span>
<span class="sd">                 references the model time domain, and not the display</span>
<span class="sd">                 time.</span>

<span class="sd">    display precision: affects the on-screen display of data. It is</span>
<span class="sd">                       also cutoff for the graphicak output. I.e., the</span>
<span class="sd">                       interval f the y-axis will not be smaller than</span>
<span class="sd">                       the display_precision.</span>

<span class="sd">    m_type: enables or disables isotope calculation for the entire</span>
<span class="sd">            model.  The default value is &quot;Not set&quot; in this case</span>
<span class="sd">            isotopes will only be calculaten for reservoirs which set</span>
<span class="sd">            the isotope keyword. &#39;mass_only&#39; &#39;both&#39; will override the</span>
<span class="sd">            reservoir settings</span>

<span class="sd">    register = local/None. If set to &#39;None&#39; all objects are registered</span>
<span class="sd">               in the global namespace the default setting is local,</span>
<span class="sd">               i.e. all objects are registered in the model namespace.</span>

<span class="sd">    save_flux_data: Normally, flux data is not stored. Set this to True</span>
<span class="sd">               for debugging puposes. Note, Fluxes with signals are always</span>
<span class="sd">               stored. You can also enable this option for inidividual</span>
<span class="sd">               connections (fluxes).</span>

<span class="sd">    get_delta_values: Compute delta values as postprocessing step.</span>

<span class="sd">    All of the above keyword values are available as variables with</span>
<span class="sd">    Model_Name.keyword</span>

<span class="sd">    The user facing methods of the model class are</span>
<span class="sd">       - Model_Name.info()</span>
<span class="sd">       - Model_Name.save_data()</span>
<span class="sd">       - Model_Name.plot_data()</span>
<span class="sd">       - Model_Name.plot_reservoirs() takes an optional filename as argument</span>
<span class="sd">       - Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</span>
<span class="sd">       - Model_Name.save_state() Save the model state</span>
<span class="sd">       - Model_name.read_state() Initialize with a previous model state</span>
<span class="sd">       - Model_Name.run(), there are 2 optional arguments here, solver=&quot;hybrid&quot;</span>
<span class="sd">         and solver = &quot;numba&quot;. Both involve a 3 to 5 second overhead. The hybrid</span>
<span class="sd">         solver is compatible with all connection types, and about 3 times faster</span>
<span class="sd">         than the  regular solver. The numba solver is about 10 faster, but currently</span>
<span class="sd">         only supports a limited set of connection types.</span>
<span class="sd">       - Model_Name.list_species()</span>
<span class="sd">       - Model_name.flux_summary()</span>
<span class="sd">       - Model_Name.connection_summary()</span>


<span class="sd">    User facing variable are Model_Name.time which contains the time</span>
<span class="sd">    axis.</span>

<span class="sd">    Optional, you can provide the element keyword which will setup a</span>
<span class="sd">    default set of Species for Carbon and Sulfur. In this case, there</span>
<span class="sd">    is no need to define elements or species. The argument to this</span>
<span class="sd">    keyword are either &quot;Carbon&quot;, or &quot;Sulfur&quot; or both as a list</span>
<span class="sd">    [&quot;Carbon&quot;, &quot;Sulfur&quot;].</span>


<span class="sd">    Dealing with large datasets:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    1) Limiting the size of the data which is being saved with save_data()</span>

<span class="sd">         number_of_datapoints = 100 will only write every nth data point to file.</span>
<span class="sd">                                where n = timesteps/ number_of_datapoints</span>

<span class="sd">         this defaults to 1000 until set explicitly.</span>

<span class="sd">    2) Reducing the memory footprint</span>

<span class="sd">    Models with a long runtime can easily exceed the available</span>
<span class="sd">    computer memory, as much if it is goobled up storing the model</span>
<span class="sd">    results. In this case, one can set the optional parameter</span>

<span class="sd">       step_limit = 1E6</span>

<span class="sd">    The above will limit the total number of iterations to 1E6, then</span>
<span class="sd">    save the data up to this point, and then restart the</span>
<span class="sd">    model. Subsequent results will be appended to the results.</span>

<span class="sd">    Caveat Emptor: If your model uses a signal instance, all signal</span>
<span class="sd">    data must fit into a single iteration set. At present, there is no</span>
<span class="sd">    support for signals which extend beyond the step_limit.</span>

<span class="sd">    In order to prevent the creation of massive datafiles, number_of_datapoints</span>
<span class="sd">    defaults to 1000. Modify as needed.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="c1"># from . import ureg, Q_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m**3&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol/kg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Set&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;number_of_datapoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;step_limit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e9</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;use_ode&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lic</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of all reservoir type objects</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># set of flux processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># keep track of repeated solver calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/kg&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/l&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/liter&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="si">}</span><span class="s2"> must be either mol/l or mol/kg&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1"># self.start = self.start + self.offset</span>
        <span class="c1"># self.stop = self.stop + self.offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># calculate stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">species_definitions</span><span class="p">,</span> <span class="n">hypsometry</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="c1"># register elements and species with model</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
                <span class="c1"># get function handle</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">species_definitions</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register element with model</span>
                <span class="c1"># get element handle</span>
                <span class="n">eh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="c1"># register species with model</span>
                <span class="n">eh</span><span class="o">.</span><span class="n">__register_species_with_model__</span><span class="p">()</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="c1"># if &quot;index&quot; not in kwargs:</span>
        <span class="c1">#    index = 0</span>
        <span class="c1"># else:</span>
        <span class="c1"># index = kwargs[&quot;index&quot;]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>
<span class="sd">        append = True/False #</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;stride&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stride&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;stop&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="k">if</span> <span class="s2">&quot;append&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;append&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start = </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, stop = </span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">, stride=</span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">, append =</span><span class="si">{</span><span class="n">append</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="c1"># print(f&quot;R = {r.full_name}&quot;)</span>
            <span class="c1"># print(f&quot;start = {start}, stop = {stop}, stride={stride}, append ={append}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="c1"># for r in self.ldf:</span>
        <span class="c1">#     r.__write_data__(prefix, start, stop, stride, append)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing virtual reservoir data&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done writing&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restart the model with result of the last run.</span>
<span class="sd">        This is useful for long runs which otherwise would used</span>
<span class="sd">        to much memory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="c1"># print(f&quot;len of time {len(self.time)}, stride = {self.stride}&quot;)</span>
        <span class="c1"># print(f&quot;len of time with stride {len(self.time[0 : -2 : self.stride])}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new start = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, new stop = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time[0] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> time[-1] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># print(f&quot;len of timec {len(self.timec)}&quot;)</span>
        <span class="c1"># self.time = (arange(self.steps) * self.dt) + self.start</span>

    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)):</span>
                <span class="c1"># print(f&quot; reading from {r.full_name}&quot;)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="c1"># print(f&quot;lvr  reading from {r.full_name}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_temp_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the datafields which were used for an individual iteration</span>
<span class="sd">        with the data we saved from the previous iterations</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timec</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in pl</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># row, col</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>

        <span class="sd">&quot;&quot;&quot; The shape of the ax value of subplots depends on the figure</span>
<span class="sd">        geometry. So we need to ensure we are dealing with a 2-D array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># row=1, col=1 only one window</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># mutiple rows, one column</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 1 row, multiple columns</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>  <span class="c1"># mutiple rows and mutiple columns</span>

        <span class="c1"># ste plot parameters</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over objects</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># rows</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># columns</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">noo</span><span class="p">:</span>
                    <span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="c1"># new: np.ndarray = np.zeros(4)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over fluxes</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Iteration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting model&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge results&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_temp_results</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span>
            <span class="c1"># after merging, the model steps = number_of_datapoints</span>
        <span class="c1"># print(&quot;Saving data&quot;)</span>
        <span class="c1"># self.save_data(start=0, stop=self.number_of_datapoints, stride=1)</span>
        <span class="c1"># print(&quot;Done Saving&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This run used </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Gbytes of memory </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_delta_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the isotope ratios in the usual delta notation&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta_h</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># for vr in self.lvr:</span>
        <span class="c1">#     vr.d = get_delta_h(vr)</span>

        <span class="c1"># for f in self.lof:</span>
        <span class="c1">#     if f.save_flux_data:</span>
        <span class="c1">#         f.d = get_delta_h(f)</span>

    <span class="k">def</span> <span class="nf">sub_sample_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subsample the data. No need to save 100k lines of data You need to</span>
<span class="sd">        do this _after_ saving the state, but before plotting and</span>
<span class="sd">        saving the data</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stride</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
                <span class="n">vr</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">__run_solver__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.ODEINT_Solver</span> <span class="kn">import</span> <span class="n">run_solver</span>

        <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;numba&quot;</span><span class="p">:</span>
            <span class="n">execute_e</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;odeint&quot;</span><span class="p">:</span>
            <span class="n">run_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;ode_uli&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ode_uli</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s2">&quot;python&quot;</span><span class="p">:</span>
            <span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Solver=</span><span class="si">{</span><span class="n">solver</span><span class="si">}</span><span class="s2"> is unkknown, use &#39;python/numba/odeint/ode_uli&#39;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">ode_uli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the ode solver based on Uli&#39;s approach&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">write_equations_2</span><span class="p">,</span> <span class="n">get_initial_conditions</span>
        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span><span class="p">,</span> <span class="n">solve_ivp</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">pathlib</span> <span class="k">as</span> <span class="nn">pl</span>

        <span class="c1"># build equation file</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span> <span class="o">=</span> <span class="n">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">icl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">cpl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipl</span> <span class="o">=</span> <span class="n">ipl</span>

        <span class="c1"># write equation system</span>
        <span class="n">eqs_file</span> <span class="o">=</span> <span class="n">write_equations_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loc = </span><span class="si">{</span><span class="n">eqs_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ensure that cwd is in the load path. Required for windows</span>
        <span class="n">cwd</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># import equation system</span>
        <span class="kn">from</span> <span class="nn">equations</span> <span class="kn">import</span> <span class="n">setup_ode</span>

        <span class="n">ode_system</span> <span class="o">=</span> <span class="n">setup_ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># create ode system instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span> <span class="o">=</span> <span class="n">ode_system</span>

        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RK23&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;stype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stype&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;solve_ivp&quot;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;solve_ivp&quot;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                <span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">R</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="c1"># t_eval=self.time,</span>
                <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                <span class="n">first_step</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="c1"># dense_output=True,</span>
                <span class="c1"># max_step=1,</span>
            <span class="p">)</span>

            <span class="c1"># interpolate signals into the ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># interpolate external data into ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="c1"># for ed in self.led:</span>
            <span class="c1">#     ed.y = np.interp(results.t, ed.x, ed.y)</span>

            <span class="c1"># assign results to the esbmtk variables</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">t</span>

            <span class="c1"># interpolate intermediate results to match the model</span>
            <span class="c1"># time scale. This only applies to data in virtual</span>
            <span class="c1"># data fields</span>
            <span class="k">for</span> <span class="n">gf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span>
                <span class="c1"># get cs instance handle</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">&quot;cs&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;table&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># get ode data</span>
                        <span class="c1"># print(f&quot;R = {gf.full_name} - {k}:\n&quot;</span>
                        <span class="c1">#       f&quot;len(fp) = {len(od[0 : self.ode_system.i])}, &quot;</span>
                        <span class="c1">#       f&quot;len(xp) = {len(self.ode_system.t)}, &quot;</span>
                        <span class="c1">#       f&quot;i = {self.ode_system.i}&quot;)</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                            <span class="n">od</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">i</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">od</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span> <span class="n">tfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># assign results</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">__step_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>  <span class="c1"># loop over reservoir processes</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># update fluxes</span>

    <span class="k">def</span> <span class="nf">__step_update_reservoir__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For debugging. Provide reservoir and step number,&quot;&quot;&quot;</span>
        <span class="n">flux_list</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span>
        <span class="c1"># new = sum_fluxes(flux_list,r,i) # integrate all fluxes in self.lof</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flux_list</span><span class="p">:</span>  <span class="c1"># do sum of fluxes in this reservoir</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">ls</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>
            <span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">direction</span>  <span class="c1"># current flux and direction</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ms</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">hs</span><span class="p">])</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span>  <span class="c1"># get flux / timestep</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># add to data from last time step</span>
        <span class="c1"># new = new * (new &gt; 0)  # set negative values to zero</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update reservoir data</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional</span>
<span class="sd">                         conditions, i.e., all words must occur in a given name</span>

<span class="sd">        return_list: bool = False, if True return a list of fluxes matching the filter_by string.</span>

<span class="sd">        exclude:str = exclude all results matching this string</span>

<span class="sd">        Example:</span>

<span class="sd">              names = M.flux_summary(filter_by=&quot;POP A_sb&quot;, return_list=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fby</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">check_exlusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;exclude&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exclude&quot;</span><span class="p">]</span>
            <span class="n">check_exlusion</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;return_list&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over flux list</span>

            <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">check_exlusion</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rl</span>

    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional conditions</span>
<span class="sd">                         i.e., all words must occur in a given name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fby = </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># extract all connection groups. Note that loc contains all connections</span>
        <span class="c1"># i.e., not connection groups.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="c1"># if &quot;.&quot; in c.full_name:</span>
            <span class="c1"># if c.register not in self.cg_list and c.register != &quot;None&quot;:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">register</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a regular connnection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Group Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       run the following command to see more details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if all words of the fby list occur in c.full_name. If yes,</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fby</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete all model objects&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deleting </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">__builtins__</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class is used to specify a new model</p>

<p>Example:</p>

<pre><code>  esbmtkModel(name   =  "Test_Model",
              start    = "0 yrs",    # optional: start time
              stop     = "10000 yrs", # end time
              timestep = "2 yrs",    # as a string "2 yrs"
              offset = "0 yrs",    # optional: time offset for plot
              mass_unit = "mol",   #required
              volume_unit = "l", #required
              time_label = optional, defaults to "Time"
              display_precision = optional, defaults to 0.01,
              m_type = "mass_only/both"
              plot_style = 'default', optional defaults to 'default'
              number_of_datapoints = optional, see below
              step_limit = optional, see below
              register = 'local', see below
              save_flux_data = False, see below
              ideal_water = False
              use_ode = False
            )
</code></pre>

<p>ref_time: will offset the time axis by the specified amount, when
             plotting the data, .i.e., the model time runs from to
             100, but you want to plot data as if where from 2000
             to 2100, you would specify a value of 2000. This is
             for display purposes only, and does not affect the
             model. Care must be taken that any external data
             references the model time domain, and not the display
             time.</p>

<p>display precision: affects the on-screen display of data. It is
                   also cutoff for the graphicak output. I.e., the
                   interval f the y-axis will not be smaller than
                   the display_precision.</p>

<p>m_type: enables or disables isotope calculation for the entire
        model.  The default value is "Not set" in this case
        isotopes will only be calculaten for reservoirs which set
        the isotope keyword. 'mass_only' 'both' will override the
        reservoir settings</p>

<p>register = local/None. If set to 'None' all objects are registered
           in the global namespace the default setting is local,
           i.e. all objects are registered in the model namespace.</p>

<p>save_flux_data: Normally, flux data is not stored. Set this to True
           for debugging puposes. Note, Fluxes with signals are always
           stored. You can also enable this option for inidividual
           connections (fluxes).</p>

<p>get_delta_values: Compute delta values as postprocessing step.</p>

<p>All of the above keyword values are available as variables with
Model_Name.keyword</p>

<p>The user facing methods of the model class are</p>

<ul>
<li>Model_Name.info()</li>
<li>Model_Name.save_data()</li>
<li>Model_Name.plot_data()</li>
<li>Model_Name.plot_reservoirs() takes an optional filename as argument</li>
<li>Model_Name.plot([sb.DIC, sb.TA]) plot any object in the list</li>
<li>Model_Name.save_state() Save the model state</li>
<li>Model_name.read_state() Initialize with a previous model state</li>
<li>Model_Name.run(), there are 2 optional arguments here, solver="hybrid"
 and solver = "numba". Both involve a 3 to 5 second overhead. The hybrid
 solver is compatible with all connection types, and about 3 times faster
 than the  regular solver. The numba solver is about 10 faster, but currently
 only supports a limited set of connection types.</li>
<li>Model_Name.list_species()</li>
<li>Model_name.flux_summary()</li>
<li>Model_Name.connection_summary()</li>
</ul>

<p>User facing variable are Model_Name.time which contains the time
axis.</p>

<p>Optional, you can provide the element keyword which will setup a
default set of Species for Carbon and Sulfur. In this case, there
is no need to define elements or species. The argument to this
keyword are either "Carbon", or "Sulfur" or both as a list
["Carbon", "Sulfur"].</p>

<p>Dealing with large datasets:
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~</p>

<p>1) Limiting the size of the data which is being saved with save_data()</p>

<pre><code> number_of_datapoints = 100 will only write every nth data point to file.
                        where n = timesteps/ number_of_datapoints

 this defaults to 1000 until set explicitly.
</code></pre>

<p>2) Reducing the memory footprint</p>

<p>Models with a long runtime can easily exceed the available
computer memory, as much if it is goobled up storing the model
results. In this case, one can set the optional parameter</p>

<p>step_limit = 1E6</p>

<p>The above will limit the total number of iterations to 1E6, then
save the data up to this point, and then restart the
model. Subsequent results will be appended to the results.</p>

<p>Caveat Emptor: If your model uses a signal instance, all signal
data must fit into a single iteration set. At present, there is no
support for signals which extend beyond the step_limit.</p>

<p>In order to prevent the creation of massive datafiles, number_of_datapoints
defaults to 1000. Modify as needed.</p>
</div>


                            <div id="Model.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Model</span><span class="signature">(**kwargs: dict)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Init Sequence&quot;&quot;&quot;</span>

        <span class="c1"># from . import ureg, Q_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;m**3&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mol/kg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;time_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Years&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot_style&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Set&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;number_of_datapoints&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;step_limit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1e9</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;use_ode&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timestep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;volume_unit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;concentration_unit&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># empty list which will hold all reservoir references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmo2</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmo</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict of all model objects. useful for name lookups</span>

        <span class="c1"># start a log file</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.log&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lic</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of all reservoir type objects</span>
        <span class="c1"># empty list which will hold all connector references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set with connection handles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all element references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list which will hold all species references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># set of flux processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_f</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions affecting fluxes</span>
        <span class="c1"># list of external functions affecting virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># optional keywords for use in the connector class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">olkk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of objects which require a delayed initialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of datafield objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># list of signals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_start</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># keep track of repeated solver calls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes</span>

        <span class="c1"># Parse the strings which contain unit information and convert</span>
        <span class="c1"># into model base units For this we setup 3 variables which define</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/kg&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/l&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span> <span class="o">==</span> <span class="s2">&quot;mol/liter&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="si">}</span><span class="s2"> must be either mol/l or mol/kg&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l_unit</span> <span class="o">=</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>  <span class="c1"># the length unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the time unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># display time units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_unit</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>  <span class="c1"># the volume unit</span>
        <span class="c1"># the concentration unit (mass/volume)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">f_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># the flux unit (mass/time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_unit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>  <span class="c1"># flux as volume/time</span>
        <span class="c1"># this is now defined in __init__.py</span>
        <span class="c1"># ureg.define(&#39;Sverdrup = 1e6 * meter **3 / second = Sv = Sverdrups&#39;)</span>

        <span class="c1"># legacy variable names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1"># self.start = self.start + self.offset</span>
        <span class="c1"># self.stop = self.stop + self.offset</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tu</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># needs to be a string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Time [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># time axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># calculate stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_limit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

        <span class="c1"># set_printoptions(precision=self.display_precision)</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">species_definitions</span><span class="p">,</span> <span class="n">hypsometry</span>

        <span class="k">if</span> <span class="s2">&quot;element&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;element&quot;</span><span class="p">]]</span>

            <span class="c1"># register elements and species with model</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
                <span class="c1"># get function handle</span>
                <span class="n">fh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">species_definitions</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">fh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register element with model</span>
                <span class="c1"># get element handle</span>
                <span class="n">eh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="c1"># register species with model</span>
                <span class="n">eh</span><span class="o">.</span><span class="n">__register_species_with_model__</span><span class="p">()</span>

        <span class="n">warranty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;ESBMTK  Copyright (C) 2020  Ulrich G.Wortmann</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This program comes with ABSOLUTELY NO WARRANTY</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;For details see the LICENSE file</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;This is free software, and you are welcome to redistribute it</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;under certain conditions; See the LICENSE file for details.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">warranty</span><span class="p">)</span>

        <span class="c1"># initialize the hypsometry class</span>
        <span class="n">hypsometry</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hyp&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Init Sequence</p>
</div>


                            </div>
                            <div id="Model.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="c1"># if &quot;index&quot; not in kwargs:</span>
        <span class="c1">#    index = 0</span>
        <span class="c1"># else:</span>
        <span class="c1"># index = kwargs[&quot;index&quot;]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># list elements</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Currently defined elements and their species:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}</span><span class="s2"> Defined Species:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div id="Model.save_state" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.save_state">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">save_state</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save model state. Similar to save data, but only saves the last 10</span>
<span class="sd">        time-steps</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;state_&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Save model state. Similar to save data, but only saves the last 10
time-steps</p>
</div>


                            </div>
                            <div id="Model.save_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.save_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">save_data</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">save_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Save the model results to a CSV file. Each reservoir will have</span>
<span class="sd">        their own CSV file</span>

<span class="sd">        Optional arguments:</span>
<span class="sd">        stride = int  # every nth element</span>
<span class="sd">        start = int   # start index</span>
<span class="sd">        stop = int    # end index</span>
<span class="sd">        append = True/False #</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> must be an integer number&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;stride&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stride&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stride</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span>

        <span class="k">if</span> <span class="s2">&quot;start&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="s2">&quot;stop&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span>

        <span class="k">if</span> <span class="s2">&quot;append&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;append&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">append</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;start = </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, stop = </span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">, stride=</span><span class="si">{</span><span class="n">stride</span><span class="si">}</span><span class="s2">, append =</span><span class="si">{</span><span class="n">append</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="c1"># print(f&quot;R = {r.full_name}&quot;)</span>
            <span class="c1"># print(f&quot;start = {start}, stop = {stop}, stride={stride}, append ={append}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="c1"># save data fields</span>
        <span class="c1"># for r in self.ldf:</span>
        <span class="c1">#     r.__write_data__(prefix, start, stop, stride, append)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing virtual reservoir data&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__write_data__</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done writing&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Save the model results to a CSV file. Each reservoir will have
their own CSV file</p>

<p>Optional arguments:
stride = int  # every nth element
start = int   # start index
stop = int    # end index
append = True/False #</p>
</div>


                            </div>
                            <div id="Model.restart" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.restart">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">restart</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restart the model with result of the last run.</span>
<span class="sd">        This is useful for long runs which otherwise would used</span>
<span class="sd">        to much memory</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__reset_state__</span><span class="p">()</span>

        <span class="c1"># print(f&quot;len of time {len(self.time)}, stride = {self.stride}&quot;)</span>
        <span class="c1"># print(f&quot;len of time with stride {len(self.time[0 : -2 : self.stride])}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stride</span><span class="p">])</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new start = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, new stop = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;time[0] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> time[-1] = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># print(f&quot;len of timec {len(self.timec)}&quot;)</span>
        <span class="c1"># self.time = (arange(self.steps) * self.dt) + self.start</span>
</pre></div>

        </details>

            <div class="docstring"><p>Restart the model with result of the last run.
This is useful for long runs which otherwise would used
to much memory</p>
</div>


                            </div>
                            <div id="Model.read_state" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.read_state">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">read_state</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">read_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This will initialize the model with the result of a previous model</span>
<span class="sd">        run.  For this to work, you will need issue a</span>
<span class="sd">        Model.save_state() command at then end of a model run. This</span>
<span class="sd">        will create the necessary data files to initialize a</span>
<span class="sd">        subsequent model run.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)):</span>
                <span class="c1"># print(f&quot; reading from {r.full_name}&quot;)</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="c1"># print(f&quot;lvr  reading from {r.full_name}&quot;)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__read_state__</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This will initialize the model with the result of a previous model
run.  For this to work, you will need issue a
<a href="#Model.save_state">Model.save_state()</a> command at then end of a model run. This
will create the necessary data files to initialize a
subsequent model run.</p>
</div>


                            </div>
                            <div id="Model.merge_temp_results" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.merge_temp_results">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">merge_temp_results</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">merge_temp_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace the datafields which were used for an individual iteration</span>
<span class="sd">        with the data we saved from the previous iterations</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timec</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">__merge_temp_results__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Replace the datafields which were used for an individual iteration
with the data we saved from the previous iterations</p>
</div>


                            </div>
                            <div id="Model.plot" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.plot">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot</span><span class="signature">(self, pl: list = [], **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot all objects specified in pl</span>

<span class="sd">        M.plot([sb.PO4, sb.DIC],fn=test.pdf)</span>

<span class="sd">        fn is optional</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;fn&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fn&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="n">noo</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">)</span>
        <span class="n">size</span><span class="p">,</span> <span class="n">geo</span> <span class="o">=</span> <span class="n">plot_geometry</span><span class="p">(</span><span class="n">noo</span><span class="p">)</span>  <span class="c1"># adjust layout</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># row, col</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>

        <span class="sd">&quot;&quot;&quot; The shape of the ax value of subplots depends on the figure</span>
<span class="sd">        geometry. So we need to ensure we are dealing with a 2-D array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># row=1, col=1 only one window</span>
            <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># mutiple rows, one column</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># 1 row, multiple columns</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axs</span> <span class="o">=</span> <span class="n">ax</span>  <span class="c1"># mutiple rows and mutiple columns</span>

        <span class="c1"># ste plot parameters</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_style</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Reservoirs&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># loop over objects</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># rows</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">geo</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># columns</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">noo</span><span class="p">:</span>
                    <span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.88</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># create the plot windows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Plot all objects specified in pl</p>

<p>M.plot([sb.PO4, sb.DIC],fn=test.pdf)</p>

<p>fn is optional</p>
</div>


                            </div>
                            <div id="Model.run" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.run">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">run</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Loop over the time vector, and for each time step, calculate the</span>
<span class="sd">        fluxes for each reservoir</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># this has nothing todo with self.time below!</span>
        <span class="n">wts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span>
        <span class="c1"># new: np.ndarray = np.zeros(4)</span>

        <span class="c1"># put direction dictionary into a list</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>  <span class="c1"># loop over reservoirs</span>
            <span class="n">r</span><span class="o">.</span><span class="n">lodir</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over fluxes</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                <span class="n">r</span><span class="o">.</span><span class="n">lodir</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># take care of objects which require a delayed init</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lto</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">__delayed_init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;solver&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="s2">&quot;python&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Iteration </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_solving_iterations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Restarting model&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Merge results&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_temp_results</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span>
            <span class="c1"># after merging, the model steps = number_of_datapoints</span>
        <span class="c1"># print(&quot;Saving data&quot;)</span>
        <span class="c1"># self.save_data(start=0, stop=self.number_of_datapoints, stride=1)</span>
        <span class="c1"># print(&quot;Done Saving&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run_solver__</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># flag that the model has executed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">process_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">wcd</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">wts</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Execution took </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> cpu seconds, wt = </span><span class="si">{</span><span class="n">wcd</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This run used </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">memory_info</span><span class="p">()</span><span class="o">.</span><span class="n">rss</span><span class="o">/</span><span class="mf">1e9</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> Gbytes of memory </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Loop over the time vector, and for each time step, calculate the
fluxes for each reservoir</p>
</div>


                            </div>
                            <div id="Model.get_delta_values" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.get_delta_values">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_delta_values</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_delta_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the isotope ratios in the usual delta notation&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">get_delta_h</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># for vr in self.lvr:</span>
        <span class="c1">#     vr.d = get_delta_h(vr)</span>

        <span class="c1"># for f in self.lof:</span>
        <span class="c1">#     if f.save_flux_data:</span>
        <span class="c1">#         f.d = get_delta_h(f)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Calculate the isotope ratios in the usual delta notation</p>
</div>


                            </div>
                            <div id="Model.sub_sample_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.sub_sample_data">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">sub_sample_data</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">sub_sample_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Subsample the data. No need to save 100k lines of data You need to</span>
<span class="sd">        do this _after_ saving the state, but before plotting and</span>
<span class="sd">        saving the data</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stride</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_datapoints</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stride</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">vr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lvr</span><span class="p">:</span>
                <span class="n">vr</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">__sub_sample_data__</span><span class="p">(</span><span class="n">stride</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Subsample the data. No need to save 100k lines of data You need to
do this _after_ saving the state, but before plotting and
saving the data</p>
</div>


                            </div>
                            <div id="Model.ode_uli" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.ode_uli">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">ode_uli</span><span class="signature">(self, kwargs)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">ode_uli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use the ode solver based on Uli&#39;s approach&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">write_equations_2</span><span class="p">,</span> <span class="n">get_initial_conditions</span>
        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">odeint</span><span class="p">,</span> <span class="n">solve_ivp</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">pathlib</span> <span class="k">as</span> <span class="nn">pl</span>

        <span class="c1"># build equation file</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span> <span class="o">=</span> <span class="n">get_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">R</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">icl</span> <span class="o">=</span> <span class="n">icl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpl</span> <span class="o">=</span> <span class="n">cpl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipl</span> <span class="o">=</span> <span class="n">ipl</span>

        <span class="c1"># write equation system</span>
        <span class="n">eqs_file</span> <span class="o">=</span> <span class="n">write_equations_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">icl</span><span class="p">,</span> <span class="n">cpl</span><span class="p">,</span> <span class="n">ipl</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loc = </span><span class="si">{</span><span class="n">eqs_file</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ensure that cwd is in the load path. Required for windows</span>
        <span class="n">cwd</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># import equation system</span>
        <span class="kn">from</span> <span class="nn">equations</span> <span class="kn">import</span> <span class="n">setup_ode</span>

        <span class="n">ode_system</span> <span class="o">=</span> <span class="n">setup_ode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># create ode system instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span> <span class="o">=</span> <span class="n">ode_system</span>

        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;RK23&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;stype&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;stype&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;solve_ivp&quot;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;solve_ivp&quot;</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">solve_ivp</span><span class="p">(</span>
                <span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">R</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="c1"># t_eval=self.time,</span>
                <span class="n">atol</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span>
                <span class="n">first_step</span><span class="o">=</span><span class="n">Q_</span><span class="p">(</span><span class="s2">&quot;1 hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
                <span class="c1"># dense_output=True,</span>
                <span class="c1"># max_step=1,</span>
            <span class="p">)</span>

            <span class="c1"># interpolate signals into the ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># interpolate external data into ode time domain</span>
            <span class="c1"># must be done before changing model time domain</span>
            <span class="c1"># for ed in self.led:</span>
            <span class="c1">#     ed.y = np.interp(results.t, ed.x, ed.y)</span>

            <span class="c1"># assign results to the esbmtk variables</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">t</span>

            <span class="c1"># interpolate intermediate results to match the model</span>
            <span class="c1"># time scale. This only applies to data in virtual</span>
            <span class="c1"># data fields</span>
            <span class="k">for</span> <span class="n">gf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lpc_r</span><span class="p">:</span>
                <span class="c1"># get cs instance handle</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="s2">&quot;cs&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cs</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s2">&quot;table&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>  <span class="c1"># get ode data</span>
                        <span class="c1"># print(f&quot;R = {gf.full_name} - {k}:\n&quot;</span>
                        <span class="c1">#       f&quot;len(fp) = {len(od[0 : self.ode_system.i])}, &quot;</span>
                        <span class="c1">#       f&quot;len(xp) = {len(self.ode_system.t)}, &quot;</span>
                        <span class="c1">#       f&quot;i = {self.ode_system.i}&quot;)</span>
                        <span class="n">od</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                            <span class="n">od</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ode_system</span><span class="o">.</span><span class="n">i</span><span class="p">],</span>
                        <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">od</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">odeint</span><span class="p">(</span><span class="n">ode_system</span><span class="o">.</span><span class="n">eqs</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,),</span> <span class="n">tfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># assign results</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">icl</span><span class="p">):</span>
                <span class="n">r</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">results</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
</pre></div>

        </details>

            <div class="docstring"><p>Use the ode solver based on Uli's approach</p>
</div>


                            </div>
                            <div id="Model.list_species" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.list_species">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">list_species</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List all  defined species.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lel</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">list_species</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>List all  defined species.</p>
</div>


                            </div>
                            <div id="Model.flux_summary" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.flux_summary">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">flux_summary</span><span class="signature">(self, **kwargs: dict) -&gt; tuple</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">flux_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all model fluxes</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional</span>
<span class="sd">                         conditions, i.e., all words must occur in a given name</span>

<span class="sd">        return_list: bool = False, if True return a list of fluxes matching the filter_by string.</span>

<span class="sd">        exclude:str = exclude all results matching this string</span>

<span class="sd">        Example:</span>

<span class="sd">              names = M.flux_summary(filter_by=&quot;POP A_sb&quot;, return_list=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fby</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">rl</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">check_exlusion</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;exclude&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">exclude</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exclude&quot;</span><span class="p">]</span>
            <span class="n">check_exlusion</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;return_list&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">return_list</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Flux Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># loop over flux list</span>

            <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">check_exlusion</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">exclude</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                        <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_list</span><span class="p">:</span>
            <span class="n">rl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">rl</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show a summary of all model fluxes</p>

<p>Optional parameters:</p>

<p>filter_by :str = filter on flux name or part of flux name
                 words separated by blanks act as additional
                 conditions, i.e., all words must occur in a given name</p>

<p>return_list: bool = False, if True return a list of fluxes matching the filter_by string.</p>

<p>exclude:str = exclude all results matching this string</p>

<p>Example:</p>

<pre><code>  names = M.flux_summary(filter_by="POP A_sb", return_list=True)
</code></pre>
</div>


                            </div>
                            <div id="Model.connection_summary" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.connection_summary">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">connection_summary</span><span class="signature">(self, **kwargs: dict) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">connection_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show a summary of all connections</span>

<span class="sd">        Optional parameters:</span>

<span class="sd">        filter_by :str = filter on flux name or part of flux name</span>
<span class="sd">                         words separated by blanks act as additional conditions</span>
<span class="sd">                         i.e., all words must occur in a given name</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;filter_by&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter_by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fby</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use filter_by instead of filter&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fby = </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># extract all connection groups. Note that loc contains all connections</span>
        <span class="c1"># i.e., not connection groups.</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="c1"># if &quot;.&quot; in c.full_name:</span>
            <span class="c1"># if c.register not in self.cg_list and c.register != &quot;None&quot;:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">register</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a regular connnection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> --- Connection Group Summary -- filtered by </span><span class="si">{</span><span class="n">fby</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       run the following command to see more details:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if all words of the fby list occur in c.full_name. If yes,</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cg_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fby</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">find_matching_strings</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="p">,</span> <span class="n">fby</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show a summary of all connections</p>

<p>Optional parameters:</p>

<p>filter_by :str = filter on flux name or part of flux name
                 words separated by blanks act as additional conditions
                 i.e., all words must occur in a given name</p>
</div>


                            </div>
                            <div id="Model.clear" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Model.clear">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">clear</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete all model objects&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmo</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;deleting </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">__builtins__</span><span class="p">[</span><span class="n">o</span><span class="p">]</span>
</pre></div>

        </details>

            <div class="docstring"><p>delete all model objects</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Model.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Element">
                                <div class="attr class">
        <a class="headerlink" href="#Element">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Element</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Element</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more elements.  This class sets</span>
<span class="sd">    element specific properties</span>

<span class="sd">    Example::</span>

<span class="sd">            Element(name      = &quot;S &quot;           # the element name</span>
<span class="sd">                    model     = Test_model     # the model handle</span>
<span class="sd">                    mass_unit =  &quot;mol&quot;,        # base mass unit</span>
<span class="sd">                    li_label  =  &quot;$^{32$S&quot;,    # Label of light isotope</span>
<span class="sd">                    hi_label  =  &quot;$^{34}S&quot;,    # Label of heavy isotope</span>
<span class="sd">                    d_label   =  r&quot;$\delta^{34}$S&quot;,  # Label for delta value</span>
<span class="sd">                    d_scale   =  &quot;VCDT&quot;,       # Isotope scale</span>
<span class="sd">                    r         = 0.044162589,   # isotopic abundance ratio for element</span>
<span class="sd">                  )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set element properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize all instance variables&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;li_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;hi_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;d_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;d_scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="c1"># self.__initerrormessages__()</span>
        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">li_label</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_label</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_label</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_scale</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of species for this element.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List all species which are predefined for this element&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__register_species_with_model__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Bit of  hack, but makes model code more readable&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Each model, can have one or more elements.  This class sets
element specific properties</p>

<p>Example::</p>

<pre><code>    Element(name      = "S "           # the element name
            model     = Test_model     # the model handle
            mass_unit =  "mol",        # base mass unit
            li_label  =  "$^{32$S",    # Label of light isotope
            hi_label  =  "$^{34}S",    # Label of heavy isotope
            d_label   =  r"$\delta^{34}$S",  # Label for delta value
            d_scale   =  "VCDT",       # Isotope scale
            r         = 0.044162589,   # isotopic abundance ratio for element
          )
</code></pre>
</div>


                            <div id="Element.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Element.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Element</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize all instance variables&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;li_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;hi_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;d_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;d_scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
            <span class="s2">&quot;mass_unit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;mass_unit&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="c1"># self.__initerrormessages__()</span>
        <span class="c1"># self.__validateandregister__(kwargs)  # initialize keyword values</span>

        <span class="c1"># legacy name aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">li_label</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi_label</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_label</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_scale</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of species for this element.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize all instance variables</p>
</div>


                            </div>
                            <div id="Element.list_species" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Element.list_species">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">list_species</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">list_species</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List all species which are predefined for this element&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lsp</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>List all species which are predefined for this element</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Element.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Element.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Species">
                                <div class="attr class">
        <a class="headerlink" href="#Species">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Species</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Species</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Each model, can have one or more species.  This class sets species</span>
<span class="sd">    specific properties</span>

<span class="sd">          Example::</span>

<span class="sd">                Species(name = &quot;SO4&quot;,</span>
<span class="sd">                        element = S,</span>
<span class="sd">    )</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># set species properties</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize all instance variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">GasReservoir</span>

        <span class="c1"># provide a list of all known keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Element</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_as&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="k">if</span> <span class="s2">&quot;display_as&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ln</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">hn</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># ratio of isotope standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># element name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>  <span class="c1"># element handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span>  <span class="c1"># the display string.</span>

        <span class="c1"># self.mo.lsp.append(self)   # register self on the list of model objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register this species with the element</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Each model, can have one or more species.  This class sets species
specific properties</p>

<pre><code>  Example::

        Species(name = "SO4",
                element = S,
</code></pre>

<p>)</p>
</div>


                            <div id="Species.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Species.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Species</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize all instance variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">GasReservoir</span>

        <span class="c1"># provide a list of all known keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;element&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Element</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_as&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;m_weight&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">GasReservoir</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="k">if</span> <span class="s2">&quot;display_as&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># display name of species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mu</span>  <span class="c1"># display name of mass unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ln</span>  <span class="c1"># display name of light isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">hn</span>  <span class="c1"># display name of heavy isotope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">dn</span>  <span class="c1"># display string for delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">ds</span>  <span class="c1"># display string for delta scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span>  <span class="c1"># ratio of isotope standard</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># element name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span>  <span class="c1"># element handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dsa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span>  <span class="c1"># the display string.</span>

        <span class="c1"># self.mo.lsp.append(self)   # register self on the list of model objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">lsp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register this species with the element</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize all instance variables</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Species.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Species.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ReservoirBase">
                                <div class="attr class">
        <a class="headerlink" href="#ReservoirBase">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ReservoirBase</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ReservoirBase</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all Reservoir objects&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;ReservoirBase should never be used. Use the derived classes&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set_legacy_names__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move the below out of the way</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">get_box_geometry_parameters</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># flux references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all external data references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># flux name:direction pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list holding all processe references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Element</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of elements in thiis reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Species</span><span class="p">,</span> <span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># species flux pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldf</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataField</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of datafield objects</span>
        <span class="c1"># list of processes which calculate reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of reservoir</span>
        <span class="c1"># if &quot;register&quot; in self.kwargs:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># self.full_name = f&quot;{self.register.name}.{self.n}&quot;</span>
        <span class="c1"># else:</span>
        <span class="c1">#   self.pt = self.name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="c1"># right y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># set x-axis lable to model time</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="c1"># legend_left is in __init__ !</span>

        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get flux data by index&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># update concentration and delta next. This is computationally inefficient</span>
        <span class="c1"># but the next time step may depend on on both variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># update concentration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># update concentration</span>

    <span class="k">def</span> <span class="nf">__update_mass__</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Place holder function&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;__update_mass__ is not yet implmented&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the data structure which needs to be passed to the numba solver&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 3</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_mass__</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># some short hands</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># species name</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># species handle</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">smu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">cmu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># sdn = self.sp.dn  # delta name</span>
        <span class="c1"># sds = self.sp.ds  # delta scale</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># mass</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">smu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># light isotope</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">cmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># concentration</span>

        <span class="n">fullname</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>  <span class="c1"># Assemble the headers and data for the reservoir fluxes</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">full_name</span> <span class="ow">in</span> <span class="n">fullname</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> is a double&quot;</span><span class="p">)</span>
            <span class="n">fullname</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">fmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># m</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># l</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">fmu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># m</span>
                <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">sp</span><span class="o">.</span><span class="n">ln</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># l</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;Reset data with {len(self.m)}, stride = {self.mo.reset_stride}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy the result of the last computation back to the beginning</span>
<span class="sd">        so that a new run will start with these values</span>

<span class="sd">        save the current results into the temp fields</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;Reset data with {len(self.m)}, stride = {self.mo.reset_stride}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>
        <span class="c1"># self.dc = np.append(self.dc, self.d[0 : -2 : self.mo.reset_stride])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>

        <span class="c1"># copy last result into first field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># self.h[0] = self.h[-2]</span>
        <span class="c1"># self.d[0] = self.d[-2]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span>
        <span class="c1"># self.d = self.dc</span>

    <span class="k">def</span> <span class="nf">__read_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read data from csv-file into a dataframe</span>

<span class="sd">        The CSV file must have the following columns</span>

<span class="sd">        Model Time     t</span>
<span class="sd">        Reservoir_Name m</span>
<span class="sd">        Reservoir_Name l</span>
<span class="sd">        Reservoir_Name h</span>
<span class="sd">        Reservoir_Name d</span>
<span class="sd">        Reservoir_Name c</span>
<span class="sd">        Flux_name m</span>
<span class="sd">        Flux_name l etc etc.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">is_name_in_list</span><span class="p">,</span> <span class="n">get_object_from_list</span>

        <span class="n">read</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">curr</span><span class="p">:</span> <span class="nb">set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading state for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Flux </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> does not exist in Reservoir </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># get a set of all current fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
            <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Adding Flux </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> to list of fluxes to read&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>

        <span class="c1"># the headers contain the object name for each data in the</span>
        <span class="c1"># reservoir or flux thus, we must reduce the list to unique</span>
        <span class="c1"># object names first. Note, we must preserve order</span>
        <span class="n">header_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
                <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c1"># loop over all columns</span>
        <span class="n">col</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># we ignore the time column</span>
        <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Looking for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># this finds the reservoir name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found reservoir data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign_reservoir_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># this loops over all fluxes in a reservoir</span>
            <span class="k">elif</span> <span class="n">is_name_in_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.lof&quot;</span><span class="p">)</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_from_list</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;found object </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> adding flux data for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">read</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">full_name</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__assign_flux_data__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to find Flux </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># test if we missed any fluxes</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">read</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: Did not find values for </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="se">\n</span><span class="s2"> in saved state&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__assign_flux_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the third last entry data to all values in flux</span>

<span class="sd">        parameters: df = dataframe</span>
<span class="sd">                    col = column number</span>
<span class="sd">                    res = true if reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># obj.fa[2] = df.iloc[0, col + 2]</span>
        <span class="c1"># obj.fa[3] = df.iloc[0, col + 3]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">__assign_reservoir_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">res</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign the third last entry data to all values in reservoir</span>

<span class="sd">        parameters: df = dataframe</span>
<span class="sd">                    col = column number</span>
<span class="sd">                    res = true if reservoir</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">m</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">l</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># obj.h[:] = df.iloc[-3, col + 2]</span>
        <span class="c1"># obj.d[:] = df.iloc[-3, col + 3]</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">3</span>

        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">==</span> <span class="s2">&quot;mass&quot;</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y1_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">==</span> <span class="s2">&quot;ppm&quot;</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="mf">1e6</span>
            <span class="n">y1_label</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">y1_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y1_label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">c_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="c1"># add any external data if present</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">d</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">yd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">yd</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this reservoir</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Connnections:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Fluxes:&quot;</span><span class="p">)</span>

        <span class="c1"># m = Q_(&quot;1 Sv&quot;).to(&quot;l/a&quot;).magnitude</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the info method on any of the above connections&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to see information on fluxes and processes&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Base class for all Reservoir objects</p>
</div>


                            <div id="ReservoirBase.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ReservoirBase.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ReservoirBase</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;ReservoirBase should never be used. Use the derived classes&quot;</span>
        <span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ReservoirBase.get_process_args" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ReservoirBase.get_process_args">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_process_args</span><span class="signature">(self)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_process_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Provide the data structure which needs to be passed to the numba solver&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">List</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span>  <span class="c1"># 0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span>  <span class="c1"># 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>  <span class="c1"># 2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>  <span class="c1"># 3</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">func_name</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_mass__</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">List</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">r</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">params</span>
</pre></div>

        </details>

            <div class="docstring"><p>Provide the data structure which needs to be passed to the numba solver</p>
</div>


                            </div>
                            <div id="ReservoirBase.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ReservoirBase.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this reservoir</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Connnections:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Fluxes:&quot;</span><span class="p">)</span>

        <span class="c1"># m = Q_(&quot;1 Sv&quot;).to(&quot;l/a&quot;).magnitude</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lodir</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">f</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use the info method on any of the above connections&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;to see information on fluxes and processes&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ReservoirBase.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Reservoir">
                                <div class="attr class">
        <a class="headerlink" href="#Reservoir">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Reservoir</span><wbr>(<span class="base"><a href="#ReservoirBase">ReservoirBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Reservoir</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information.</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,      # Name of reservoir</span>
<span class="sd">                            species = S,          # Species handle</span>
<span class="sd">                            delta = 20,           # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            mass/concentration = &quot;1 unit&quot;  # species concentration or mass</span>
<span class="sd">                            volume/geometry = &quot;1E5 l&quot;,      # reservoir volume (m^3)</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            seawater_parameters= dict, optional</span>
<span class="sd">                            )</span>

<span class="sd">          You must either give mass or concentration.  The result will always be displayed</span>
<span class="sd">          as concentration though.</span>

<span class="sd">          You must provide either the volume or the geometry keyword. In the latter case</span>
<span class="sd">          provide a list where the first entry is the upper depth datum, the second entry is</span>
<span class="sd">          the lower depth datum, and the third entry is the area percentage. E.g., to specify</span>
<span class="sd">          the upper 200 meters of the entire ocean, you would write:</span>

<span class="sd">                 geometry=[0,-200,1]</span>

<span class="sd">          the corresponding ocean volume will then be calculated by the calc_volume method</span>
<span class="sd">          in this case the following instance variables will also be set:</span>

<span class="sd">                 self.volume in model units (usually liter)</span>
<span class="sd">                 self.are:a surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>

<span class="sd">          Adding seawater_properties:</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">          If this optional parameter is specified, a SeaWaterConstants instance will be registered</span>
<span class="sd">          for this Reservoir as Reservoir.swc</span>
<span class="sd">          See the  SeaWaterConstants class for details how to specify the parameters, e.g.:</span>
<span class="sd">          seawater_parameters = {&quot;temperature&quot;: 2, &quot;pressure&quot;: 240, &quot;salinity&quot; : 35},</span>

<span class="sd">          Using a transform function</span>
<span class="sd">          ~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">          In some cases, it is useful to transform the reservoir</span>
<span class="sd">          concentration data before plotting it.  A good example is the H+</span>
<span class="sd">          concentration in water which is better displayed as pH.  We can</span>
<span class="sd">          do this by specifying a function to convert the reservoir</span>
<span class="sd">          concentration into pH units::</span>

<span class="sd">              def phc(c :float) -&gt; float:</span>
<span class="sd">                  # Calculate concentration as pH. c can be a number or numpy array</span>

<span class="sd">                  import numpy as np</span>

<span class="sd">                  pH :float = -np.log10(c)</span>
<span class="sd">                  return pH</span>

<span class="sd">          this function can then be added to a reservoir as::</span>

<span class="sd">          hplus.plot_transform_c = phc</span>

<span class="sd">          You can modify the left legend to suit the transform via the legend_left keyword</span>

<span class="sd">          Note, at present the plot_transform_c function will only take one</span>
<span class="sd">          argument, which always defaults to the reservoir</span>
<span class="sd">          concentration. The function must return a single argument which</span>
<span class="sd">          will be interpreted as the transformed reservoir concentration.</span>

<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">any</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># steps = kwargs[&quot;species&quot;].mo.steps</span>
        <span class="c1"># self.m: np.ndarray =np.zeros(steps) + self.mass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ideal_water</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">swc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">SeawaterConstants</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
                    <span class="n">salinity</span><span class="o">=</span><span class="n">salinity</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">=</span> <span class="n">c</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span>

    <span class="nd">@concentration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">concentration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>  <span class="c1"># caculate mass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="nd">@mass</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">update</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mass</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
</pre></div>

        </details>

            <div class="docstring"><p>This object holds reservoir specific information.</p>

<pre><code>  Example::

          Reservoir(name = "foo",      # Name of reservoir
                    species = S,          # Species handle
                    delta = 20,           # initial delta - optional (defaults  to 0)
                    mass/concentration = "1 unit"  # species concentration or mass
                    volume/geometry = "1E5 l",      # reservoir volume (m^3)
                    plot = "yes"/"no", defaults to yes
                    plot_transform_c = a function reference, optional (see below)
                    legend_left = str, optional, useful for plot transform
                    display_precision = number, optional, inherited from Model
                    register = optional, use to register with Reservoir Group
                    isotopes = True/False otherwise use Model.m_type
                    seawater_parameters= dict, optional
                    )

  You must either give mass or concentration.  The result will always be displayed
  as concentration though.

  You must provide either the volume or the geometry keyword. In the latter case
  provide a list where the first entry is the upper depth datum, the second entry is
  the lower depth datum, and the third entry is the area percentage. E.g., to specify
  the upper 200 meters of the entire ocean, you would write:

         geometry=[0,-200,1]

  the corresponding ocean volume will then be calculated by the calc_volume method
  in this case the following instance variables will also be set:

         self.volume in model units (usually liter)
         self.are:a surface area in m^2 at the upper bounding surface
         self.area_dz: area of seafloor which is intercepted by this box.
         self.area_fraction: area of seafloor which is intercepted by this
                            relative to the total ocean floor area

  Adding seawater_properties:
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~
  If this optional parameter is specified, a SeaWaterConstants instance will be registered
  for this Reservoir as Reservoir.swc
  See the  SeaWaterConstants class for details how to specify the parameters, e.g.:
  seawater_parameters = {"temperature": 2, "pressure": 240, "salinity" : 35},

  Using a transform function
  ~~~~~~~~~~~~~~~~~~~~~~~~~~

  In some cases, it is useful to transform the reservoir
  concentration data before plotting it.  A good example is the H+
  concentration in water which is better displayed as pH.  We can
  do this by specifying a function to convert the reservoir
  concentration into pH units::

      def phc(c :float) -&gt; float:
          # Calculate concentration as pH. c can be a number or numpy array

          import numpy as np

          pH :float = -np.log10(c)
          return pH

  this function can then be added to a reservoir as::

  hplus.plot_transform_c = phc

  You can modify the left legend to suit the transform via the legend_left keyword

  Note, at present the plot_transform_c function will only take one
  argument, which always defaults to the reservoir
  concentration. The function must return a single argument which
  will be interpreted as the transformed reservoir concentration.
</code></pre>

<p>Accesing Reservoir Data:
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~~</p>

<p>You can access the reservoir data as:</p>

<ul>
<li>Name.m # mass</li>
<li>Name.d # delta</li>
<li>Name.c # concentration</li>
</ul>

<p>Useful methods include:</p>

<ul>
<li>Name.write_data() # save data to file</li>
<li>Name.info()   # info Reservoir</li>
</ul>
</div>


                            <div id="Reservoir.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Reservoir.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Reservoir</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">any</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;parent&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;ideal_water&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;has_cs2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
        <span class="p">]</span>

        <span class="c1"># steps = kwargs[&quot;species&quot;].mo.steps</span>
        <span class="c1"># self.m: np.ndarray =np.zeros(steps) + self.mass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># convert units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">v_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ideal_water</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_water</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">swc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">swc</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
                    <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
                    <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">SeawaterConstants</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="n">pressure</span><span class="o">=</span><span class="n">pressure</span><span class="p">,</span>
                    <span class="n">salinity</span><span class="o">=</span><span class="n">salinity</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">density</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">units</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_concentration</span> <span class="o">=</span> <span class="n">c</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">density</span> <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;concentration&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;mass&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to specify mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="c1"># initialize mass vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># reservoir volume</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a reservoir.</p>
</div>


                            </div>
                            <div id="Reservoir.concentration" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.concentration">#&nbsp;&nbsp</a>

        <span class="name">concentration</span><span class="annotation">: float</span>
    </div>

    
    

                            </div>
                            <div id="Reservoir.delta" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.delta">#&nbsp;&nbsp</a>

        <span class="name">delta</span><span class="annotation">: float</span>
    </div>

    
    

                            </div>
                            <div id="Reservoir.mass" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Reservoir.mass">#&nbsp;&nbsp</a>

        <span class="name">mass</span><span class="annotation">: float</span>
    </div>

    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ReservoirBase">ReservoirBase</a></dt>
                                <dd id="Reservoir.get_process_args" class="function"><a href="#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="Reservoir.info" class="function"><a href="#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Reservoir.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Flux">
                                <div class="attr class">
        <a class="headerlink" href="#Flux">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Flux</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Flux</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class which defines a flux object. Flux objects contain</span>
<span class="sd">    information which links them to an species, describe things like</span>
<span class="sd">    the mass and time unit, and store data of the total flux rate at</span>
<span class="sd">    any given time step. Similarly, they store the flux of the light</span>
<span class="sd">    and heavy isotope flux, as well as the delta of the flux. This</span>
<span class="sd">    is typically handled through the Connect object. If you set it up manually</span>

<span class="sd">    Flux = (name = &quot;Name&quot; # optional, defaults to _F</span>
<span class="sd">            species = species_handle,</span>
<span class="sd">            delta = any number,</span>
<span class="sd">            rate  = &quot;12 mol/s&quot; # must be a string</span>
<span class="sd">            display_precision = number, optional, inherited from Model</span>
<span class="sd">    )</span>

<span class="sd">     You can access the flux data as</span>
<span class="sd">    - Name.m # mass</span>
<span class="sd">    - Name.d # delta</span>
<span class="sd">    - Name.c # concentration</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">AirSeaExchange</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Connect</span><span class="p">,</span>
            <span class="n">Connection</span><span class="p">,</span>
            <span class="n">Signal</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">GasReservoir</span><span class="p">,</span>
                    <span class="n">Connection</span><span class="p">,</span>
                    <span class="n">Connect</span><span class="p">,</span>
                    <span class="n">AirSeaExchange</span><span class="p">,</span>
                    <span class="n">Signal</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="c1"># if save_flux_data is unsepcified, use model default</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">save_flux_data</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="n">fluxrate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fluxrate</span><span class="p">,</span> <span class="n">li</span><span class="p">])</span>

        <span class="c1"># in case we want to keep the flux data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>  <span class="c1"># add the flux</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># setup dummy variables to keep existing numba data structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Connect</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_F&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_F&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="c1"># print(f&quot;f name set to {self.name}. fn =  {self.full_name}\n&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model flux list</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_without_isotopes__</span>

    <span class="c1"># setup a placeholder setitem function</span>
    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get data by index&quot;&quot;&quot;</span>
        <span class="c1"># return self.__get_data__(i)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># what to do when called as a function ()</span>
        <span class="k">pass</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adding two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">fa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;substracting two fluxes works for the masses, but not for delta&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fa</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">fa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot second axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Copy the result of the last computation back to the beginning</span>
<span class="sd">        so that a new run will start with these values.</span>

<span class="sd">        Also, copy current results into temp field</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">])</span>
            <span class="c1"># copy last element to first position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mc</span>
</pre></div>

        </details>

            <div class="docstring"><p>A class which defines a flux object. Flux objects contain
information which links them to an species, describe things like
the mass and time unit, and store data of the total flux rate at
any given time step. Similarly, they store the flux of the light
and heavy isotope flux, as well as the delta of the flux. This
is typically handled through the Connect object. If you set it up manually</p>

<p>Flux = (name = "Name" # optional, defaults to _F
        species = species_handle,
        delta = any number,
        rate  = "12 mol/s" # must be a string
        display_precision = number, optional, inherited from Model
)</p>

<p>You can access the flux data as</p>

<ul>
<li>Name.m # mass</li>
<li>Name.d # delta</li>
<li>Name.c # concentration</li>
</ul>
</div>


                            <div id="Flux.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Flux.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Flux</span><span class="signature">(**kwargs: dict)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a flux. Arguments are the species name the flux rate</span>
<span class="sd">        (mol/year), the delta value and unit</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">AirSeaExchange</span><span class="p">,</span>
            <span class="n">Reservoir</span><span class="p">,</span>
            <span class="n">GasReservoir</span><span class="p">,</span>
            <span class="n">Connect</span><span class="p">,</span>
            <span class="n">Connection</span><span class="p">,</span>
            <span class="n">Signal</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="nb">str</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">GasReservoir</span><span class="p">,</span>
                    <span class="n">Connection</span><span class="p">,</span>
                    <span class="n">Connect</span><span class="p">,</span>
                    <span class="n">AirSeaExchange</span><span class="p">,</span>
                    <span class="n">Signal</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;save_flux_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;rate&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="c1"># if save_flux_data is unsepcified, use model default</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">save_flux_data</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># name of flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># species name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="c1"># model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">tu</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># and convert flux into model units</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">fluxrate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="n">fluxrate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">li</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fluxrate</span><span class="p">,</span> <span class="n">li</span><span class="p">])</span>

        <span class="c1"># in case we want to keep the flux data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_flux_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="n">fluxrate</span>  <span class="c1"># add the flux</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># setup dummy variables to keep existing numba data structures</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># left y-axis a label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ld</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>  <span class="c1"># right y-axis a label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dsa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">dn</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">ds</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xl</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xl</span>  <span class="c1"># se x-axis label equal to model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lpc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of external functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExternalData</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of ext data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Name of reservoir which acts as flux sink</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">Connection</span><span class="p">,</span> <span class="n">Connect</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;_F&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_F&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="c1"># print(f&quot;f name set to {self.name}. fn =  {self.full_name}\n&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model flux list</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="c1"># decide whether we use isotopes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">==</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>
            <span class="c1"># self.__get_data__ = self.__get_without_isotopes__</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a flux. Arguments are the species name the flux rate
(mol/year), the delta value and unit</p>
</div>


                            </div>
                            <div id="Flux.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Flux.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this object</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Data sample:&quot;</span><span class="p">)</span>
        <span class="n">show_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Process(es) acting on this flux:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">off</span><span class="si">}{</span><span class="n">ind</span><span class="si">}{</span><span class="n">p</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Use help on the process name to get an explanation what this process does&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.g., help(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no processes for this flux&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Flux.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SourceSink">
                                <div class="attr class">
        <a class="headerlink" href="#SourceSink">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceSink</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceSink</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup a Source/Sink objects. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">               species = SO4,</span>
<span class="sd">               display_precision = number, optional, inherited from Model</span>
<span class="sd">               delta = number or str. optional defaults to &quot;None&quot;</span>
<span class="sd">           )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">SourceGroup</span><span class="p">,</span>
                    <span class="n">SinkGroup</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">ConnectionGroup</span><span class="p">,</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>
        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add source to list of res type objects</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set/Update delta&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
            <span class="c1"># self.provided_kwargs.update({&quot;delta&quot;: d})</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is a meta class to setup a Source/Sink objects. These are not
actual reservoirs, but we stil need to have them as objects
Example::</p>

<pre><code>   Sink(name = "Pyrite",
       species = SO4,
       display_precision = number, optional, inherited from Model
       delta = number or str. optional defaults to "None"
   )
</code></pre>

<p>where the first argument is a string, and the second is a reservoir handle</p>
</div>


                            <div id="SourceSink.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SourceSink.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SourceSink</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">SourceGroup</span><span class="p">,</span>
                    <span class="n">SinkGroup</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">ConnectionGroup</span><span class="p">,</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>
        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add source to list of res type objects</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="SourceSink.delta" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#SourceSink.delta">#&nbsp;&nbsp</a>

        <span class="name">delta</span>
    </div>

    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="SourceSink.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="SourceSink.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Sink">
                                <div class="attr class">
        <a class="headerlink" href="#Sink">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Sink</span><wbr>(<span class="base"><a href="#SourceSink">SourceSink</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Sink</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Sink object
Example::</p>

<pre><code>   Sink(name = "Pyrite",species =SO4)
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSink">SourceSink</a></dt>
                                <dd id="Sink.__init__" class="function"><a href="#SourceSink.__init__">SourceSink</a></dd>
                <dd id="Sink.delta" class="variable"><a href="#SourceSink.delta">delta</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Sink.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Sink.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Source">
                                <div class="attr class">
        <a class="headerlink" href="#Source">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Source</span><wbr>(<span class="base"><a href="#SourceSink">SourceSink</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">SourceSink</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Source(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Source object
Example::</p>

<pre><code>   Source(name = "SO4_diffusion", species ="SO4")
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSink">SourceSink</a></dt>
                                <dd id="Source.__init__" class="function"><a href="#SourceSink.__init__">SourceSink</a></dd>
                <dd id="Source.delta" class="variable"><a href="#SourceSink.delta">delta</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Source.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Source.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>