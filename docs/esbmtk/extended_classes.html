<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.0.0"/>
    <title>esbmtk.extended_classes API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(:first-of-type){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section:first-of-type details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;esbmtk</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#ReservoirGroup">ReservoirGroup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ReservoirGroup.__init__">ReservoirGroup</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceSink">SourceSink</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SourceSink.__init__">SourceSink</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceSinkGroup">SourceSinkGroup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SourceSinkGroup.__init__">SourceSinkGroup</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SinkGroup">SinkGroup</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#SourceGroup">SourceGroup</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#Signal">Signal</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Signal.__init__">Signal</a>
                        </li>
                        <li>
                                <a class="function" href="#Signal.repeat">repeat</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DataField">DataField</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DataField.__init__">DataField</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Reservoir_no_set">Reservoir_no_set</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Reservoir_no_set.__init__">Reservoir_no_set</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ExternalCode">ExternalCode</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ExternalCode.__init__">ExternalCode</a>
                        </li>
                        <li>
                                <a class="function" href="#ExternalCode.create_alialises">create_alialises</a>
                        </li>
                        <li>
                                <a class="function" href="#ExternalCode.append">append</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#VirtualReservoir_no_set">VirtualReservoir_no_set</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#VirtualReservoir">VirtualReservoir</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#VirtualReservoir.update">update</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#GasReservoir">GasReservoir</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GasReservoir.__init__">GasReservoir</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ExternalData">ExternalData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ExternalData.__init__">ExternalData</a>
                        </li>
                        <li>
                                <a class="function" href="#ExternalData.plot">plot</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a><wbr>.extended_classes    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">import</span> <span class="nn">collections</span> <span class="k">as</span> <span class="nn">col</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">tp</span>

<span class="k">if</span> <span class="n">tp</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Connection</span>

<span class="kn">from</span> <span class="nn">.esbmtk_base</span> <span class="kn">import</span> <span class="n">esbmtkBase</span>
<span class="kn">from</span> <span class="nn">.esbmtk</span> <span class="kn">import</span> <span class="n">ReservoirBase</span><span class="p">,</span> <span class="n">Reservoir</span>

<span class="kn">from</span> <span class="nn">.solver</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_imass</span><span class="p">,</span>
    <span class="n">get_delta</span><span class="p">,</span>
    <span class="n">get_l_mass</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_string_between_brackets</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">ReservoirGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class allows the creation of a group of reservoirs which share</span>
<span class="sd">    a common volume, and potentially connections. E.g., if we have twoy</span>
<span class="sd">    reservoir groups with the same reservoirs, and we connect them</span>
<span class="sd">    with a flux, this flux will apply to all reservoirs in this group.</span>

<span class="sd">    A typical examples might be ocean water which comprises several</span>
<span class="sd">    species.  A reservoir group like ShallowOcean will then contain</span>
<span class="sd">    sub-reservoirs like DIC in the form of ShallowOcean.DIC</span>

<span class="sd">    Example::</span>

<span class="sd">        ReservoirGroup(name = &quot;ShallowOcean&quot;,        # Name of reservoir group</span>
<span class="sd">                    volume/geometry = &quot;1E5 l&quot;,       # see below</span>
<span class="sd">                    delta   = {DIC:0, TA:0, PO4:0]  # dict of delta values</span>
<span class="sd">                    mass/concentration = {DIC:&quot;1 unit&quot;, TA: &quot;1 unit&quot;}</span>
<span class="sd">                    plot = {DIC:&quot;yes&quot;, TA:&quot;yes&quot;}  defaults to yes</span>
<span class="sd">                    isotopes = {DIC: True/False} see Reservoir class for details</span>
<span class="sd">                    seawater_parameter = dict, optional, see below</span>
<span class="sd">                    carbonate_system= False, see below</span>
<span class="sd">               )</span>

<span class="sd">    Notes: - The subreservoirs are derived from the keys in the concentration or mass</span>
<span class="sd">             dictionary. Toward this end, the keys must be valid species handles and</span>
<span class="sd">             -- not species names -- !</span>

<span class="sd">    Connecting two reservoir groups requires that the names in both</span>
<span class="sd">    group match, or that you specify a dictionary which delineates the</span>
<span class="sd">    matching.</span>

<span class="sd">    Most parameters are passed on to the Reservoir class. See the reservoir class</span>
<span class="sd">    documentation for details</span>

<span class="sd">    The geometry keyword specifies the upper depth interval, the lower</span>
<span class="sd">    depth interval, and the fraction of the total ocean area inhabited by the reservoir</span>

<span class="sd">    If the geometry parameter is supplied, the following instance variables will be</span>
<span class="sd">    computed</span>

<span class="sd">                 self.volume: in model units (usually liter)</span>
<span class="sd">                 self.area: surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>


<span class="sd">    carbonate_system:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~</span>

<span class="sd">    If the reservoir group has a DIC and TA reservoir, and if the</span>
<span class="sd">    seawater_parameters key has been supplied as well, this keyword</span>
<span class="sd">    will add a carbonate_chemistry chemistry module to the reservoir</span>
<span class="sd">    group. The values of the carbonate system are available assign</span>

<span class="sd">    self.cs.H</span>
<span class="sd">    self.cs.CA</span>
<span class="sd">    self.cs.HCO3</span>
<span class="sd">    self.cs.CO3</span>
<span class="sd">    self.CO2aq</span>

<span class="sd">    seawater_parameters:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    If this optional parameter is specified, a SeaWaterConstants instance will</span>
<span class="sd">    be registered for this Reservoir as Reservoir.swc</span>
<span class="sd">    See the  SeaWaterConstants class for details how to specify the parameters, e.g.:</span>
<span class="sd">    seawater_parameters = {&quot;temperature&quot;: 2, &quot;pressure&quot;: 240, &quot;salinity&quot; : 35},</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new reservoir group&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ExternalCode</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">Model</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">calc_carbonates_2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;carbonate_system&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;concentration&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_cs1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_cs2</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># reset values, otherwise creation of Reservoir will complain</span>
            <span class="c1"># about volume and geometry being defined</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume must be string or quantity&quot;</span><span class="p">)</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="c1"># if self.mo.register == &quot;local&quot; and self.register == &quot;None&quot;:</span>
        <span class="c1">#     self.register = self.mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># register a seawater_parameter instance if necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
            <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">SeawaterConstants</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">pressure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span>
                <span class="n">salinity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">salinity</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># dict with all default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># now we loop trough all keys for this reservoir and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># kcd  = delta, plot, etc</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry delta</span>
                    <span class="c1"># test if delta relates to any species</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry with the value provided in kwargs</span>
                        <span class="c1"># self.cd[&#39;SO4_name&#39;][&#39;delta&#39;] = self.kwargs[&#39;delta&#39;][SO4]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of reservoirs in this group.</span>
        <span class="c1"># loop over all entries in species and create the respective reservoirs</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="c1"># create reservoir without registering it in the global name space</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
                <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;isotopes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># register as part of this group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># setup the carbonate system</span>

        <span class="c1"># depreceated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbonate_system</span><span class="p">:</span>
            <span class="c1"># do some sanity checks:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;swc&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no seawaterconstants instance&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no DIC reservoir&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no TA reservoir&quot;</span><span class="p">)</span>

            <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">CO2</span><span class="p">,</span>
                <span class="n">alias_list</span><span class="o">=</span><span class="s2">&quot;H CA HCO3 CO3 CO2aq omega zsat&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>
                        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># omega</span>
                        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># zsat</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_2</span><span class="p">,</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">]),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 7</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 8</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">zsat0</span><span class="p">,</span>  <span class="c1"># zsat0 after Boudreau 2010</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">SourceSink</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup a Source/Sink objects. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">               species = SO4,</span>
<span class="sd">               display_precision = number, optional, inherited from Model</span>
<span class="sd">               delta = number or str. optional defaults to &quot;None&quot;</span>
<span class="sd">           )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SourceSinkGroup</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SourceSinkGroup</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># if self.register == &quot;None&quot;:</span>
        <span class="c1">#     self.pt = self.name</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.pt: str = f&quot;{self.register.name}_{self.n}&quot;</span>
        <span class="c1">#     self.groupname = self.register.name</span>

        <span class="c1"># if self.delta != &quot;None&quot;:</span>
        <span class="c1">#     self.isotopes = True</span>

        <span class="c1"># if self.display_precision == 0:</span>
        <span class="c1">#     self.display_precision = self.mo.display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SourceSinkGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup  Source/Sink Groups. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">                species = [SO42, H2S],</span>
<span class="sd">                delta = {&quot;SO4&quot;: 10}</span>
<span class="sd">                )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(),</span> <span class="p">(</span><span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># register this object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># get model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of sub reservoirs in this group</span>

        <span class="c1"># loop over species names and setup sub-objects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SourceGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SinkGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a valid class type&quot;</span><span class="p">)</span>

            <span class="c1"># register in local namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SinkGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">SourceGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Signal</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class will create a signal which is</span>
<span class="sd">    described by its startime (relative to the model time), it&#39;s</span>
<span class="sd">    size (as mass) and duration, or as duration and</span>
<span class="sd">    magnitude. Furthermore, we can presribe the signal shape</span>
<span class="sd">    (square, pyramid) and whether the signal will repeat. You</span>
<span class="sd">    can also specify whether the event will affect the delta value.</span>

<span class="sd">    The data in the signal class will simply be added to the data in</span>
<span class="sd">    a given flux. So this class cannot be used for scaling (can we</span>
<span class="sd">    add this functionality?)</span>

<span class="sd">    Example::</span>

<span class="sd">          Signal(name = &quot;Name&quot;,</span>
<span class="sd">                 species = Species handle,</span>
<span class="sd">                 start = &quot;0 yrs&quot;,     # optional</span>
<span class="sd">                 duration = &quot;0 yrs&quot;,  #</span>
<span class="sd">                 delta = 0,           # optional</span>
<span class="sd">                 stype = &quot;addition&quot;   # optional, currently the only type</span>
<span class="sd">                 shape = &quot;square/pyramid/bell/filename&quot;</span>
<span class="sd">                 mass/magnitude/filename  # give one</span>
<span class="sd">                 offset = &#39;0 yrs&#39;,     #</span>
<span class="sd">                 scale = 1, optional,  #</span>
<span class="sd">                 offset = option #</span>
<span class="sd">                 reservoir = r-handle # optional, see below</span>
<span class="sd">                 source = s-handle optional, see below</span>
<span class="sd">                 display_precision = number, optional, inherited from Model</span>
<span class="sd">                 register,</span>
<span class="sd">                )</span>

<span class="sd">    Signals are cumulative, i.e., complex signals ar created by</span>
<span class="sd">    adding one signal to another (i.e., Snew = S1 + S2)</span>

<span class="sd">    The optional scaling argument will only affect the y-column data of</span>
<span class="sd">    external data files</span>

<span class="sd">    Signals are registered with a flux during flux creation,</span>
<span class="sd">    i.e., they are passed on the process list when calling the</span>
<span class="sd">    connector object.</span>

<span class="sd">    if the filename argument is used, you can provide a filename which</span>
<span class="sd">    contains the data to be used in csv format. The data will be</span>
<span class="sd">    interpolated to the model domain, and added to the already existing data.</span>
<span class="sd">    The external data need to be in the following format</span>

<span class="sd">      Time, Rate, delta value</span>
<span class="sd">      0,     10,   12</span>

<span class="sd">      i.e., the first row needs to be a header line</span>

<span class="sd">    All time data in the csv file will be treated as realative time</span>
<span class="sd">    (i.e., the start time will be mapped to zero). Use the offset</span>
<span class="sd">    keyword to shift the external signal data in the time domain.</span>

<span class="sd">    Last but not least, you can provide an optional reservoir name. In</span>
<span class="sd">    this case, the signal will create a source as (signal_name_source)</span>
<span class="sd">    and the connection to the specified reservoir. If you build a</span>
<span class="sd">    complex signal do this as the last step. If you additionally</span>
<span class="sd">    provide a source name the connection will be made between the</span>
<span class="sd">    provided source (this can be useful if you use source groups).</span>


<span class="sd">    This class has the following methods</span>

<span class="sd">      Signal.repeat()</span>
<span class="sd">      Signal.plot()</span>
<span class="sd">      Signal.info()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse and initialize variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># provide a list of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1 yr&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;addition&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;legend_right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># list of signals we are based on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert units to model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># start time</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">   W A R N I N G </span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your signal duration is covered by less than 10&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intergration steps. This may not be what you want</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># legacy name definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># the name of the this signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># the species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stype</span>  <span class="c1"># type of signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># shape the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># delta value offset during the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>  <span class="c1"># list of keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_signal_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>  <span class="c1"># update the name of the signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_right</span>
        <span class="c1"># update isotope values</span>
        <span class="c1"># self.data.li = get_l_mass(self.data.m, self.data.d, self.sp.r)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model</span>

        <span class="c1"># in case we deal with a sink or source signal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_signal__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init_signal_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;1. Create a vector which contains the signal data. The vector length</span>
<span class="sd">           can exceed the modelling domain.</span>
<span class="sd">        2. Trim the signal vector in such a way that it fits within the</span>
<span class="sd">           modelling domain</span>
<span class="sd">        3. Create an empty flux and replace it with the signal vector data.</span>

<span class="sd">        Note that this flux will then be added to an existing flux.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span>

        <span class="c1"># these are signal times, not model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>

        <span class="c1"># create signal vector</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;square&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__square__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;pyramid&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pyramid__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;bell&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__bell__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># use an external data set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__int_ext_data__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;argument needs to be either square/pyramid, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or an ExternalData object. &quot;</span>
            <span class="p">)</span>

        <span class="c1"># create a dummy flux we can act up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
            <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">save_flux_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># remove signal fluxes from global flux list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>

        <span class="c1"># map into model space</span>
        <span class="n">insert_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span>
        <span class="n">insert_stop_time</span> <span class="o">=</span> <span class="n">insert_start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>

        <span class="n">dt1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="n">dt2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>

        <span class="n">model_start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insert_start_time</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">model_stop_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="n">dt2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">))</span>
        <span class="n">signal_start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">signal_stop_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt2</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;dt1 = </span><span class="si">{</span><span class="n">dt1</span><span class="si">}</span><span class="s2">, dt2 = </span><span class="si">{</span><span class="n">dt2</span><span class="si">}</span><span class="s2">, offset = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;insert start time = </span><span class="si">{</span><span class="n">insert_start_time</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;insert_stop time = </span><span class="si">{</span><span class="n">insert_stop_time</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;duration = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;msi = </span><span class="si">{</span><span class="n">model_start_index</span><span class="si">}</span><span class="s2">, msp = </span><span class="si">{</span><span class="n">model_stop_index</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model num_steps = </span><span class="si">{</span><span class="n">model_stop_index</span><span class="o">-</span><span class="n">model_start_index</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ssi = </span><span class="si">{</span><span class="n">signal_start_index</span><span class="si">}</span><span class="s2">, ssp = </span><span class="si">{</span><span class="n">signal_stop_index</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;signal num_steps = </span><span class="si">{</span><span class="n">signal_stop_index</span><span class="o">-</span><span class="n">signal_start_index</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">signal_start_index</span> <span class="o">&lt;</span> <span class="n">signal_stop_index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">model_start_index</span><span class="p">:</span><span class="n">model_stop_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">[</span>
                <span class="n">signal_start_index</span><span class="p">:</span><span class="n">signal_stop_index</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">model_start_index</span><span class="p">:</span><span class="n">model_stop_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span><span class="p">[</span>
                <span class="n">signal_start_index</span><span class="p">:</span><span class="n">signal_stop_index</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>

    <span class="k">def</span> <span class="nf">__square__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create Square Signal&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the square</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">h</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">+</span> <span class="n">h</span>  <span class="c1"># add this to the section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># add the delta offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__pyramid__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create pyramid type Signal</span>

<span class="sd">        s = start index</span>
<span class="sd">        e = end index</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the pyramid</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="c1"># create pyramid</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># get the center index for the peak</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">])</span>  <span class="c1"># setup the x coordinates</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the y coordinates</span>

        <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the d coordinates</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># setup the points at which to interpolate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># interpolate delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bell__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a bell curve type signal</span>

<span class="sd">        s = start index</span>
<span class="sd">        e = end index</span>

<span class="sd">        Note that the area under the curve equals one.</span>
<span class="sd">        So we can scale the result simply with mass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># get the center index for the peak</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">e</span>
        <span class="n">pi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mu = </span><span class="si">{</span><span class="n">mu</span><span class="si">}</span><span class="s2"> ,phi = </span><span class="si">{</span><span class="n">phi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x[0] = </span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, x[-1] = </span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># get bell curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">e</span><span class="o">**</span><span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bell type signal require either mass or magnitude&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__int_ext_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate External data as a signal. Unlike the other signals,</span>
<span class="sd">        this will replace the values in the flux with those read from the</span>
<span class="sd">        external data source. The external data need to be in the following format</span>

<span class="sd">        Time [units], Rate [units], delta value [units]</span>
<span class="sd">        0,     10,   12</span>

<span class="sd">        i.e., the first row needs to be a header line</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># read external dataset</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># create the associated quantities</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>

        <span class="c1"># add these to the data we are are reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
        <span class="k">if</span> <span class="n">zh</span><span class="p">:</span>
            <span class="c1"># delta is assumed to be without units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_delta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># map into model units, and strip unit information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">et</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># end time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">et</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">)))</span>
        <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="c1"># setup the points at which to interpolate</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">et</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span>
        <span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="k">if</span> <span class="n">zh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_delta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__apply_signal__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;In case we deal with a source  signal, we need</span>
<span class="sd">        to create a source, and connect signal, source and reservoir</span>
<span class="sd">        Maybe this logic should be me moved elsewhere?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Connect</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_Source&quot;</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="n">Connect</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>  <span class="c1"># source of flux</span>
            <span class="n">sink</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span>  <span class="c1"># target of flux</span>
            <span class="n">rate</span><span class="o">=</span><span class="s2">&quot;0 mol/yr&quot;</span><span class="p">,</span>  <span class="c1"># flux rate</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># list of processes</span>
            <span class="n">plot</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;allow the addition of two signals and return a new signal&quot;&quot;&quot;</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># add the data of both fluxes</span>
        <span class="c1"># get delta of self</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">sd</span> <span class="o">+</span> <span class="n">od</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, returning </span><span class="si">{</span><span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">st</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;compound&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method creates a new signal by repeating an existing signal.</span>
<span class="sd">        Example::</span>

<span class="sd">        new_signal = signal.repeat(start,   # start time of signal slice to be repeated</span>
<span class="sd">                                   stop,    # end time of signal slice to be repeated</span>
<span class="sd">                                   offset,  # offset between repetitions</span>
<span class="sd">                                   times,   # number of time to repeat the slice</span>
<span class="sd">                              )</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ns</span><span class="p">:</span> <span class="n">Signal</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times_data&quot;</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># convert from time to index</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">times</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>  <span class="c1"># get the data slice we are using</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>  <span class="c1"># end index larger than data size</span>
                <span class="n">diff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># difference</span>
                <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">diff</span>  <span class="c1"># new end index</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>

            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>

        <span class="c1"># and recalculate li and hi</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">__register_with_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this signal with a flux. This should probably be done</span>
<span class="sd">        through a process!</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Species</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">flux</span>  <span class="c1"># the flux handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># the species handle</span>
        <span class="c1"># list of processes</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return Signal value at time t (mass and mass for light</span>
<span class="sd">        isotope). This will work as long a t is a multiple of dt, and i = t.</span>
<span class="sd">        may extend this by addding linear interpolation but that will</span>
<span class="sd">        be costly</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># # test for plt_transform</span>
        <span class="c1"># if self.plot_transform_c != &quot;None&quot;:</span>
        <span class="c1">#     if callable(self.plot_transform_c):</span>
        <span class="c1">#         y1 = self.plot_transform_c(self.c)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         raise ValueError(&quot;Plot transform must be a function&quot;)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot second axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DataField</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataField: Datafields can be used to plot data which is computed after</span>
<span class="sd">    the model finishes in the overview plot windows. Therefore, datafields will</span>
<span class="sd">    plot in the same window as the reservoir they are associated with.</span>
<span class="sd">    Datafields must share the same x-axis is the model, and can have up to two</span>
<span class="sd">    y axis.</span>

<span class="sd">    Example::</span>

<span class="sd">             DataField(name = &quot;Name&quot;</span>
<span class="sd">                       register = Model handle,</span>
<span class="sd">                       y1_data = np.Ndarray or list of arrays</span>
<span class="sd">                       y1_label = Y-Axis label</span>
<span class="sd">                       y1_legend = Data legend or list of legends</span>
<span class="sd">                       y2_data = np.Ndarray    # optional</span>
<span class="sd">                       y2_label = Y-Axis label # optional</span>
<span class="sd">                       y2_legend = Data legend # optional</span>
<span class="sd">                       common_y_scale = &quot;no&quot;,  #optional, default &quot;no&quot;</span>
<span class="sd">                       display_precision = number, optional, inherited from Model</span>
<span class="sd">                       )</span>

<span class="sd">    Note that Datafield data is not mapped to model units. Care must be taken</span>
<span class="sd">    that the data units match the model units.</span>

<span class="sd">    The instance provides the following data</span>

<span class="sd">    Name.x    = X-axis = model X-axis</span>
<span class="sd">    Name.y1_data</span>
<span class="sd">    Name.y1_label</span>
<span class="sd">    Name.y1_legend</span>

<span class="sd">    Similarly for y2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this instance&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Reservoir_no_set</span><span class="p">,</span> <span class="n">VirtualReservoir</span><span class="p">,</span> <span class="n">ExternalCode</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">Reservoir_no_set</span><span class="p">,</span>
                    <span class="n">VirtualReservoir</span><span class="p">,</span>
                    <span class="n">ExternalCode</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">Reservoir_no_set</span><span class="p">,</span>
                    <span class="n">VirtualReservoir</span><span class="p">,</span>
                    <span class="n">ExternalCode</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;x1_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;x2_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;associated_with&quot;</span><span class="p">],</span> <span class="s2">&quot;y1_data&quot;</span><span class="p">]</span>

        <span class="c1"># provide a dictionary entry for a keyword specific error message</span>
        <span class="c1"># see esbmtkBase.__initerrormessages__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span>

        <span class="c1"># set legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="c1"># if self.associated_with == &quot;None&quot;:</span>
        <span class="c1">#     self.associated_with = self.mo.lor[0]</span>

        <span class="c1"># self.mo = self.associated_with.mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">plt_units</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plt_units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This needs fixing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;self.y2_data&quot;</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">]</span>

        <span class="c1"># if no x data provided, match with model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">]</span>

        <span class="c1"># register with reservoir</span>
        <span class="c1"># self.associated_with.ldf.append(self)</span>
        <span class="c1"># register with model. needed for print_reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, you are initializing a datafield before the model results are known</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># some short hands</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y1 data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y2_data</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">last_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1"># add any external data if present</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="c1"># yd = (d.y * M.c_unit).to(self.plt_units).magnitude</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">last_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>

        <span class="n">last_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="p">)</span>
        <span class="c1"># remove unnecessary frame species</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;doing twinx for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">last_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="n">axt</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span><span class="p">)</span>
            <span class="c1"># remove unnecessary frame species</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
            <span class="c1"># axt.legend()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Reservoir_no_set</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is similar to a regular reservoir, but we make no</span>
<span class="sd">    assumptions about the type of data contained. I.e., all data will be</span>
<span class="sd">    left alone</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The original class will calculate delta and concentration from mass</span>
<span class="sd">        an d and h and l. Since we want to use this class without a</span>
<span class="sd">        priory knowledge of how the reservoir arrays are being used we</span>
<span class="sd">        overwrite the data generated during initialization with the</span>
<span class="sd">        values provided in the keywords</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;vr_datafields&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">(</span><span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;function_input_data&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">List</span><span class="p">(),</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;alias_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
        <span class="c1"># save the unit which was provided by the user for display purposes</span>

        <span class="c1"># ------------------------------------------</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="c1"># self.mo.lor.remove(self)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>

        <span class="c1"># this should be done in aux-inits of a derived class if necessary</span>
        <span class="c1"># self.mo.lvr.append(self)</span>
        <span class="c1"># print(f&quot;added {self.name} to lvr 1&quot;)</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">class</span> <span class="nc">ExternalCode</span><span class="p">(</span><span class="n">Reservoir_no_set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class can be used to implement user provided functions. The</span>
<span class="sd">    data inside a VR_no_set instance will only change in response to a</span>
<span class="sd">    user provided function but will otherwise remain unaffected. That is,</span>
<span class="sd">    it is up to the user provided function to manage changes in reponse to</span>
<span class="sd">    external fluxes. A VR_no_set is declared in the following way</span>

<span class="sd">        ExternalCode(</span>
<span class="sd">                    name=&quot;cs&quot;,     # instance name</span>
<span class="sd">                    species=CO2,   # species, must be given</span>
<span class="sd">                    # The next line defines the number of datafields and their default values</span>

<span class="sd">                    data which will be computed by this function</span>
<span class="sd">                    provide alias name and default value</span>
<span class="sd">                    vr_datafields :dict ={&quot;Hplus&quot;: self.swc.hplus,</span>
<span class="sd">                                          &quot;Beta&quot;: 0.0},</span>

<span class="sd">                    function=calc_carbonates, # function reference, see below</span>
<span class="sd">                    # A numba types List of one ore more np.arrays which are used</span>
<span class="sd">                    # as input values for the user provided function</span>
<span class="sd">                    function_input_data=List([self.DIC.c, self.TA.c]),</span>

<span class="sd">                    # A numba types List of float parameters.</span>
<span class="sd">                    alias_list = [&quot;H&quot;, &quot;CA&quot;, &quot;HCO3&quot;, &quot;CO3&quot;, &quot;CO2aq&quot;]</span>
<span class="sd">                    # Note that parameters must be individual float values</span>
<span class="sd">                    function_params=List(</span>
<span class="sd">                        [</span>
<span class="sd">                            self.swc.K1,</span>
<span class="sd">                            self.swc.K2,</span>
<span class="sd">                            self.swc.KW,</span>
<span class="sd">                            self.swc.KB,</span>
<span class="sd">                            self.swc.boron,</span>
<span class="sd">                            self.swc.hplus,</span>
<span class="sd">                        ]</span>
<span class="sd">                    ),</span>
<span class="sd">                    register=rh # reservoir_handle to register with.</span>

<span class="sd">                )</span>

<span class="sd">        the dict keys of vr_datafields will be used to create alias</span>
<span class="sd">        names which can be used to access the respective variable</span>


<span class="sd">    The general template for a user defined function is a follows:</span>

<span class="sd">    # @njit Add the njit decorator if you plan to use the numba solver</span>
<span class="sd">    def calc_carbonates(i: int, input_data: List, vr_data: List, params: List) -&gt; None:</span>
<span class="sd">        # i = index of current timestep</span>
<span class="sd">        # input_data = List of np.arrays, typically data from other Reservoirs</span>
<span class="sd">        # vr_data = List of np.arrays created during instance creation (i.e. the vr data)</span>
<span class="sd">        # params = List of float values (at least one!)</span>

<span class="sd">        pass</span>

<span class="sd">    return</span>

<span class="sd">    Note that this function should not return any values, and that all input fields must have</span>
<span class="sd">    at least one entry!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The original class will calculate delta and concentration from mass</span>
<span class="sd">        an d and h and l. Since we want to use this class without a</span>
<span class="sd">        priory knowledge of how the reservoir arrays are being used we</span>
<span class="sd">        overwrite the data generated during initialization with the</span>
<span class="sd">        values provided in the keywords</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">GenericFunction</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;vr_datafields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_input_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;alias_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;return_values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;r_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
            <span class="s2">&quot;r_d&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># initialize data fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
            <span class="n">r_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r_s</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_input_data</span><span class="p">,</span>
            <span class="n">vr_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span>
            <span class="n">function_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span>
            <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ftype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># add the function handle to the list of function to be executed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lpc_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># print(f&quot;added {self.name} to lvr 2&quot;)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_alialises</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register  alialises for each vr_datafield&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span><span class="p">):</span>
            <span class="c1"># print(f&quot;{a} = {self.vr_data[i][0]}&quot;)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">        VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">        when parameters have to reference other virtual reservoirs</span>
<span class="sd">        which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">        a circular reference.</span>

<span class="sd">        Example::</span>

<span class="sd">        VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;function_input_data, function_params&quot;</span><span class="p">]</span>
        <span class="c1"># loop over provided kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;you can only change function_input_data, or function_params&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy the last value to the first position so that we can restart the computation&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">]),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;merging {self.full_name} with whith len of vrd= {len(self.vrd_0)}&quot;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># update aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>
        <span class="c1"># print(f&quot;new length = {len(self.vr_data[0])}&quot;)</span>

    <span class="k">def</span> <span class="nf">__read_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read virtual reservoir data from csv-file into a dataframe</span>

<span class="sd">        The CSV file must have the following columns</span>

<span class="sd">        Model Time     t</span>
<span class="sd">        X1</span>
<span class="sd">        X2</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_vr_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading state for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># read csv file into dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>
        <span class="c1"># print(f&quot;reading from {fn}&quot;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">headers</span><span class="p">):</span>
            <span class="c1"># first column is time</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># print(f&quot;i = {i}, header = {n}, data = {df.iloc[-3:, i]}&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;subsampling {self.fullname}&quot;)</span>

        <span class="n">new</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span> <span class="o">=</span> <span class="n">new</span>
        <span class="c1"># update aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_vr_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;X</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">df</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>


<span class="k">class</span> <span class="nc">VirtualReservoir_no_set</span><span class="p">(</span><span class="n">ExternalCode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias to ensure backwards compatibility&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">VirtualReservoir</span><span class="p">(</span><span class="n">Reservoir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A virtual reservoir. Unlike regular reservoirs, the mass of a</span>
<span class="sd">    virtual reservoir depends entirely on the return value of a function.</span>

<span class="sd">    Example::</span>

<span class="sd">    VirtualReservoir(name=&quot;foo&quot;,</span>
<span class="sd">                    volume=&quot;10 liter&quot;,</span>
<span class="sd">                    concentration=&quot;1 mmol&quot;,</span>
<span class="sd">                    species=  ,</span>
<span class="sd">                    function=bar,</span>
<span class="sd">                    a1 to a3 =  to 3optional function arguments,</span>
<span class="sd">                    display_precision = number, optional, inherited from Model,</span>
<span class="sd">                    )</span>

<span class="sd">    the concentration argument will be used to initialize the reservoir and</span>
<span class="sd">    to determine the display units.</span>

<span class="sd">    The function definition follows the GenericFunction class.</span>
<span class="sd">    which takes a generic function and up to 6 optional</span>
<span class="sd">    function arguments, and will replace the mass value(s) of the</span>
<span class="sd">    given reservoirs with whatever the function calculates. This is</span>
<span class="sd">    particularly useful e.g., to calculate the pH of a given reservoir</span>
<span class="sd">    as function of e.g., Alkalinity and DIC.</span>
<span class="sd">    Parameters:</span>
<span class="sd">     - name = name of process,</span>
<span class="sd">     - act_on = name of a reservoir this process will act upon</span>
<span class="sd">     - function  = a function reference</span>
<span class="sd">     - a1 to a3 function arguments</span>

<span class="sd">    In order to be compatible with the numba solver, a1 and a2 must be</span>
<span class="sd">    an array of 1-D numpy.arrays i.e., [m, l, h, c]. The array can have</span>
<span class="sd">    any number of arrays though. a3 must be single array (or list).</span>
<span class="sd">    The a3 array must be passed as List([...]), and List must be imported as</span>

<span class="sd">    from numba.typed import List</span>


<span class="sd">    The function must return a list of numbers which correspond to the</span>
<span class="sd">    data which describe a reservoir i.e., mass, light isotope, heavy</span>
<span class="sd">    isotope, delta, and concentration</span>

<span class="sd">    In order to use this function we need first declare a function we plan to</span>
<span class="sd">    use with the generic function process. This function needs to follow this</span>
<span class="sd">    template::</span>

<span class="sd">        def my_func(i, a1, a2, a3) -&gt; tuple:</span>
<span class="sd">            #</span>
<span class="sd">            # i = index of the current timestep</span>
<span class="sd">            # a1 to a3 =  optional function parameter. These must be present,</span>
<span class="sd">            # even if your function will not use it See above for details</span>

<span class="sd">            # calc some stuff and return it as</span>

<span class="sd">            return [m, l, h, d, c] # where m= mass, and l &amp; h are the respective</span>
<span class="sd">                                   # isotopes. d denotes the delta value and</span>
<span class="sd">                                   # c the concentration</span>
<span class="sd">                                   # Use dummy value as necessary.</span>

<span class="sd">    This class provides an update method to resolve cases where e.g., two virtual</span>
<span class="sd">    reservoirs have a circular reference. See the documentation of update().</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__aux_inits__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;We us the regular init methods of the Reservoir Class, and extend it in this method&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="n">GenericFunction</span>

        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.full_name}.{self.name}&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">a1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span>
            <span class="n">a2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span>
            <span class="n">a3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a3</span><span class="p">,</span>
            <span class="n">a4</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a4</span><span class="p">,</span>
            <span class="n">act_on</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># we only depend on the above function. so no need</span>
        <span class="c1"># to be in the reservoir list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># print(f&quot;added {self.name} to lvr 2&quot;)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">        VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">        when parameters have to reference other virtual reservoirs</span>
<span class="sd">        which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">        a circular reference.</span>

<span class="sd">        Example::</span>

<span class="sd">        VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;a4&quot;</span><span class="p">,</span> <span class="s2">&quot;a5&quot;</span><span class="p">,</span> <span class="s2">&quot;a6&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span>
        <span class="c1"># loop over provided kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can only change a1 to a6&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update self</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update function</span>


<span class="k">class</span> <span class="nc">GasReservoir</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information similar to the Reservoir class</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,     # Name of reservoir</span>
<span class="sd">                            species = CO2,    # Species handle</span>
<span class="sd">                            delta = 20,       # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            reservoir_mass = quantity # total mass of all gases</span>
<span class="sd">                                             defaults to 1.833E20 mol</span>
<span class="sd">                            species_ppm =  number # concentration in ppm</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            )</span>



<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # species mass</span>
<span class="sd">    - Name.l # mass of light isotope</span>
<span class="sd">    - Name.d # species delta (only avaible after M.get_delta_values()</span>
<span class="sd">    - Name.c # partial pressure</span>
<span class="sd">    - Name.v # total gas mass</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir_mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1.833E20 mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;species_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species_ppm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># setup base data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">)</span>

        <span class="c1"># not sure this universally true but it works for carbon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_mass</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;mol&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>

        <span class="c1"># we use the existing approach to calculate concentration</span>
        <span class="c1"># which will divide species_mass/volume.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1">#    Q_(self.species_mass).magnitude / self.species_ppm.to(&quot;dimensionless&quot;)</span>
        <span class="c1"># ).magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>  <span class="c1"># massunit xxxx</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># initialize vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_mass</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="c1"># initialize concentration vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
        <span class="c1"># isotope mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="c1"># delta of reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># mass of atmosphere</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add fthis reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># self.v[i]: float = self.v[i - 1] + value[0]</span>
        <span class="c1"># self.c[i]: float = self.m[i] / self.v[i]  # update concentration</span>
        <span class="c1"># self.h[i]: float = value[2]</span>
        <span class="c1"># self.d[i]: float = get_delta(self.l[i], self.h[i], self.sp.r)</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># self.c[i]: float = self.m[i] / self.v[i]  # update concentration</span>
        <span class="c1"># self.v[i]: float = self.v[i - 1] + value[0]</span>


<span class="k">class</span> <span class="nc">ExternalData</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instances of this class hold external X/Y data which can be associated with</span>
<span class="sd">    a reservoir.</span>

<span class="sd">    Example::</span>

<span class="sd">           ExternalData(name       = &quot;Name&quot;</span>
<span class="sd">                        filename   = &quot;filename&quot;,</span>
<span class="sd">                        legend     = &quot;label&quot;,</span>
<span class="sd">                        offset     = &quot;0 yrs&quot;,</span>
<span class="sd">                        reservoir  = reservoir_handle,</span>
<span class="sd">                        scale      = scaling factor, optional</span>
<span class="sd">                        display_precision = number, optional, inherited from Model</span>
<span class="sd">                        convert_to = optional, see below</span>
<span class="sd">                       )</span>

<span class="sd">    The data must exist as CSV file, where the first column contains</span>
<span class="sd">    the X-values, and the second column contains the Y-values.</span>

<span class="sd">    The x-values must be time and specify the time units in the header between square brackets</span>
<span class="sd">    They will be mapped into the model time units.</span>

<span class="sd">    The y-values can be any data, but the user must take care that they match the model units</span>
<span class="sd">    defined in the model instance. So your data file mujst look like this</span>

<span class="sd">    Time [years], Data [units], Data [units]</span>
<span class="sd">    1, 12</span>
<span class="sd">    2, 13</span>

<span class="sd">    By convention, the secon column should contaain the same type of</span>
<span class="sd">    data as the reservoir (i.e., a concentration), whereas the third</span>
<span class="sd">    column contain isotope delta values. Columns with no data should</span>
<span class="sd">    be left empty (and have no header!) The optional scale argument, will</span>
<span class="sd">    only affect the Y-col data, not the isotope data</span>

<span class="sd">    The column headers are only used for the time or concentration</span>
<span class="sd">    data conversion, and are ignored by the default plotting</span>
<span class="sd">    methods, but they are available as self.xh,yh</span>

<span class="sd">    The file must exist in the local working directory.</span>

<span class="sd">    the convert_to keyword can be used to force a specific conversion.</span>
<span class="sd">    The default is to convert into the model concentration units.</span>

<span class="sd">    Methods:</span>
<span class="sd">      - name.plot()</span>

<span class="sd">    Data:</span>
<span class="sd">      - name.x</span>
<span class="sd">      - name.y</span>
<span class="sd">      - name.df = dataframe as read from csv file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span><span class="p">)],</span>
            <span class="s2">&quot;convert_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># string =  name of this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="c1"># string = filename of data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># keep track of this instance</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># read file</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># test of we have 3 columns</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSV file must have 3 columns&quot;</span><span class="p">)</span>

        <span class="c1"># print(f&quot;Model = {self.mo.full_name}, t_unit = {self.mo.t_unit}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># get unit information</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">get_string_between_brackets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">get_string_between_brackets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">yq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yq = </span><span class="si">{</span><span class="n">yq</span><span class="si">}</span><span class="s2">, cvt= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span><span class="si">}</span><span class="s2">, ys = </span><span class="si">{</span><span class="n">ys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># scale input data into model  units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">ys</span>

        <span class="c1"># map into model space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># check if z-data is present</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># zh = self.df.columns[2]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this dataset with a flux or reservoir. This will have the</span>
<span class="sd">        effect that the data will be printed together with the model</span>
<span class="sd">        results for this reservoir</span>

<span class="sd">        Example::</span>

<span class="sd">        ExternalData.register(Reservoir)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>  <span class="c1"># reser handle we associate with</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__interpolate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate the input data with a resolution of dt across the model</span>
<span class="sd">        domain The first and last data point must coincide with the</span>
<span class="sd">        model start and end time. In other words, this method will not</span>
<span class="sd">        patch data at the end points.</span>

<span class="sd">        This will replace the original values of name.x and name.y. However</span>
<span class="sd">        the original data remains accessible as name.df</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">time</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Interpolation requires that the time domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is equal or greater than the model domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data t(0) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model t(0) = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xi</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the data and save a pdf</span>

<span class="sd">        Example::</span>

<span class="sd">                ExternalData.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yh</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            </section>
                <section id="ReservoirGroup">
                                <div class="attr class">
        <a class="headerlink" href="#ReservoirGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ReservoirGroup</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ReservoirGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class allows the creation of a group of reservoirs which share</span>
<span class="sd">    a common volume, and potentially connections. E.g., if we have twoy</span>
<span class="sd">    reservoir groups with the same reservoirs, and we connect them</span>
<span class="sd">    with a flux, this flux will apply to all reservoirs in this group.</span>

<span class="sd">    A typical examples might be ocean water which comprises several</span>
<span class="sd">    species.  A reservoir group like ShallowOcean will then contain</span>
<span class="sd">    sub-reservoirs like DIC in the form of ShallowOcean.DIC</span>

<span class="sd">    Example::</span>

<span class="sd">        ReservoirGroup(name = &quot;ShallowOcean&quot;,        # Name of reservoir group</span>
<span class="sd">                    volume/geometry = &quot;1E5 l&quot;,       # see below</span>
<span class="sd">                    delta   = {DIC:0, TA:0, PO4:0]  # dict of delta values</span>
<span class="sd">                    mass/concentration = {DIC:&quot;1 unit&quot;, TA: &quot;1 unit&quot;}</span>
<span class="sd">                    plot = {DIC:&quot;yes&quot;, TA:&quot;yes&quot;}  defaults to yes</span>
<span class="sd">                    isotopes = {DIC: True/False} see Reservoir class for details</span>
<span class="sd">                    seawater_parameter = dict, optional, see below</span>
<span class="sd">                    carbonate_system= False, see below</span>
<span class="sd">               )</span>

<span class="sd">    Notes: - The subreservoirs are derived from the keys in the concentration or mass</span>
<span class="sd">             dictionary. Toward this end, the keys must be valid species handles and</span>
<span class="sd">             -- not species names -- !</span>

<span class="sd">    Connecting two reservoir groups requires that the names in both</span>
<span class="sd">    group match, or that you specify a dictionary which delineates the</span>
<span class="sd">    matching.</span>

<span class="sd">    Most parameters are passed on to the Reservoir class. See the reservoir class</span>
<span class="sd">    documentation for details</span>

<span class="sd">    The geometry keyword specifies the upper depth interval, the lower</span>
<span class="sd">    depth interval, and the fraction of the total ocean area inhabited by the reservoir</span>

<span class="sd">    If the geometry parameter is supplied, the following instance variables will be</span>
<span class="sd">    computed</span>

<span class="sd">                 self.volume: in model units (usually liter)</span>
<span class="sd">                 self.area: surface area in m^2 at the upper bounding surface</span>
<span class="sd">                 self.area_dz: area of seafloor which is intercepted by this box.</span>
<span class="sd">                 self.area_fraction: area of seafloor which is intercepted by this</span>
<span class="sd">                                    relative to the total ocean floor area</span>


<span class="sd">    carbonate_system:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~</span>

<span class="sd">    If the reservoir group has a DIC and TA reservoir, and if the</span>
<span class="sd">    seawater_parameters key has been supplied as well, this keyword</span>
<span class="sd">    will add a carbonate_chemistry chemistry module to the reservoir</span>
<span class="sd">    group. The values of the carbonate system are available assign</span>

<span class="sd">    self.cs.H</span>
<span class="sd">    self.cs.CA</span>
<span class="sd">    self.cs.HCO3</span>
<span class="sd">    self.cs.CO3</span>
<span class="sd">    self.CO2aq</span>

<span class="sd">    seawater_parameters:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    If this optional parameter is specified, a SeaWaterConstants instance will</span>
<span class="sd">    be registered for this Reservoir as Reservoir.swc</span>
<span class="sd">    See the  SeaWaterConstants class for details how to specify the parameters, e.g.:</span>
<span class="sd">    seawater_parameters = {&quot;temperature&quot;: 2, &quot;pressure&quot;: 240, &quot;salinity&quot; : 35},</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new reservoir group&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ExternalCode</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">Model</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">calc_carbonates_2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;carbonate_system&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;concentration&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_cs1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_cs2</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># reset values, otherwise creation of Reservoir will complain</span>
            <span class="c1"># about volume and geometry being defined</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume must be string or quantity&quot;</span><span class="p">)</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="c1"># if self.mo.register == &quot;local&quot; and self.register == &quot;None&quot;:</span>
        <span class="c1">#     self.register = self.mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># register a seawater_parameter instance if necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
            <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">SeawaterConstants</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">pressure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span>
                <span class="n">salinity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">salinity</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># dict with all default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># now we loop trough all keys for this reservoir and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># kcd  = delta, plot, etc</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry delta</span>
                    <span class="c1"># test if delta relates to any species</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry with the value provided in kwargs</span>
                        <span class="c1"># self.cd[&#39;SO4_name&#39;][&#39;delta&#39;] = self.kwargs[&#39;delta&#39;][SO4]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of reservoirs in this group.</span>
        <span class="c1"># loop over all entries in species and create the respective reservoirs</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="c1"># create reservoir without registering it in the global name space</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
                <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;isotopes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># register as part of this group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># setup the carbonate system</span>

        <span class="c1"># depreceated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbonate_system</span><span class="p">:</span>
            <span class="c1"># do some sanity checks:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;swc&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no seawaterconstants instance&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no DIC reservoir&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no TA reservoir&quot;</span><span class="p">)</span>

            <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">CO2</span><span class="p">,</span>
                <span class="n">alias_list</span><span class="o">=</span><span class="s2">&quot;H CA HCO3 CO3 CO2aq omega zsat&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>
                        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># omega</span>
                        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># zsat</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_2</span><span class="p">,</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">]),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 7</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 8</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">zsat0</span><span class="p">,</span>  <span class="c1"># zsat0 after Boudreau 2010</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class allows the creation of a group of reservoirs which share
a common volume, and potentially connections. E.g., if we have twoy
reservoir groups with the same reservoirs, and we connect them
with a flux, this flux will apply to all reservoirs in this group.</p>

<p>A typical examples might be ocean water which comprises several
species.  A reservoir group like ShallowOcean will then contain
sub-reservoirs like DIC in the form of ShallowOcean.DIC</p>

<p>Example::</p>

<pre><code>ReservoirGroup(name = "ShallowOcean",        # Name of reservoir group
            volume/geometry = "1E5 l",       # see below
            delta   = {DIC:0, TA:0, PO4:0]  # dict of delta values
            mass/concentration = {DIC:"1 unit", TA: "1 unit"}
            plot = {DIC:"yes", TA:"yes"}  defaults to yes
            isotopes = {DIC: True/False} see Reservoir class for details
            seawater_parameter = dict, optional, see below
            carbonate_system= False, see below
       )
</code></pre>

<p>Notes: - The subreservoirs are derived from the keys in the concentration or mass
         dictionary. Toward this end, the keys must be valid species handles and
         -- not species names -- !</p>

<p>Connecting two reservoir groups requires that the names in both
group match, or that you specify a dictionary which delineates the
matching.</p>

<p>Most parameters are passed on to the Reservoir class. See the reservoir class
documentation for details</p>

<p>The geometry keyword specifies the upper depth interval, the lower
depth interval, and the fraction of the total ocean area inhabited by the reservoir</p>

<p>If the geometry parameter is supplied, the following instance variables will be
computed</p>

<pre><code>         self.volume: in model units (usually liter)
         self.area: surface area in m^2 at the upper bounding surface
         self.area_dz: area of seafloor which is intercepted by this box.
         self.area_fraction: area of seafloor which is intercepted by this
                            relative to the total ocean floor area
</code></pre>

<p>carbonate_system:
<strike>~</strike><strike>~</strike><strike>~</strike>~~</p>

<p>If the reservoir group has a DIC and TA reservoir, and if the
seawater_parameters key has been supplied as well, this keyword
will add a carbonate_chemistry chemistry module to the reservoir
group. The values of the carbonate system are available assign</p>

<p>self.cs.H
self.cs.CA
self.cs.HCO3
self.cs.CO3
self.CO2aq</p>

<p>seawater_parameters:
<strike>~</strike><strike>~</strike><strike>~</strike>~~~~
If this optional parameter is specified, a SeaWaterConstants instance will
be registered for this Reservoir as Reservoir.swc
See the  SeaWaterConstants class for details how to specify the parameters, e.g.:
seawater_parameters = {"temperature": 2, "pressure": 240, "salinity" : 35},</p>
</div>


                            <div id="ReservoirGroup.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ReservoirGroup.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ReservoirGroup</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a new reservoir group&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ExternalCode</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SeawaterConstants</span><span class="p">,</span>
            <span class="n">Model</span><span class="p">,</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">,</span>
            <span class="n">Q_</span><span class="p">,</span>
            <span class="n">calc_carbonates_2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;seawater_parameters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;carbonate_system&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;concentration&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;concentration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide either mass or concentration&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_cs1</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_cs2</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># geoemtry information</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">get_box_geometry_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c1"># reset values, otherwise creation of Reservoir will complain</span>
            <span class="c1"># about volume and geometry being defined</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Volume must be string or quantity&quot;</span><span class="p">)</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="c1"># if self.mo.register == &quot;local&quot; and self.register == &quot;None&quot;:</span>
        <span class="c1">#     self.register = self.mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># register a seawater_parameter instance if necessary</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">salinity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">salinity</span> <span class="o">=</span> <span class="mi">35</span>
            <span class="k">if</span> <span class="s2">&quot;pressure&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seawater_parameters</span><span class="p">[</span><span class="s2">&quot;pressure&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pressure</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">SeawaterConstants</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;swc&quot;</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">pressure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pressure</span><span class="p">,</span>
                <span class="n">salinity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">salinity</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># dict with all default values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># now we loop trough all keys for this reservoir and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># kcd  = delta, plot, etc</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry delta</span>
                    <span class="c1"># test if delta relates to any species</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry with the value provided in kwargs</span>
                        <span class="c1"># self.cd[&#39;SO4_name&#39;][&#39;delta&#39;] = self.kwargs[&#39;delta&#39;][SO4]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of reservoirs in this group.</span>
        <span class="c1"># loop over all entries in species and create the respective reservoirs</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="c1"># create reservoir without registering it in the global name space</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Reservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">mass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;mass&quot;</span><span class="p">],</span>
                <span class="n">concentration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;concentration&quot;</span><span class="p">],</span>
                <span class="n">volume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                <span class="n">geometry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;isotopes&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># register as part of this group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c1"># setup the carbonate system</span>

        <span class="c1"># depreceated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">carbonate_system</span><span class="p">:</span>
            <span class="c1"># do some sanity checks:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;swc&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no seawaterconstants instance&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;DIC&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no DIC reservoir&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;TA&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> has no TA reservoir&quot;</span><span class="p">)</span>

            <span class="n">ExternalCode</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cs&quot;</span><span class="p">,</span>
                <span class="n">species</span><span class="o">=</span><span class="n">Model</span><span class="o">.</span><span class="n">CO2</span><span class="p">,</span>
                <span class="n">alias_list</span><span class="o">=</span><span class="s2">&quot;H CA HCO3 CO3 CO2aq omega zsat&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
                <span class="n">vr_datafields</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hco3</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co3</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">co2</span><span class="p">,</span>
                        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># omega</span>
                        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># zsat</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">function</span><span class="o">=</span><span class="n">calc_carbonates_2</span><span class="p">,</span>
                <span class="n">function_input_data</span><span class="o">=</span><span class="n">List</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">DIC</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span><span class="o">.</span><span class="n">c</span><span class="p">]),</span>
                <span class="n">function_params</span><span class="o">=</span><span class="n">List</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K1</span><span class="p">,</span>  <span class="c1"># 0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">K2</span><span class="p">,</span>  <span class="c1"># 1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KW</span><span class="p">,</span>  <span class="c1"># 2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">KB</span><span class="p">,</span>  <span class="c1"># 3</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">boron</span><span class="p">,</span>  <span class="c1"># 4</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">hplus</span><span class="p">,</span>  <span class="c1"># 5</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">ca2</span><span class="p">,</span>  <span class="c1"># 6</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp</span><span class="p">,</span>  <span class="c1"># 7</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">Ksp0</span><span class="p">,</span>  <span class="c1"># 8</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">swc</span><span class="o">.</span><span class="n">zsat0</span><span class="p">,</span>  <span class="c1"># zsat0 after Boudreau 2010</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a new reservoir group</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ReservoirGroup.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="ReservoirGroup.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SourceSink">
                                <div class="attr class">
        <a class="headerlink" href="#SourceSink">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceSink</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceSink</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup a Source/Sink objects. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">               species = SO4,</span>
<span class="sd">               display_precision = number, optional, inherited from Model</span>
<span class="sd">               delta = number or str. optional defaults to &quot;None&quot;</span>
<span class="sd">           )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SourceSinkGroup</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SourceSinkGroup</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># if self.register == &quot;None&quot;:</span>
        <span class="c1">#     self.pt = self.name</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.pt: str = f&quot;{self.register.name}_{self.n}&quot;</span>
        <span class="c1">#     self.groupname = self.register.name</span>

        <span class="c1"># if self.delta != &quot;None&quot;:</span>
        <span class="c1">#     self.isotopes = True</span>

        <span class="c1"># if self.display_precision == 0:</span>
        <span class="c1">#     self.display_precision = self.mo.display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is a meta class to setup a Source/Sink objects. These are not
actual reservoirs, but we stil need to have them as objects
Example::</p>

<pre><code>   Sink(name = "Pyrite",
       species = SO4,
       display_precision = number, optional, inherited from Model
       delta = number or str. optional defaults to "None"
   )
</code></pre>

<p>where the first argument is a string, and the second is a reservoir handle</p>
</div>


                            <div id="SourceSink.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SourceSink.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SourceSink</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SourceSinkGroup</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">SourceSinkGroup</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># legacy names</span>
        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.name}.{self.register.name}&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lio</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># if self.register == &quot;None&quot;:</span>
        <span class="c1">#     self.pt = self.name</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self.pt: str = f&quot;{self.register.name}_{self.n}&quot;</span>
        <span class="c1">#     self.groupname = self.register.name</span>

        <span class="c1"># if self.delta != &quot;None&quot;:</span>
        <span class="c1">#     self.isotopes = True</span>

        <span class="c1"># if self.display_precision == 0:</span>
        <span class="c1">#     self.display_precision = self.mo.display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="SourceSink.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="SourceSink.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SourceSinkGroup">
                                <div class="attr class">
        <a class="headerlink" href="#SourceSinkGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceSinkGroup</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceSinkGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a meta class to setup  Source/Sink Groups. These are not</span>
<span class="sd">    actual reservoirs, but we stil need to have them as objects</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,</span>
<span class="sd">                species = [SO42, H2S],</span>
<span class="sd">                delta = {&quot;SO4&quot;: 10}</span>
<span class="sd">                )</span>

<span class="sd">    where the first argument is a string, and the second is a reservoir handle</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(),</span> <span class="p">(</span><span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># register this object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># get model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of sub reservoirs in this group</span>

        <span class="c1"># loop over species names and setup sub-objects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SourceGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SinkGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a valid class type&quot;</span><span class="p">)</span>

            <span class="c1"># register in local namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is a meta class to setup  Source/Sink Groups. These are not
actual reservoirs, but we stil need to have them as objects
Example::</p>

<pre><code>   Sink(name = "Pyrite",
        species = [SO42, H2S],
        delta = {"SO4": 10}
        )
</code></pre>

<p>where the first argument is a string, and the second is a reservoir handle</p>
</div>


                            <div id="SourceSinkGroup.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SourceSinkGroup.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SourceSinkGroup</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(),</span> <span class="p">(</span><span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="s2">&quot;register&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">Connection</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set of connection objects</span>

        <span class="c1"># register this object in the global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># get model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of sub reservoirs in this group</span>

        <span class="c1"># loop over species names and setup sub-objects</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Species</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> needs to be a valid species name&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SourceGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;SinkGroup&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Sink</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">species</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not a valid class type&quot;</span><span class="p">)</span>

            <span class="c1"># register in local namespace</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="SourceSinkGroup.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="SourceSinkGroup.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SinkGroup">
                                <div class="attr class">
        <a class="headerlink" href="#SinkGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SinkGroup</span><wbr>(<span class="base"><a href="#SourceSinkGroup">SourceSinkGroup</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SinkGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Sink object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;Pyrite&quot;,species =SO4)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Sink object
Example::</p>

<pre><code>   Sink(name = "Pyrite",species =SO4)
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSinkGroup">SourceSinkGroup</a></dt>
                                <dd id="SinkGroup.__init__" class="function"><a href="#SourceSinkGroup.__init__">SourceSinkGroup</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="SinkGroup.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="SinkGroup.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SourceGroup">
                                <div class="attr class">
        <a class="headerlink" href="#SourceGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SourceGroup</span><wbr>(<span class="base"><a href="#SourceSinkGroup">SourceSinkGroup</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SourceGroup</span><span class="p">(</span><span class="n">SourceSinkGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a wrapper to setup a Source object</span>
<span class="sd">    Example::</span>

<span class="sd">           Sink(name = &quot;SO4_diffusion&quot;, species =&quot;SO4&quot;)</span>

<span class="sd">    where the first argument is a string, and the second is a species handle</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is just a wrapper to setup a Source object
Example::</p>

<pre><code>   Sink(name = "SO4_diffusion", species ="SO4")
</code></pre>

<p>where the first argument is a string, and the second is a species handle</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SourceSinkGroup">SourceSinkGroup</a></dt>
                                <dd id="SourceGroup.__init__" class="function"><a href="#SourceSinkGroup.__init__">SourceSinkGroup</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="SourceGroup.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="SourceGroup.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Signal">
                                <div class="attr class">
        <a class="headerlink" href="#Signal">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Signal</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Signal</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class will create a signal which is</span>
<span class="sd">    described by its startime (relative to the model time), it&#39;s</span>
<span class="sd">    size (as mass) and duration, or as duration and</span>
<span class="sd">    magnitude. Furthermore, we can presribe the signal shape</span>
<span class="sd">    (square, pyramid) and whether the signal will repeat. You</span>
<span class="sd">    can also specify whether the event will affect the delta value.</span>

<span class="sd">    The data in the signal class will simply be added to the data in</span>
<span class="sd">    a given flux. So this class cannot be used for scaling (can we</span>
<span class="sd">    add this functionality?)</span>

<span class="sd">    Example::</span>

<span class="sd">          Signal(name = &quot;Name&quot;,</span>
<span class="sd">                 species = Species handle,</span>
<span class="sd">                 start = &quot;0 yrs&quot;,     # optional</span>
<span class="sd">                 duration = &quot;0 yrs&quot;,  #</span>
<span class="sd">                 delta = 0,           # optional</span>
<span class="sd">                 stype = &quot;addition&quot;   # optional, currently the only type</span>
<span class="sd">                 shape = &quot;square/pyramid/bell/filename&quot;</span>
<span class="sd">                 mass/magnitude/filename  # give one</span>
<span class="sd">                 offset = &#39;0 yrs&#39;,     #</span>
<span class="sd">                 scale = 1, optional,  #</span>
<span class="sd">                 offset = option #</span>
<span class="sd">                 reservoir = r-handle # optional, see below</span>
<span class="sd">                 source = s-handle optional, see below</span>
<span class="sd">                 display_precision = number, optional, inherited from Model</span>
<span class="sd">                 register,</span>
<span class="sd">                )</span>

<span class="sd">    Signals are cumulative, i.e., complex signals ar created by</span>
<span class="sd">    adding one signal to another (i.e., Snew = S1 + S2)</span>

<span class="sd">    The optional scaling argument will only affect the y-column data of</span>
<span class="sd">    external data files</span>

<span class="sd">    Signals are registered with a flux during flux creation,</span>
<span class="sd">    i.e., they are passed on the process list when calling the</span>
<span class="sd">    connector object.</span>

<span class="sd">    if the filename argument is used, you can provide a filename which</span>
<span class="sd">    contains the data to be used in csv format. The data will be</span>
<span class="sd">    interpolated to the model domain, and added to the already existing data.</span>
<span class="sd">    The external data need to be in the following format</span>

<span class="sd">      Time, Rate, delta value</span>
<span class="sd">      0,     10,   12</span>

<span class="sd">      i.e., the first row needs to be a header line</span>

<span class="sd">    All time data in the csv file will be treated as realative time</span>
<span class="sd">    (i.e., the start time will be mapped to zero). Use the offset</span>
<span class="sd">    keyword to shift the external signal data in the time domain.</span>

<span class="sd">    Last but not least, you can provide an optional reservoir name. In</span>
<span class="sd">    this case, the signal will create a source as (signal_name_source)</span>
<span class="sd">    and the connection to the specified reservoir. If you build a</span>
<span class="sd">    complex signal do this as the last step. If you additionally</span>
<span class="sd">    provide a source name the connection will be made between the</span>
<span class="sd">    provided source (this can be useful if you use source groups).</span>


<span class="sd">    This class has the following methods</span>

<span class="sd">      Signal.repeat()</span>
<span class="sd">      Signal.plot()</span>
<span class="sd">      Signal.info()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse and initialize variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># provide a list of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1 yr&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;addition&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;legend_right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># list of signals we are based on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert units to model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># start time</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">   W A R N I N G </span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your signal duration is covered by less than 10&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intergration steps. This may not be what you want</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># legacy name definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># the name of the this signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># the species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stype</span>  <span class="c1"># type of signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># shape the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># delta value offset during the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>  <span class="c1"># list of keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_signal_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>  <span class="c1"># update the name of the signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_right</span>
        <span class="c1"># update isotope values</span>
        <span class="c1"># self.data.li = get_l_mass(self.data.m, self.data.d, self.sp.r)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model</span>

        <span class="c1"># in case we deal with a sink or source signal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_signal__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init_signal_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;1. Create a vector which contains the signal data. The vector length</span>
<span class="sd">           can exceed the modelling domain.</span>
<span class="sd">        2. Trim the signal vector in such a way that it fits within the</span>
<span class="sd">           modelling domain</span>
<span class="sd">        3. Create an empty flux and replace it with the signal vector data.</span>

<span class="sd">        Note that this flux will then be added to an existing flux.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span>

        <span class="c1"># these are signal times, not model time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>

        <span class="c1"># create signal vector</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;square&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__square__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;pyramid&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pyramid__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sh</span> <span class="o">==</span> <span class="s2">&quot;bell&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__bell__</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;filename&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># use an external data set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__int_ext_data__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;argument needs to be either square/pyramid, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;or an ExternalData object. &quot;</span>
            <span class="p">)</span>

        <span class="c1"># create a dummy flux we can act up</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
            <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">save_flux_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># remove signal fluxes from global flux list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="p">)</span>

        <span class="c1"># map into model space</span>
        <span class="n">insert_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span>
        <span class="n">insert_stop_time</span> <span class="o">=</span> <span class="n">insert_start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>

        <span class="n">dt1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
        <span class="n">dt2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span><span class="p">))</span>

        <span class="n">model_start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insert_start_time</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">model_stop_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span> <span class="o">+</span> <span class="n">dt2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">))</span>
        <span class="n">signal_start_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dt1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">signal_stop_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dt2</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;dt1 = </span><span class="si">{</span><span class="n">dt1</span><span class="si">}</span><span class="s2">, dt2 = </span><span class="si">{</span><span class="n">dt2</span><span class="si">}</span><span class="s2">, offset = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">offset</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;insert start time = </span><span class="si">{</span><span class="n">insert_start_time</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;insert_stop time = </span><span class="si">{</span><span class="n">insert_stop_time</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;duration = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;msi = </span><span class="si">{</span><span class="n">model_start_index</span><span class="si">}</span><span class="s2">, msp = </span><span class="si">{</span><span class="n">model_stop_index</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model num_steps = </span><span class="si">{</span><span class="n">model_stop_index</span><span class="o">-</span><span class="n">model_start_index</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;ssi = </span><span class="si">{</span><span class="n">signal_start_index</span><span class="si">}</span><span class="s2">, ssp = </span><span class="si">{</span><span class="n">signal_stop_index</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;signal num_steps = </span><span class="si">{</span><span class="n">signal_stop_index</span><span class="o">-</span><span class="n">signal_start_index</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">signal_start_index</span> <span class="o">&lt;</span> <span class="n">signal_stop_index</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">model_start_index</span><span class="p">:</span><span class="n">model_stop_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">[</span>
                <span class="n">signal_start_index</span><span class="p">:</span><span class="n">signal_stop_index</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nf</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">model_start_index</span><span class="p">:</span><span class="n">model_stop_index</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span><span class="p">[</span>
                <span class="n">signal_start_index</span><span class="p">:</span><span class="n">signal_stop_index</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nf</span>

    <span class="k">def</span> <span class="nf">__square__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create Square Signal&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the square</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">h</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">+</span> <span class="n">h</span>  <span class="c1"># add this to the section</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># add the delta offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__pyramid__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create pyramid type Signal</span>

<span class="sd">        s = start index</span>
<span class="sd">        e = end index</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>  <span class="c1"># get the height of the pyramid</span>

        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must specify mass or magnitude of the signal&quot;</span><span class="p">)</span>

        <span class="c1"># create pyramid</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># get the center index for the peak</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">])</span>  <span class="c1"># setup the x coordinates</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the y coordinates</span>

        <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>  <span class="c1"># setup the d coordinates</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>  <span class="c1"># setup the points at which to interpolate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># interpolate delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bell__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a bell curve type signal</span>

<span class="sd">        s = start index</span>
<span class="sd">        e = end index</span>

<span class="sd">        Note that the area under the curve equals one.</span>
<span class="sd">        So we can scale the result simply with mass</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">e</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># get the center index for the peak</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">e</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">e</span>
        <span class="n">pi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">mu</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">4</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mu = </span><span class="si">{</span><span class="n">mu</span><span class="si">}</span><span class="s2"> ,phi = </span><span class="si">{</span><span class="n">phi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;x[0] = </span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, x[-1] = </span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">phi</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># get bell curve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">phi</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="n">e</span><span class="o">**</span><span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bell type signal require either mass or magnitude&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__int_ext_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate External data as a signal. Unlike the other signals,</span>
<span class="sd">        this will replace the values in the flux with those read from the</span>
<span class="sd">        external data source. The external data need to be in the following format</span>

<span class="sd">        Time [units], Rate [units], delta value [units]</span>
<span class="sd">        0,     10,   12</span>

<span class="sd">        i.e., the first row needs to be a header line</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Q_</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># read external dataset</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># get unit information from each header</span>
        <span class="n">xh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zh</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># create the associated quantities</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">yh</span><span class="p">)</span>

        <span class="c1"># add these to the data we are are reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">yq</span>
        <span class="k">if</span> <span class="n">zh</span><span class="p">:</span>
            <span class="c1"># delta is assumed to be without units</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_delta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># map into model units, and strip unit information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># start time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">et</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># end time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">et</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">)))</span>
        <span class="n">num_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="c1"># setup the points at which to interpolate</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">et</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
            <span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_data</span>
        <span class="p">)</span>  <span class="c1"># interpolate flux</span>
        <span class="k">if</span> <span class="n">zh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_delta</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s_l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_steps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__apply_signal__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;In case we deal with a source  signal, we need</span>
<span class="sd">        to create a source, and connect signal, source and reservoir</span>
<span class="sd">        Maybe this logic should be me moved elsewhere?</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Connect</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_Source&quot;</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="n">Connect</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>  <span class="c1"># source of flux</span>
            <span class="n">sink</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span>  <span class="c1"># target of flux</span>
            <span class="n">rate</span><span class="o">=</span><span class="s2">&quot;0 mol/yr&quot;</span><span class="p">,</span>  <span class="c1"># flux rate</span>
            <span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>  <span class="c1"># list of processes</span>
            <span class="n">plot</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;allow the addition of two signals and return a new signal&quot;&quot;&quot;</span>

        <span class="n">ns</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># add the data of both fluxes</span>
        <span class="c1"># get delta of self</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">get_delta</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">sd</span> <span class="o">+</span> <span class="n">od</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>

        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">, returning </span><span class="si">{</span><span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_and_&quot;</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">st</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">st</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">l</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">sh</span> <span class="o">=</span> <span class="s2">&quot;compound&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method creates a new signal by repeating an existing signal.</span>
<span class="sd">        Example::</span>

<span class="sd">        new_signal = signal.repeat(start,   # start time of signal slice to be repeated</span>
<span class="sd">                                   stop,    # end time of signal slice to be repeated</span>
<span class="sd">                                   offset,  # offset between repetitions</span>
<span class="sd">                                   times,   # number of time to repeat the slice</span>
<span class="sd">                              )</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ns</span><span class="p">:</span> <span class="n">Signal</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times_data&quot;</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># convert from time to index</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">times</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>  <span class="c1"># get the data slice we are using</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>  <span class="c1"># end index larger than data size</span>
                <span class="n">diff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># difference</span>
                <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">diff</span>  <span class="c1"># new end index</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>

            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>

        <span class="c1"># and recalculate li and hi</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ns</span>

    <span class="k">def</span> <span class="nf">__register_with_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register this signal with a flux. This should probably be done</span>
<span class="sd">        through a process!</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Flux</span><span class="p">,</span> <span class="n">Species</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fo</span><span class="p">:</span> <span class="n">Flux</span> <span class="o">=</span> <span class="n">flux</span>  <span class="c1"># the flux handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="n">flux</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># the species handle</span>
        <span class="c1"># list of processes</span>
        <span class="n">flux</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return Signal value at time t (mass and mass for light</span>
<span class="sd">        isotope). This will work as long a t is a multiple of dt, and i = t.</span>
<span class="sd">        may extend this by addding linear interpolation but that will</span>
<span class="sd">        be costly</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="c1"># convert time and data to display units</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">plt_units</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># # test for plt_transform</span>
        <span class="c1"># if self.plot_transform_c != &quot;None&quot;:</span>
        <span class="c1">#     if callable(self.plot_transform_c):</span>
        <span class="c1">#         y1 = self.plot_transform_c(self.c)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         raise ValueError(&quot;Plot transform must be a function&quot;)</span>

        <span class="c1"># plot first axis</span>
        <span class="n">ln1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="c1"># plot second axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span>  <span class="c1"># no conversion for isotopes</span>
            <span class="n">ln2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">y2</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ld</span><span class="p">)</span>
            <span class="n">set_y_limits</span><span class="p">(</span><span class="n">axt</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># set combined legend</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class will create a signal which is
described by its startime (relative to the model time), it's
size (as mass) and duration, or as duration and
magnitude. Furthermore, we can presribe the signal shape
(square, pyramid) and whether the signal will repeat. You
can also specify whether the event will affect the delta value.</p>

<p>The data in the signal class will simply be added to the data in
a given flux. So this class cannot be used for scaling (can we
add this functionality?)</p>

<p>Example::</p>

<pre><code>  Signal(name = "Name",
         species = Species handle,
         start = "0 yrs",     # optional
         duration = "0 yrs",  #
         delta = 0,           # optional
         stype = "addition"   # optional, currently the only type
         shape = "square/pyramid/bell/filename"
         mass/magnitude/filename  # give one
         offset = '0 yrs',     #
         scale = 1, optional,  #
         offset = option #
         reservoir = r-handle # optional, see below
         source = s-handle optional, see below
         display_precision = number, optional, inherited from Model
         register,
        )
</code></pre>

<p>Signals are cumulative, i.e., complex signals ar created by
adding one signal to another (i.e., Snew = S1 + S2)</p>

<p>The optional scaling argument will only affect the y-column data of
external data files</p>

<p>Signals are registered with a flux during flux creation,
i.e., they are passed on the process list when calling the
connector object.</p>

<p>if the filename argument is used, you can provide a filename which
contains the data to be used in csv format. The data will be
interpolated to the model domain, and added to the already existing data.
The external data need to be in the following format</p>

<p>Time, Rate, delta value
  0,     10,   12</p>

<p>i.e., the first row needs to be a header line</p>

<p>All time data in the csv file will be treated as realative time
(i.e., the start time will be mapped to zero). Use the offset
keyword to shift the external signal data in the time domain.</p>

<p>Last but not least, you can provide an optional reservoir name. In
this case, the signal will create a source as (signal_name_source)
and the connection to the specified reservoir. If you build a
complex signal do this as the last step. If you additionally
provide a source name the connection will be made between the
provided source (this can be useful if you use source groups).</p>

<p>This class has the following methods</p>

<p><a href="#Signal.repeat">Signal.repeat()</a>
  Signal.plot()
  <a href="#Signal.info">Signal.info()</a></p>
</div>


                            <div id="Signal.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Signal.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Signal</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse and initialize variables&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># provide a list of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1 yr&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;stype&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;addition&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;magnitude&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;legend_right&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;magnitude&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># list of signals we are based on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert units to model units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># start time</span>

        <span class="k">if</span> <span class="s2">&quot;mass&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="k">elif</span> <span class="s2">&quot;magnitude&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">   W A R N I N G </span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your signal duration is covered by less than 10&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intergration steps. This may not be what you want</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># legacy name definitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># the name of the this signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">:</span> <span class="n">Species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>  <span class="c1"># the species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ty</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stype</span>  <span class="c1"># type of signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sh</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># shape the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># delta value offset during the event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwd</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>  <span class="c1"># list of keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_signal_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>  <span class="c1"># update the name of the signal data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">legend_right</span>
        <span class="c1"># update isotope values</span>
        <span class="c1"># self.data.li = get_l_mass(self.data.m, self.data.d, self.sp.r)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register with model</span>

        <span class="c1"># in case we deal with a sink or source signal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__apply_signal__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Parse and initialize variables</p>
</div>


                            </div>
                            <div id="Signal.repeat" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Signal.repeat">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">repeat</span><span class="signature">(self, start, stop, offset, times) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">repeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method creates a new signal by repeating an existing signal.</span>
<span class="sd">        Example::</span>

<span class="sd">        new_signal = signal.repeat(start,   # start time of signal slice to be repeated</span>
<span class="sd">                                   stop,    # end time of signal slice to be repeated</span>
<span class="sd">                                   offset,  # offset between repetitions</span>
<span class="sd">                                   times,   # number of time to repeat the slice</span>
<span class="sd">                              )</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ns</span><span class="p">:</span> <span class="n">Signal</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times&quot;</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;_repeated_</span><span class="si">{</span><span class="n">times</span><span class="si">}</span><span class="s2">_times_data&quot;</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># convert from time to index</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">times</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">times</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>  <span class="c1"># get the data slice we are using</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">stop</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>  <span class="c1"># end index larger than data size</span>
                <span class="n">diff</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># difference</span>
                <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">diff</span>  <span class="c1"># new end index</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span> <span class="o">-</span> <span class="n">diff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">)</span>

            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ms</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span> <span class="o">+</span> <span class="n">ns</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">lds</span><span class="p">]</span>

        <span class="c1"># and recalculate li and hi</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="p">[</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_imass</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">d</span><span class="p">,</span> <span class="n">ns</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ns</span>
</pre></div>

        </details>

            <div class="docstring"><p>This method creates a new signal by repeating an existing signal.
Example::</p>

<p>new_signal = signal.repeat(start,   # start time of signal slice to be repeated
                           stop,    # end time of signal slice to be repeated
                           offset,  # offset between repetitions
                           times,   # number of time to repeat the slice
                      )</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Signal.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="Signal.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DataField">
                                <div class="attr class">
        <a class="headerlink" href="#DataField">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">DataField</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DataField</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataField: Datafields can be used to plot data which is computed after</span>
<span class="sd">    the model finishes in the overview plot windows. Therefore, datafields will</span>
<span class="sd">    plot in the same window as the reservoir they are associated with.</span>
<span class="sd">    Datafields must share the same x-axis is the model, and can have up to two</span>
<span class="sd">    y axis.</span>

<span class="sd">    Example::</span>

<span class="sd">             DataField(name = &quot;Name&quot;</span>
<span class="sd">                       register = Model handle,</span>
<span class="sd">                       y1_data = np.Ndarray or list of arrays</span>
<span class="sd">                       y1_label = Y-Axis label</span>
<span class="sd">                       y1_legend = Data legend or list of legends</span>
<span class="sd">                       y2_data = np.Ndarray    # optional</span>
<span class="sd">                       y2_label = Y-Axis label # optional</span>
<span class="sd">                       y2_legend = Data legend # optional</span>
<span class="sd">                       common_y_scale = &quot;no&quot;,  #optional, default &quot;no&quot;</span>
<span class="sd">                       display_precision = number, optional, inherited from Model</span>
<span class="sd">                       )</span>

<span class="sd">    Note that Datafield data is not mapped to model units. Care must be taken</span>
<span class="sd">    that the data units match the model units.</span>

<span class="sd">    The instance provides the following data</span>

<span class="sd">    Name.x    = X-axis = model X-axis</span>
<span class="sd">    Name.y1_data</span>
<span class="sd">    Name.y1_label</span>
<span class="sd">    Name.y1_legend</span>

<span class="sd">    Similarly for y2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this instance&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Reservoir_no_set</span><span class="p">,</span> <span class="n">VirtualReservoir</span><span class="p">,</span> <span class="n">ExternalCode</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">Reservoir_no_set</span><span class="p">,</span>
                    <span class="n">VirtualReservoir</span><span class="p">,</span>
                    <span class="n">ExternalCode</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">Reservoir_no_set</span><span class="p">,</span>
                    <span class="n">VirtualReservoir</span><span class="p">,</span>
                    <span class="n">ExternalCode</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;x1_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;x2_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;associated_with&quot;</span><span class="p">],</span> <span class="s2">&quot;y1_data&quot;</span><span class="p">]</span>

        <span class="c1"># provide a dictionary entry for a keyword specific error message</span>
        <span class="c1"># see esbmtkBase.__initerrormessages__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span>

        <span class="c1"># set legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="c1"># if self.associated_with == &quot;None&quot;:</span>
        <span class="c1">#     self.associated_with = self.mo.lor[0]</span>

        <span class="c1"># self.mo = self.associated_with.mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">plt_units</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plt_units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This needs fixing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;self.y2_data&quot;</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">]</span>

        <span class="c1"># if no x data provided, match with model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">]</span>

        <span class="c1"># register with reservoir</span>
        <span class="c1"># self.associated_with.ldf.append(self)</span>
        <span class="c1"># register with model. needed for print_reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, you are initializing a datafield before the model results are known</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># some short hands</span>
        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>

        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># build the dataframe</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>
        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y1 data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># y2_data</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">__plot__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">M</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot instructions.</span>
<span class="sd">        M: Model</span>
<span class="sd">        ax: matplotlib axes handle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">set_y_limits</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">last_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1"># add any external data if present</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">led</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">M</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="c1"># yd = (d.y * M.c_unit).to(self.plt_units).magnitude</span>
            <span class="n">leg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">legend</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">d</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">last_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leg</span><span class="p">)</span>

        <span class="n">last_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_label</span><span class="p">)</span>
        <span class="c1"># remove unnecessary frame species</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;doing twinx for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">axt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>  <span class="c1"># loop over datafield list</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;C</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="n">last_i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="n">axt</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">time_label</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">M</span><span class="o">.</span><span class="n">d_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span><span class="p">)</span>
            <span class="c1"># remove unnecessary frame species</span>
            <span class="n">axt</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">handler2</span><span class="p">,</span> <span class="n">label2</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">legend</span> <span class="o">=</span> <span class="n">axt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span> <span class="o">+</span> <span class="n">handler2</span><span class="p">,</span> <span class="n">label1</span> <span class="o">+</span> <span class="n">label2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span>
                <span class="mi">6</span>
            <span class="p">)</span>
            <span class="c1"># axt.legend()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handler1</span><span class="p">,</span> <span class="n">label1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;bottom&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>DataField: Datafields can be used to plot data which is computed after
the model finishes in the overview plot windows. Therefore, datafields will
plot in the same window as the reservoir they are associated with.
Datafields must share the same x-axis is the model, and can have up to two
y axis.</p>

<p>Example::</p>

<pre><code>     DataField(name = "Name"
               register = Model handle,
               y1_data = np.Ndarray or list of arrays
               y1_label = Y-Axis label
               y1_legend = Data legend or list of legends
               y2_data = np.Ndarray    # optional
               y2_label = Y-Axis label # optional
               y2_legend = Data legend # optional
               common_y_scale = "no",  #optional, default "no"
               display_precision = number, optional, inherited from Model
               )
</code></pre>

<p>Note that Datafield data is not mapped to model units. Care must be taken
that the data units match the model units.</p>

<p>The instance provides the following data</p>

<p>Name.x    = X-axis = model X-axis
Name.y1_data
Name.y1_label
Name.y1_legend</p>

<p>Similarly for y2</p>
</div>


                            <div id="DataField.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DataField.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">DataField</span><span class="signature">(**kwargs: dict)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize this instance&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">Reservoir_no_set</span><span class="p">,</span> <span class="n">VirtualReservoir</span><span class="p">,</span> <span class="n">ExternalCode</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">Reservoir_no_set</span><span class="p">,</span>
                    <span class="n">VirtualReservoir</span><span class="p">,</span>
                    <span class="n">ExternalCode</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;associated_with&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">Model</span><span class="p">,</span>
                    <span class="n">Reservoir</span><span class="p">,</span>
                    <span class="n">ReservoirGroup</span><span class="p">,</span>
                    <span class="n">Reservoir_no_set</span><span class="p">,</span>
                    <span class="n">VirtualReservoir</span><span class="p">,</span>
                    <span class="n">ExternalCode</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;y1_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;x1_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y1_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y1_legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;y2_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;x2_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y2_label&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;y2_legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Not Provided&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;common_y_scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;register&quot;</span><span class="p">,</span> <span class="s2">&quot;associated_with&quot;</span><span class="p">],</span> <span class="s2">&quot;y1_data&quot;</span><span class="p">]</span>

        <span class="c1"># provide a dictionary entry for a keyword specific error message</span>
        <span class="c1"># see esbmtkBase.__initerrormessages__()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span>

        <span class="c1"># set legacy variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legend_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span>

        <span class="c1"># if self.associated_with == &quot;None&quot;:</span>
        <span class="c1">#     self.associated_with = self.mo.lor[0]</span>

        <span class="c1"># self.mo = self.associated_with.mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">plt_units</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associated_with</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plt_units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This needs fixing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;self.y2_data&quot;</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legend_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ld</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_label</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">led</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">]</span>

        <span class="c1"># if no x data provided, match with model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">d_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x1_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x2_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1_legend</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y2_legend</span><span class="p">]</span>

        <span class="c1"># register with reservoir</span>
        <span class="c1"># self.associated_with.ldf.append(self)</span>
        <span class="c1"># register with model. needed for print_reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">ldf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Warning, you are initializing a datafield before the model results are known</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;---------------------------------------------------------------------------&quot;</span>
            <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize this instance</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="DataField.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="DataField.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Reservoir_no_set">
                                <div class="attr class">
        <a class="headerlink" href="#Reservoir_no_set">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Reservoir_no_set</span><wbr>(<span class="base"><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Reservoir_no_set</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class is similar to a regular reservoir, but we make no</span>
<span class="sd">    assumptions about the type of data contained. I.e., all data will be</span>
<span class="sd">    left alone</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The original class will calculate delta and concentration from mass</span>
<span class="sd">        an d and h and l. Since we want to use this class without a</span>
<span class="sd">        priory knowledge of how the reservoir arrays are being used we</span>
<span class="sd">        overwrite the data generated during initialization with the</span>
<span class="sd">        values provided in the keywords</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;vr_datafields&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">(</span><span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;function_input_data&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">List</span><span class="p">(),</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;alias_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
        <span class="c1"># save the unit which was provided by the user for display purposes</span>

        <span class="c1"># ------------------------------------------</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="c1"># self.mo.lor.remove(self)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>

        <span class="c1"># this should be done in aux-inits of a derived class if necessary</span>
        <span class="c1"># self.mo.lvr.append(self)</span>
        <span class="c1"># print(f&quot;added {self.name} to lvr 1&quot;)</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class is similar to a regular reservoir, but we make no
assumptions about the type of data contained. I.e., all data will be
left alone</p>
</div>


                            <div id="Reservoir_no_set.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Reservoir_no_set.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Reservoir_no_set</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The original class will calculate delta and concentration from mass</span>
<span class="sd">        an d and h and l. Since we want to use this class without a</span>
<span class="sd">        priory knowledge of how the reservoir arrays are being used we</span>
<span class="sd">        overwrite the data generated during initialization with the</span>
<span class="sd">        values provided in the keywords</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;vr_datafields&quot;</span><span class="p">:</span> <span class="p">[{},</span> <span class="p">(</span><span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;function_input_data&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">List</span><span class="p">(),</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;alias_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>
        <span class="c1"># save the unit which was provided by the user for display purposes</span>

        <span class="c1"># ------------------------------------------</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="c1"># self.mo.lor.remove(self)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>

        <span class="c1"># this should be done in aux-inits of a derived class if necessary</span>
        <span class="c1"># self.mo.lvr.append(self)</span>
        <span class="c1"># print(f&quot;added {self.name} to lvr 1&quot;)</span>
        <span class="c1"># register instance name in global name space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

        </details>

            <div class="docstring"><p>The original class will calculate delta and concentration from mass
an d and h and l. Since we want to use this class without a
priory knowledge of how the reservoir arrays are being used we
overwrite the data generated during initialization with the
values provided in the keywords</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></dt>
                                <dd id="Reservoir_no_set.get_process_args" class="function"><a href="esbmtk.html#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="Reservoir_no_set.info" class="function"><a href="esbmtk.html#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="Reservoir_no_set.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ExternalCode">
                                <div class="attr class">
        <a class="headerlink" href="#ExternalCode">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ExternalCode</span><wbr>(<span class="base"><a href="#Reservoir_no_set">Reservoir_no_set</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ExternalCode</span><span class="p">(</span><span class="n">Reservoir_no_set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class can be used to implement user provided functions. The</span>
<span class="sd">    data inside a VR_no_set instance will only change in response to a</span>
<span class="sd">    user provided function but will otherwise remain unaffected. That is,</span>
<span class="sd">    it is up to the user provided function to manage changes in reponse to</span>
<span class="sd">    external fluxes. A VR_no_set is declared in the following way</span>

<span class="sd">        ExternalCode(</span>
<span class="sd">                    name=&quot;cs&quot;,     # instance name</span>
<span class="sd">                    species=CO2,   # species, must be given</span>
<span class="sd">                    # The next line defines the number of datafields and their default values</span>

<span class="sd">                    data which will be computed by this function</span>
<span class="sd">                    provide alias name and default value</span>
<span class="sd">                    vr_datafields :dict ={&quot;Hplus&quot;: self.swc.hplus,</span>
<span class="sd">                                          &quot;Beta&quot;: 0.0},</span>

<span class="sd">                    function=calc_carbonates, # function reference, see below</span>
<span class="sd">                    # A numba types List of one ore more np.arrays which are used</span>
<span class="sd">                    # as input values for the user provided function</span>
<span class="sd">                    function_input_data=List([self.DIC.c, self.TA.c]),</span>

<span class="sd">                    # A numba types List of float parameters.</span>
<span class="sd">                    alias_list = [&quot;H&quot;, &quot;CA&quot;, &quot;HCO3&quot;, &quot;CO3&quot;, &quot;CO2aq&quot;]</span>
<span class="sd">                    # Note that parameters must be individual float values</span>
<span class="sd">                    function_params=List(</span>
<span class="sd">                        [</span>
<span class="sd">                            self.swc.K1,</span>
<span class="sd">                            self.swc.K2,</span>
<span class="sd">                            self.swc.KW,</span>
<span class="sd">                            self.swc.KB,</span>
<span class="sd">                            self.swc.boron,</span>
<span class="sd">                            self.swc.hplus,</span>
<span class="sd">                        ]</span>
<span class="sd">                    ),</span>
<span class="sd">                    register=rh # reservoir_handle to register with.</span>

<span class="sd">                )</span>

<span class="sd">        the dict keys of vr_datafields will be used to create alias</span>
<span class="sd">        names which can be used to access the respective variable</span>


<span class="sd">    The general template for a user defined function is a follows:</span>

<span class="sd">    # @njit Add the njit decorator if you plan to use the numba solver</span>
<span class="sd">    def calc_carbonates(i: int, input_data: List, vr_data: List, params: List) -&gt; None:</span>
<span class="sd">        # i = index of current timestep</span>
<span class="sd">        # input_data = List of np.arrays, typically data from other Reservoirs</span>
<span class="sd">        # vr_data = List of np.arrays created during instance creation (i.e. the vr data)</span>
<span class="sd">        # params = List of float values (at least one!)</span>

<span class="sd">        pass</span>

<span class="sd">    return</span>

<span class="sd">    Note that this function should not return any values, and that all input fields must have</span>
<span class="sd">    at least one entry!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The original class will calculate delta and concentration from mass</span>
<span class="sd">        an d and h and l. Since we want to use this class without a</span>
<span class="sd">        priory knowledge of how the reservoir arrays are being used we</span>
<span class="sd">        overwrite the data generated during initialization with the</span>
<span class="sd">        values provided in the keywords</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">GenericFunction</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;vr_datafields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_input_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;alias_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;return_values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;r_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
            <span class="s2">&quot;r_d&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># initialize data fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
            <span class="n">r_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r_s</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_input_data</span><span class="p">,</span>
            <span class="n">vr_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span>
            <span class="n">function_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span>
            <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ftype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># add the function handle to the list of function to be executed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lpc_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># print(f&quot;added {self.name} to lvr 2&quot;)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_alialises</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register  alialises for each vr_datafield&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span><span class="p">):</span>
            <span class="c1"># print(f&quot;{a} = {self.vr_data[i][0]}&quot;)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">        VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">        when parameters have to reference other virtual reservoirs</span>
<span class="sd">        which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">        a circular reference.</span>

<span class="sd">        Example::</span>

<span class="sd">        VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;function_input_data, function_params&quot;</span><span class="p">]</span>
        <span class="c1"># loop over provided kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;you can only change function_input_data, or function_params&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reset_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy the last value to the first position so that we can restart the computation&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="o">-</span><span class="mi">2</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">reset_stride</span><span class="p">]),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__merge_temp_results__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Once all iterations are done, replace the data fields</span>
<span class="sd">        with the saved values</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;merging {self.full_name} with whith len of vrd= {len(self.vrd_0)}&quot;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># update aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>
        <span class="c1"># print(f&quot;new length = {len(self.vr_data[0])}&quot;)</span>

    <span class="k">def</span> <span class="nf">__read_state__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;read virtual reservoir data from csv-file into a dataframe</span>

<span class="sd">        The CSV file must have the following columns</span>

<span class="sd">        Model Time     t</span>
<span class="sd">        X1</span>
<span class="sd">        X2</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_vr_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/state_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading state for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># read csv file into dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span>
        <span class="c1"># print(f&quot;reading from {fn}&quot;)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">headers</span><span class="p">):</span>
            <span class="c1"># first column is time</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># print(f&quot;i = {i}, header = {n}, data = {df.iloc[-3:, i]}&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:,</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__sub_sample_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;There is usually no need to keep more than a thousand data points</span>
<span class="sd">        so we subsample the results before saving, or processing them</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># print(f&quot;subsampling {self.fullname}&quot;)</span>

        <span class="n">new</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>
            <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span> <span class="o">=</span> <span class="n">new</span>
        <span class="c1"># update aliases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__write_data__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To be called by write_data and save_state&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># model handle</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span>  <span class="c1"># reservoir name</span>
        <span class="n">mn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">n</span>  <span class="c1"># model name</span>
        <span class="n">mtu</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="si">:</span><span class="s2">~P</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">mn</span><span class="si">}</span><span class="s2">_vr_</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">rn</span><span class="si">}</span><span class="s2">.csv&quot;</span>  <span class="c1"># file name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model register keyword must be &#39;None&#39;/&#39;local&#39; not </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">()</span>

        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> Time [</span><span class="si">{</span><span class="n">mtu</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>  <span class="c1"># time</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;X</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">df</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">stride</span><span class="p">]</span>

        <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>
</pre></div>

        </details>

            <div class="docstring"><p>This class can be used to implement user provided functions. The
data inside a VR_no_set instance will only change in response to a
user provided function but will otherwise remain unaffected. That is,
it is up to the user provided function to manage changes in reponse to
external fluxes. A VR_no_set is declared in the following way</p>

<pre><code>ExternalCode(
            name="cs",     # instance name
            species=CO2,   # species, must be given
            # The next line defines the number of datafields and their default values

            data which will be computed by this function
            provide alias name and default value
            vr_datafields :dict ={"Hplus": self.swc.hplus,
                                  "Beta": 0.0},

            function=calc_carbonates, # function reference, see below
            # A numba types List of one ore more np.arrays which are used
            # as input values for the user provided function
            function_input_data=List([self.DIC.c, self.TA.c]),

            # A numba types List of float parameters.
            alias_list = ["H", "CA", "HCO3", "CO3", "CO2aq"]
            # Note that parameters must be individual float values
            function_params=List(
                [
                    self.swc.K1,
                    self.swc.K2,
                    self.swc.KW,
                    self.swc.KB,
                    self.swc.boron,
                    self.swc.hplus,
                ]
            ),
            register=rh # reservoir_handle to register with.

        )

the dict keys of vr_datafields will be used to create alias
names which can be used to access the respective variable
</code></pre>

<p>The general template for a user defined function is a follows:</p>

<h1 id="njit-add-the-njit-decorator-if-you-plan-to-use-the-numba-solver">@njit Add the njit decorator if you plan to use the numba solver</h1>

<p>def calc_carbonates(i: int, input_data: List, vr_data: List, params: List) -> None:
    # i = index of current timestep
    # input_data = List of np.arrays, typically data from other Reservoirs
    # vr_data = List of np.arrays created during instance creation (i.e. the vr data)
    # params = List of float values (at least one!)</p>

<pre><code>pass
</code></pre>

<p>return</p>

<p>Note that this function should not return any values, and that all input fields must have
at least one entry!</p>
</div>


                            <div id="ExternalCode.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalCode.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ExternalCode</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The original class will calculate delta and concentration from mass</span>
<span class="sd">        an d and h and l. Since we want to use this class without a</span>
<span class="sd">        priory knowledge of how the reservoir arrays are being used we</span>
<span class="sd">        overwrite the data generated during initialization with the</span>
<span class="sd">        values provided in the keywords</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ConnectionGroup</span><span class="p">,</span>
            <span class="n">GenericFunction</span><span class="p">,</span>
            <span class="n">Species</span><span class="p">,</span>
            <span class="n">SourceGroup</span><span class="p">,</span>
            <span class="n">SinkGroup</span><span class="p">,</span>
            <span class="n">ReservoirGroup</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="kn">from</span> <span class="nn">numba.typed</span> <span class="kn">import</span> <span class="n">List</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;volume&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;vr_datafields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_input_data&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function_params&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;alias_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ftype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;ref_flux&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;return_values&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">)],</span>
            <span class="s2">&quot;r_s&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
            <span class="s2">&quot;r_d&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">e</span><span class="o">.</span><span class="n">mass_unit</span>  <span class="c1"># massunit xxxx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span>

        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">/l]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add this reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># initialize data fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span> <span class="o">=</span> <span class="n">List</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_datafields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
            <span class="n">r_s</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r_s</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">input_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_input_data</span><span class="p">,</span>
            <span class="n">vr_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">,</span>
            <span class="n">function_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function_params</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span>
            <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ftype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># add the function handle to the list of function to be executed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lpc_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># print(f&quot;added {self.name} to lvr 2&quot;)</span>

        <span class="c1"># create temporary memory if we use multiple solver iterations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vrd_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_alialises</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>The original class will calculate delta and concentration from mass
an d and h and l. Since we want to use this class without a
priory knowledge of how the reservoir arrays are being used we
overwrite the data generated during initialization with the
values provided in the keywords</p>
</div>


                            </div>
                            <div id="ExternalCode.create_alialises" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalCode.create_alialises">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">create_alialises</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">create_alialises</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register  alialises for each vr_datafield&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alias_list</span><span class="p">):</span>
            <span class="c1"># print(f&quot;{a} = {self.vr_data[i][0]}&quot;)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vr_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>

        </details>

            <div class="docstring"><p>Register  alialises for each vr_datafield</p>
</div>


                            </div>
                            <div id="ExternalCode.append" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalCode.append">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">append</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">        VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">        when parameters have to reference other virtual reservoirs</span>
<span class="sd">        which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">        a circular reference.</span>

<span class="sd">        Example::</span>

<span class="sd">        VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;function_input_data, function_params&quot;</span><span class="p">]</span>
        <span class="c1"># loop over provided kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;you can only change function_input_data, or function_params&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This method allows to update GenericFunction parameters after the
VirtualReservoir has been initialized. This is most useful
when parameters have to reference other virtual reservoirs
which do not yet exist, e.g., when two virtual reservoirs have
a circular reference.</p>

<p>Example::</p>

<p>VR.update(a1=new_parameter, a2=new_parameter)</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></dt>
                                <dd id="ExternalCode.get_process_args" class="function"><a href="esbmtk.html#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="ExternalCode.info" class="function"><a href="esbmtk.html#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ExternalCode.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="VirtualReservoir_no_set">
                                <div class="attr class">
        <a class="headerlink" href="#VirtualReservoir_no_set">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">VirtualReservoir_no_set</span><wbr>(<span class="base"><a href="#ExternalCode">ExternalCode</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">VirtualReservoir_no_set</span><span class="p">(</span><span class="n">ExternalCode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias to ensure backwards compatibility&quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>Alias to ensure backwards compatibility</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#ExternalCode">ExternalCode</a></dt>
                                <dd id="VirtualReservoir_no_set.__init__" class="function"><a href="#ExternalCode.__init__">ExternalCode</a></dd>
                <dd id="VirtualReservoir_no_set.create_alialises" class="function"><a href="#ExternalCode.create_alialises">create_alialises</a></dd>
                <dd id="VirtualReservoir_no_set.append" class="function"><a href="#ExternalCode.append">append</a></dd>

            </div>
            <div><dt><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></dt>
                                <dd id="VirtualReservoir_no_set.get_process_args" class="function"><a href="esbmtk.html#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="VirtualReservoir_no_set.info" class="function"><a href="esbmtk.html#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="VirtualReservoir_no_set.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="VirtualReservoir">
                                <div class="attr class">
        <a class="headerlink" href="#VirtualReservoir">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">VirtualReservoir</span><wbr>(<span class="base"><a href="esbmtk.html#Reservoir">esbmtk.esbmtk.Reservoir</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">VirtualReservoir</span><span class="p">(</span><span class="n">Reservoir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A virtual reservoir. Unlike regular reservoirs, the mass of a</span>
<span class="sd">    virtual reservoir depends entirely on the return value of a function.</span>

<span class="sd">    Example::</span>

<span class="sd">    VirtualReservoir(name=&quot;foo&quot;,</span>
<span class="sd">                    volume=&quot;10 liter&quot;,</span>
<span class="sd">                    concentration=&quot;1 mmol&quot;,</span>
<span class="sd">                    species=  ,</span>
<span class="sd">                    function=bar,</span>
<span class="sd">                    a1 to a3 =  to 3optional function arguments,</span>
<span class="sd">                    display_precision = number, optional, inherited from Model,</span>
<span class="sd">                    )</span>

<span class="sd">    the concentration argument will be used to initialize the reservoir and</span>
<span class="sd">    to determine the display units.</span>

<span class="sd">    The function definition follows the GenericFunction class.</span>
<span class="sd">    which takes a generic function and up to 6 optional</span>
<span class="sd">    function arguments, and will replace the mass value(s) of the</span>
<span class="sd">    given reservoirs with whatever the function calculates. This is</span>
<span class="sd">    particularly useful e.g., to calculate the pH of a given reservoir</span>
<span class="sd">    as function of e.g., Alkalinity and DIC.</span>
<span class="sd">    Parameters:</span>
<span class="sd">     - name = name of process,</span>
<span class="sd">     - act_on = name of a reservoir this process will act upon</span>
<span class="sd">     - function  = a function reference</span>
<span class="sd">     - a1 to a3 function arguments</span>

<span class="sd">    In order to be compatible with the numba solver, a1 and a2 must be</span>
<span class="sd">    an array of 1-D numpy.arrays i.e., [m, l, h, c]. The array can have</span>
<span class="sd">    any number of arrays though. a3 must be single array (or list).</span>
<span class="sd">    The a3 array must be passed as List([...]), and List must be imported as</span>

<span class="sd">    from numba.typed import List</span>


<span class="sd">    The function must return a list of numbers which correspond to the</span>
<span class="sd">    data which describe a reservoir i.e., mass, light isotope, heavy</span>
<span class="sd">    isotope, delta, and concentration</span>

<span class="sd">    In order to use this function we need first declare a function we plan to</span>
<span class="sd">    use with the generic function process. This function needs to follow this</span>
<span class="sd">    template::</span>

<span class="sd">        def my_func(i, a1, a2, a3) -&gt; tuple:</span>
<span class="sd">            #</span>
<span class="sd">            # i = index of the current timestep</span>
<span class="sd">            # a1 to a3 =  optional function parameter. These must be present,</span>
<span class="sd">            # even if your function will not use it See above for details</span>

<span class="sd">            # calc some stuff and return it as</span>

<span class="sd">            return [m, l, h, d, c] # where m= mass, and l &amp; h are the respective</span>
<span class="sd">                                   # isotopes. d denotes the delta value and</span>
<span class="sd">                                   # c the concentration</span>
<span class="sd">                                   # Use dummy value as necessary.</span>

<span class="sd">    This class provides an update method to resolve cases where e.g., two virtual</span>
<span class="sd">    reservoirs have a circular reference. See the documentation of update().</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__aux_inits__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;We us the regular init methods of the Reservoir Class, and extend it in this method&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="n">GenericFunction</span>

        <span class="c1"># if self.register != &quot;None&quot;:</span>
        <span class="c1">#    self.full_name = f&quot;{self.full_name}.{self.name}&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">_generic_function&quot;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gfh</span> <span class="o">=</span> <span class="n">GenericFunction</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="n">a1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span>
            <span class="n">a2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span>
            <span class="n">a3</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a3</span><span class="p">,</span>
            <span class="n">a4</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a4</span><span class="p">,</span>
            <span class="n">act_on</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># we only depend on the above function. so no need</span>
        <span class="c1"># to be in the reservoir list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># but lets keep track of  virtual reservoir in lvr.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lvr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># print(f&quot;added {self.name} to lvr 2&quot;)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">        VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">        when parameters have to reference other virtual reservoirs</span>
<span class="sd">        which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">        a circular reference.</span>

<span class="sd">        Example::</span>

<span class="sd">        VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;a4&quot;</span><span class="p">,</span> <span class="s2">&quot;a5&quot;</span><span class="p">,</span> <span class="s2">&quot;a6&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span>
        <span class="c1"># loop over provided kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can only change a1 to a6&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update self</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update function</span>
</pre></div>

        </details>

            <div class="docstring"><p>A virtual reservoir. Unlike regular reservoirs, the mass of a
virtual reservoir depends entirely on the return value of a function.</p>

<p>Example::</p>

<p>VirtualReservoir(name="foo",
                volume="10 liter",
                concentration="1 mmol",
                species=  ,
                function=bar,
                a1 to a3 =  to 3optional function arguments,
                display_precision = number, optional, inherited from Model,
                )</p>

<p>the concentration argument will be used to initialize the reservoir and
to determine the display units.</p>

<p>The function definition follows the GenericFunction class.
which takes a generic function and up to 6 optional
function arguments, and will replace the mass value(s) of the
given reservoirs with whatever the function calculates. This is
particularly useful e.g., to calculate the pH of a given reservoir
as function of e.g., Alkalinity and DIC.
Parameters:</p>

<ul>
<li>name = name of process,</li>
<li>act_on = name of a reservoir this process will act upon</li>
<li>function  = a function reference</li>
<li>a1 to a3 function arguments</li>
</ul>

<p>In order to be compatible with the numba solver, a1 and a2 must be
an array of 1-D numpy.arrays i.e., [m, l, h, c]. The array can have
any number of arrays though. a3 must be single array (or list).
The a3 array must be passed as List([...]), and List must be imported as</p>

<p>from numba.typed import List</p>

<p>The function must return a list of numbers which correspond to the
data which describe a reservoir i.e., mass, light isotope, heavy
isotope, delta, and concentration</p>

<p>In order to use this function we need first declare a function we plan to
use with the generic function process. This function needs to follow this
template::</p>

<pre><code>def my_func(i, a1, a2, a3) -&gt; tuple:
    #
    # i = index of the current timestep
    # a1 to a3 =  optional function parameter. These must be present,
    # even if your function will not use it See above for details

    # calc some stuff and return it as

    return [m, l, h, d, c] # where m= mass, and l &amp; h are the respective
                           # isotopes. d denotes the delta value and
                           # c the concentration
                           # Use dummy value as necessary.
</code></pre>

<p>This class provides an update method to resolve cases where e.g., two virtual
reservoirs have a circular reference. See the documentation of update().</p>
</div>


                            <div id="VirtualReservoir.update" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#VirtualReservoir.update">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update</span><span class="signature">(self, **kwargs) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;This method allows to update GenericFunction parameters after the</span>
<span class="sd">        VirtualReservoir has been initialized. This is most useful</span>
<span class="sd">        when parameters have to reference other virtual reservoirs</span>
<span class="sd">        which do not yet exist, e.g., when two virtual reservoirs have</span>
<span class="sd">        a circular reference.</span>

<span class="sd">        Example::</span>

<span class="sd">        VR.update(a1=new_parameter, a2=new_parameter)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">allowed_keys</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="s2">&quot;a2&quot;</span><span class="p">,</span> <span class="s2">&quot;a3&quot;</span><span class="p">,</span> <span class="s2">&quot;a4&quot;</span><span class="p">,</span> <span class="s2">&quot;a5&quot;</span><span class="p">,</span> <span class="s2">&quot;a6&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">]</span>
        <span class="c1"># loop over provided kwargs</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can only change a1 to a6&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update self</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfh</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># update function</span>
</pre></div>

        </details>

            <div class="docstring"><p>This method allows to update GenericFunction parameters after the
VirtualReservoir has been initialized. This is most useful
when parameters have to reference other virtual reservoirs
which do not yet exist, e.g., when two virtual reservoirs have
a circular reference.</p>

<p>Example::</p>

<p>VR.update(a1=new_parameter, a2=new_parameter)</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#Reservoir">esbmtk.esbmtk.Reservoir</a></dt>
                                <dd id="VirtualReservoir.__init__" class="function"><a href="esbmtk.html#Reservoir.__init__">Reservoir</a></dd>
                <dd id="VirtualReservoir.concentration" class="variable"><a href="esbmtk.html#Reservoir.concentration">concentration</a></dd>
                <dd id="VirtualReservoir.delta" class="variable"><a href="esbmtk.html#Reservoir.delta">delta</a></dd>
                <dd id="VirtualReservoir.mass" class="variable"><a href="esbmtk.html#Reservoir.mass">mass</a></dd>

            </div>
            <div><dt><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></dt>
                                <dd id="VirtualReservoir.get_process_args" class="function"><a href="esbmtk.html#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="VirtualReservoir.info" class="function"><a href="esbmtk.html#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="VirtualReservoir.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="GasReservoir">
                                <div class="attr class">
        <a class="headerlink" href="#GasReservoir">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">GasReservoir</span><wbr>(<span class="base"><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">GasReservoir</span><span class="p">(</span><span class="n">ReservoirBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object holds reservoir specific information similar to the Reservoir class</span>

<span class="sd">          Example::</span>

<span class="sd">                  Reservoir(name = &quot;foo&quot;,     # Name of reservoir</span>
<span class="sd">                            species = CO2,    # Species handle</span>
<span class="sd">                            delta = 20,       # initial delta - optional (defaults  to 0)</span>
<span class="sd">                            reservoir_mass = quantity # total mass of all gases</span>
<span class="sd">                                             defaults to 1.833E20 mol</span>
<span class="sd">                            species_ppm =  number # concentration in ppm</span>
<span class="sd">                            plot = &quot;yes&quot;/&quot;no&quot;, defaults to yes</span>
<span class="sd">                            plot_transform_c = a function reference, optional (see below)</span>
<span class="sd">                            legend_left = str, optional, useful for plot transform</span>
<span class="sd">                            display_precision = number, optional, inherited from Model</span>
<span class="sd">                            register = optional, use to register with Reservoir Group</span>
<span class="sd">                            isotopes = True/False otherwise use Model.m_type</span>
<span class="sd">                            )</span>



<span class="sd">    Accesing Reservoir Data:</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    You can access the reservoir data as:</span>

<span class="sd">    - Name.m # species mass</span>
<span class="sd">    - Name.l # mass of light isotope</span>
<span class="sd">    - Name.d # species delta (only avaible after M.get_delta_values()</span>
<span class="sd">    - Name.c # partial pressure</span>
<span class="sd">    - Name.v # total gas mass</span>

<span class="sd">    Useful methods include:</span>

<span class="sd">    - Name.write_data() # save data to file</span>
<span class="sd">    - Name.info()   # info Reservoir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir_mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1.833E20 mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;species_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species_ppm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># setup base data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">)</span>

        <span class="c1"># not sure this universally true but it works for carbon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_mass</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;mol&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>

        <span class="c1"># we use the existing approach to calculate concentration</span>
        <span class="c1"># which will divide species_mass/volume.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1">#    Q_(self.species_mass).magnitude / self.species_ppm.to(&quot;dimensionless&quot;)</span>
        <span class="c1"># ).magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>  <span class="c1"># massunit xxxx</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># initialize vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_mass</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="c1"># initialize concentration vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
        <span class="c1"># isotope mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="c1"># delta of reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># mass of atmosphere</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add fthis reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__set_with_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># self.v[i]: float = self.v[i - 1] + value[0]</span>
        <span class="c1"># self.c[i]: float = self.m[i] / self.v[i]  # update concentration</span>
        <span class="c1"># self.h[i]: float = value[2]</span>
        <span class="c1"># self.d[i]: float = get_delta(self.l[i], self.h[i], self.sp.r)</span>

    <span class="k">def</span> <span class="nf">__set_without_isotopes__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;write data by index&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># self.c[i]: float = self.m[i] / self.v[i]  # update concentration</span>
        <span class="c1"># self.v[i]: float = self.v[i - 1] + value[0]</span>
</pre></div>

        </details>

            <div class="docstring"><p>This object holds reservoir specific information similar to the Reservoir class</p>

<pre><code>  Example::

          Reservoir(name = "foo",     # Name of reservoir
                    species = CO2,    # Species handle
                    delta = 20,       # initial delta - optional (defaults  to 0)
                    reservoir_mass = quantity # total mass of all gases
                                     defaults to 1.833E20 mol
                    species_ppm =  number # concentration in ppm
                    plot = "yes"/"no", defaults to yes
                    plot_transform_c = a function reference, optional (see below)
                    legend_left = str, optional, useful for plot transform
                    display_precision = number, optional, inherited from Model
                    register = optional, use to register with Reservoir Group
                    isotopes = True/False otherwise use Model.m_type
                    )
</code></pre>

<p>Accesing Reservoir Data:
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~~</p>

<p>You can access the reservoir data as:</p>

<ul>
<li>Name.m # species mass</li>
<li>Name.l # mass of light isotope</li>
<li>Name.d # species delta (only avaible after M.get_delta_values()</li>
<li>Name.c # partial pressure</li>
<li>Name.v # total gas mass</li>
</ul>

<p>Useful methods include:</p>

<ul>
<li>Name.write_data() # save data to file</li>
<li>Name.info()   # info Reservoir</li>
</ul>
</div>


                            <div id="GasReservoir.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#GasReservoir.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">GasReservoir</span><span class="signature">(**kwargs)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initialize a reservoir.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Species</span><span class="p">,</span> <span class="n">Model</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Species</span><span class="p">)],</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir_mass&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1.833E20 mol&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;species_ppm&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;legend_left&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">)],</span>
            <span class="s2">&quot;full_name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)],</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)],</span>
            <span class="s2">&quot;rtype&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;regular&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">,</span>
            <span class="s2">&quot;species_ppm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_legacy_names__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># setup base data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">)</span>

        <span class="c1"># not sure this universally true but it works for carbon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_mass</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_ppm</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;mol&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_as</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plt_units</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>

        <span class="c1"># we use the existing approach to calculate concentration</span>
        <span class="c1"># which will divide species_mass/volume.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir_mass</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="c1">#    Q_(self.species_mass).magnitude / self.species_ppm.to(&quot;dimensionless&quot;)</span>
        <span class="c1"># ).magnitude</span>

        <span class="c1"># This should probably be species specific?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ppm&quot;</span>  <span class="c1"># massunit xxxx</span>

        <span class="c1"># save the unit which was provided by the user for display purposes</span>
        <span class="c1"># left y-axis label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lm</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="c1"># initialize vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_mass</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="c1"># initialize concentration vector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
        <span class="c1"># isotope mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">get_l_mass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="c1"># delta of reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>  <span class="c1"># mass of atmosphere</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">number_of_solving_iterations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># add fthis reservoir to the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reservoir type object list</span>
        <span class="c1"># register instance name in global name space</span>

        <span class="c1"># register this group object in the global namespace</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

        <span class="c1"># decide which setitem functions to use</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_with_isotopes__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_data__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__set_without_isotopes__</span>

        <span class="c1"># any auxilliary init - normally empty, but we use it here to extend the</span>
        <span class="c1"># reservoir class in virtual reservoirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__aux_inits__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>

        </details>

            <div class="docstring"><p>Initialize a reservoir.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk.html#ReservoirBase">esbmtk.esbmtk.ReservoirBase</a></dt>
                                <dd id="GasReservoir.get_process_args" class="function"><a href="esbmtk.html#ReservoirBase.get_process_args">get_process_args</a></dd>
                <dd id="GasReservoir.info" class="function"><a href="esbmtk.html#ReservoirBase.info">info</a></dd>

            </div>
            <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="GasReservoir.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ExternalData">
                                <div class="attr class">
        <a class="headerlink" href="#ExternalData">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ExternalData</span><wbr>(<span class="base"><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ExternalData</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Instances of this class hold external X/Y data which can be associated with</span>
<span class="sd">    a reservoir.</span>

<span class="sd">    Example::</span>

<span class="sd">           ExternalData(name       = &quot;Name&quot;</span>
<span class="sd">                        filename   = &quot;filename&quot;,</span>
<span class="sd">                        legend     = &quot;label&quot;,</span>
<span class="sd">                        offset     = &quot;0 yrs&quot;,</span>
<span class="sd">                        reservoir  = reservoir_handle,</span>
<span class="sd">                        scale      = scaling factor, optional</span>
<span class="sd">                        display_precision = number, optional, inherited from Model</span>
<span class="sd">                        convert_to = optional, see below</span>
<span class="sd">                       )</span>

<span class="sd">    The data must exist as CSV file, where the first column contains</span>
<span class="sd">    the X-values, and the second column contains the Y-values.</span>

<span class="sd">    The x-values must be time and specify the time units in the header between square brackets</span>
<span class="sd">    They will be mapped into the model time units.</span>

<span class="sd">    The y-values can be any data, but the user must take care that they match the model units</span>
<span class="sd">    defined in the model instance. So your data file mujst look like this</span>

<span class="sd">    Time [years], Data [units], Data [units]</span>
<span class="sd">    1, 12</span>
<span class="sd">    2, 13</span>

<span class="sd">    By convention, the secon column should contaain the same type of</span>
<span class="sd">    data as the reservoir (i.e., a concentration), whereas the third</span>
<span class="sd">    column contain isotope delta values. Columns with no data should</span>
<span class="sd">    be left empty (and have no header!) The optional scale argument, will</span>
<span class="sd">    only affect the Y-col data, not the isotope data</span>

<span class="sd">    The column headers are only used for the time or concentration</span>
<span class="sd">    data conversion, and are ignored by the default plotting</span>
<span class="sd">    methods, but they are available as self.xh,yh</span>

<span class="sd">    The file must exist in the local working directory.</span>

<span class="sd">    the convert_to keyword can be used to force a specific conversion.</span>
<span class="sd">    The default is to convert into the model concentration units.</span>

<span class="sd">    Methods:</span>
<span class="sd">      - name.plot()</span>

<span class="sd">    Data:</span>
<span class="sd">      - name.x</span>
<span class="sd">      - name.y</span>
<span class="sd">      - name.df = dataframe as read from csv file</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span><span class="p">)],</span>
            <span class="s2">&quot;convert_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># string =  name of this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="c1"># string = filename of data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># keep track of this instance</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># read file</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># test of we have 3 columns</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSV file must have 3 columns&quot;</span><span class="p">)</span>

        <span class="c1"># print(f&quot;Model = {self.mo.full_name}, t_unit = {self.mo.t_unit}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># get unit information</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">get_string_between_brackets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">get_string_between_brackets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">yq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yq = </span><span class="si">{</span><span class="n">yq</span><span class="si">}</span><span class="s2">, cvt= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span><span class="si">}</span><span class="s2">, ys = </span><span class="si">{</span><span class="n">ys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># scale input data into model  units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">ys</span>

        <span class="c1"># map into model space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># check if z-data is present</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># zh = self.df.columns[2]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__register__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register this dataset with a flux or reservoir. This will have the</span>
<span class="sd">        effect that the data will be printed together with the model</span>
<span class="sd">        results for this reservoir</span>

<span class="sd">        Example::</span>

<span class="sd">        ExternalData.register(Reservoir)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>  <span class="c1"># reser handle we associate with</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__interpolate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Interpolate the input data with a resolution of dt across the model</span>
<span class="sd">        domain The first and last data point must coincide with the</span>
<span class="sd">        model start and end time. In other words, this method will not</span>
<span class="sd">        patch data at the end points.</span>

<span class="sd">        This will replace the original values of name.x and name.y. However</span>
<span class="sd">        the original data remains accessible as name.df</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">time</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Interpolation requires that the time domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;is equal or greater than the model domain&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;data t(0) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;model t(0) = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, tmax = </span><span class="si">{</span><span class="n">xi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xi</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the data and save a pdf</span>

<span class="sd">        Example::</span>

<span class="sd">                ExternalData.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yh</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Instances of this class hold external X/Y data which can be associated with
a reservoir.</p>

<p>Example::</p>

<pre><code>   ExternalData(name       = "Name"
                filename   = "filename",
                legend     = "label",
                offset     = "0 yrs",
                reservoir  = reservoir_handle,
                scale      = scaling factor, optional
                display_precision = number, optional, inherited from Model
                convert_to = optional, see below
               )
</code></pre>

<p>The data must exist as CSV file, where the first column contains
the X-values, and the second column contains the Y-values.</p>

<p>The x-values must be time and specify the time units in the header between square brackets
They will be mapped into the model time units.</p>

<p>The y-values can be any data, but the user must take care that they match the model units
defined in the model instance. So your data file mujst look like this</p>

<p>Time [years], Data [units], Data [units]
1, 12
2, 13</p>

<p>By convention, the secon column should contaain the same type of
data as the reservoir (i.e., a concentration), whereas the third
column contain isotope delta values. Columns with no data should
be left empty (and have no header!) The optional scale argument, will
only affect the Y-col data, not the isotope data</p>

<p>The column headers are only used for the time or concentration
data conversion, and are ignored by the default plotting
methods, but they are available as self.xh,yh</p>

<p>The file must exist in the local working directory.</p>

<p>the convert_to keyword can be used to force a specific conversion.
The default is to convert into the model concentration units.</p>

<p>Methods:</p>

<ul>
<li>name.plot()</li>
</ul>

<p>Data:</p>

<ul>
<li>name.x</li>
<li>name.y</li>
<li>name.df = dataframe as read from csv file</li>
</ul>
</div>


                            <div id="ExternalData.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalData.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ExternalData</span><span class="signature">(**kwargs: dict)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>

        <span class="kn">from</span> <span class="nn">esbmtk</span> <span class="kn">import</span> <span class="n">Q_</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span>

        <span class="c1"># dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;reservoir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span><span class="p">)],</span>
            <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0 yrs&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;display_precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="n">DataField</span><span class="p">)],</span>
            <span class="s2">&quot;convert_to&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">)],</span>
            <span class="s2">&quot;plot_transform_c&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;None&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">col</span><span class="o">.</span><span class="n">Callable</span><span class="p">)],</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="s2">&quot;legend&quot;</span><span class="p">,</span> <span class="s2">&quot;reservoir&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_keyword_variables__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># legacy names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># string =  name of this instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span>  <span class="c1"># string = filename of data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">mo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">led</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># keep track of this instance</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">display_precision</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">):</span>  <span class="c1"># check if the file is actually there</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>  <span class="c1"># read file</span>

        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># test of we have 3 columns</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;CSV file must have 3 columns&quot;</span><span class="p">)</span>

        <span class="c1"># print(f&quot;Model = {self.mo.full_name}, t_unit = {self.mo.t_unit}&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="c1"># get unit information</span>
        <span class="n">xq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">get_string_between_brackets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">yq</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">get_string_between_brackets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">xq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">t_unit</span><span class="p">)</span><span class="o">.</span><span class="n">magnitude</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">yq</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_q</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;yq = </span><span class="si">{</span><span class="n">yq</span><span class="si">}</span><span class="s2">, cvt= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">convert_to</span><span class="si">}</span><span class="s2">, ys = </span><span class="si">{</span><span class="n">ys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># scale input data into model  units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">xs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">ys</span>

        <span class="c1"># map into model space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span>

        <span class="c1"># test for plt_transform</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_transform_c</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Plot transform must be a function&quot;</span><span class="p">)</span>

        <span class="c1"># check if z-data is present</span>
        <span class="k">if</span> <span class="n">ncols</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># zh = self.df.columns[2]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># register with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name_new__</span><span class="p">()</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ExternalData.plot" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ExternalData.plot">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">plot</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Plot the data and save a pdf</span>

<span class="sd">        Example::</span>

<span class="sd">                ExternalData.plot()</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">legend</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xh</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yh</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Plot the data and save a pdf</p>

<p>Example::</p>

<pre><code>    <a href="#ExternalData.plot">ExternalData.plot()</a>
</code></pre>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="esbmtk_base.html#esbmtkBase">esbmtk.esbmtk_base.esbmtkBase</a></dt>
                                <dd id="ExternalData.info" class="function"><a href="esbmtk_base.html#esbmtkBase.info">info</a></dd>
                <dd id="ExternalData.ensure_q" class="function"><a href="esbmtk_base.html#esbmtkBase.ensure_q">ensure_q</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>