<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 6.4.4" />
    <title>esbmtk.connections API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2264%22%20height%3D%2264%22%20viewBox%3D%2244.5%202.5%2015%2015%22%3E%3Cpath%20d%3D%22M49.351%2021.041c-.233-.721-.546-2.408-.772-4.076-.042-.09-.067-.187-.046-.288-.166-1.347-.277-2.625-.241-3.351-1.378-1.008-2.271-2.586-2.271-4.362%200-.976.272-1.935.788-2.774.057-.094.122-.18.184-.268-.033-.167-.052-.339-.052-.516%200-1.477%201.202-2.679%202.679-2.679.791%200%201.496.352%201.987.9a6.3%206.3%200%200%201%201.001.029c.492-.564%201.207-.929%202.012-.929%201.477%200%202.679%201.202%202.679%202.679a2.65%202.65%200%200%201-.269%201.148c.383.747.595%201.572.595%202.41%200%202.311-1.507%204.29-3.635%205.107.037.699.147%202.27.423%203.294l.137.461c.156%202.136-4.612%205.166-5.199%203.215zm.127-4.919a4.78%204.78%200%200%200%20.775-.584c-.172-.115-.505-.254-.88-.378zm.331%202.302l.828-.502c-.202-.143-.576-.328-.984-.49zm.45%202.157l.701-.403c-.214-.115-.536-.249-.891-.376l.19.779zM49.13%204.141c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm.735-.389a1.15%201.15%200%200%201%20.314.783%201.16%201.16%200%200%201-1.162%201.162c-.457%200-.842-.27-1.032-.653-.026.117-.042.238-.042.362a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.843-.626-1.535-1.436-1.654zm3.076%201.654a1.68%201.68%200%200%200%201.679%201.679%201.68%201.68%200%200%200%201.679-1.679c0-.037-.009-.072-.011-.109-.21.3-.541.508-.935.508a1.16%201.16%200%200%201-1.162-1.162%201.14%201.14%200%200%201%20.474-.912c-.015%200-.03-.005-.045-.005-.926.001-1.679.754-1.679%201.68zm1.861-1.265c0%20.152.123.276.276.276s.275-.124.275-.276-.123-.276-.276-.276-.275.124-.275.276zm1.823%204.823c0-.52-.103-1.035-.288-1.52-.466.394-1.06.64-1.717.64-1.144%200-2.116-.725-2.499-1.738-.383%201.012-1.355%201.738-2.499%201.738-.867%200-1.631-.421-2.121-1.062-.307.605-.478%201.267-.478%201.942%200%202.486%202.153%204.51%204.801%204.51s4.801-2.023%204.801-4.51zm-3.032%209.156l-.146-.492c-.276-1.02-.395-2.457-.444-3.268a6.11%206.11%200%200%201-1.18.115%206.01%206.01%200%200%201-2.536-.562l.006.175c.802.215%201.848.612%202.021%201.25.079.295-.021.601-.274.837l-.598.501c.667.304%201.243.698%201.311%201.179.02.144.022.507-.393.787l-.564.365c1.285.521%201.361.96%201.381%201.126.018.142.011.496-.427.746l-.854.489c.064-1.19%201.985-2.585%202.697-3.248zM49.34%209.925c0-.667%201-.667%201%200%200%20.653.818%201.205%201.787%201.205s1.787-.552%201.787-1.205c0-.667%201-.667%201%200%200%201.216-1.25%202.205-2.787%202.205s-2.787-.989-2.787-2.205zm-.887-7.633c-.093.077-.205.114-.317.114a.5.5%200%200%201-.318-.886L49.183.397a.5.5%200%200%201%20.703.068.5.5%200%200%201-.069.703zm7.661-.065c-.086%200-.173-.022-.253-.068l-1.523-.893c-.575-.337-.069-1.2.506-.863l1.523.892a.5.5%200%200%201%20.179.685c-.094.158-.261.247-.432.247z%22%20fill%3D%22%233bb300%22/%3E%3C/svg%3E"/>


<style type="text/css">/*! * Bootstrap Reboot v5.0.0-beta1 (https://getbootstrap.com/) * Copyright 2011-2020 The Bootstrap Authors * Copyright 2011-2020 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}[tabindex="-1"]:focus:not(:focus-visible){outline:0!important}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus{outline:dotted 1px;outline:-webkit-focus-ring-color auto 5px}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
<style type="text/css">/*! pygments syntax highlighting */pre{line-height:125%;}td.linenos pre{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}span.linenos{color:#000000; background-color:#f0f0f0; padding-left:5px; padding-right:5px;}td.linenos pre.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}span.linenos.special{color:#000000; background-color:#ffffc0; padding-left:5px; padding-right:5px;}.pdoc .hll{background-color:#ffffcc}.pdoc{background:#f8f8f8;}.pdoc .c{color:#408080; font-style:italic}.pdoc .err{border:1px solid #FF0000}.pdoc .k{color:#008000; font-weight:bold}.pdoc .o{color:#666666}.pdoc .ch{color:#408080; font-style:italic}.pdoc .cm{color:#408080; font-style:italic}.pdoc .cp{color:#BC7A00}.pdoc .cpf{color:#408080; font-style:italic}.pdoc .c1{color:#408080; font-style:italic}.pdoc .cs{color:#408080; font-style:italic}.pdoc .gd{color:#A00000}.pdoc .ge{font-style:italic}.pdoc .gr{color:#FF0000}.pdoc .gh{color:#000080; font-weight:bold}.pdoc .gi{color:#00A000}.pdoc .go{color:#888888}.pdoc .gp{color:#000080; font-weight:bold}.pdoc .gs{font-weight:bold}.pdoc .gu{color:#800080; font-weight:bold}.pdoc .gt{color:#0044DD}.pdoc .kc{color:#008000; font-weight:bold}.pdoc .kd{color:#008000; font-weight:bold}.pdoc .kn{color:#008000; font-weight:bold}.pdoc .kp{color:#008000}.pdoc .kr{color:#008000; font-weight:bold}.pdoc .kt{color:#B00040}.pdoc .m{color:#666666}.pdoc .s{color:#BA2121}.pdoc .na{color:#7D9029}.pdoc .nb{color:#008000}.pdoc .nc{color:#0000FF; font-weight:bold}.pdoc .no{color:#880000}.pdoc .nd{color:#AA22FF}.pdoc .ni{color:#999999; font-weight:bold}.pdoc .ne{color:#D2413A; font-weight:bold}.pdoc .nf{color:#0000FF}.pdoc .nl{color:#A0A000}.pdoc .nn{color:#0000FF; font-weight:bold}.pdoc .nt{color:#008000; font-weight:bold}.pdoc .nv{color:#19177C}.pdoc .ow{color:#AA22FF; font-weight:bold}.pdoc .w{color:#bbbbbb}.pdoc .mb{color:#666666}.pdoc .mf{color:#666666}.pdoc .mh{color:#666666}.pdoc .mi{color:#666666}.pdoc .mo{color:#666666}.pdoc .sa{color:#BA2121}.pdoc .sb{color:#BA2121}.pdoc .sc{color:#BA2121}.pdoc .dl{color:#BA2121}.pdoc .sd{color:#BA2121; font-style:italic}.pdoc .s2{color:#BA2121}.pdoc .se{color:#BB6622; font-weight:bold}.pdoc .sh{color:#BA2121}.pdoc .si{color:#BB6688; font-weight:bold}.pdoc .sx{color:#008000}.pdoc .sr{color:#BB6688}.pdoc .s1{color:#BA2121}.pdoc .ss{color:#19177C}.pdoc .bp{color:#008000}.pdoc .fm{color:#0000FF}.pdoc .vc{color:#19177C}.pdoc .vg{color:#19177C}.pdoc .vi{color:#19177C}.pdoc .vm{color:#19177C}.pdoc .il{color:#666666}</style>
<style type="text/css">/*! pdoc */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f7f7f7;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}body{background-color:var(--pdoc-background);}html, body{width:100%;height:100%;}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main{padding:2rem 3vw;}.git-button{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}#navtoggle{display:none;}}#togglestate{display:none;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}html, main{scroll-behavior:smooth;}.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3, .pdoc h4{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{background-color:var(--code);border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{--shift:-40px;text-align:right;margin-top:var(--shift);margin-bottom:calc(0px - var(--shift));clear:both;filter:opacity(1);}.pdoc details:not([open]){height:0;overflow:visible;}.pdoc details > summary{font-size:.75rem;cursor:pointer;color:var(--muted);border-width:0;padding:0 .7em;display:inline-block;display:inline list-item;user-select:none;}.pdoc details > summary:focus{outline:0;}.pdoc details > div{margin-top:calc(0px - var(--shift) / 2);text-align:left;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:3rem;}.pdoc .docstring pre{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{color:var(--text);margin:1rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}</style>
</head>
<body>        <nav class="pdoc">
            <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
            <input id="togglestate" type="checkbox">
            <div>
                        <a class="pdoc-button module-list-button" href="../esbmtk.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                            &nbsp;esbmtk</a>




                    <h2>API Documentation</h2>
                        <ul class="memberlist">
            <li>
                    <a class="class" href="#Connect">Connect</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Connect.__init__">Connect</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.lkk">lkk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.lrk">lrk</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.lod">lod</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.influx">influx</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.outflux">outflux</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.mo">mo</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.r1">r1</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.r2">r2</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.lof">lof</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.lor">lor</a>
                        </li>
                        <li>
                                <a class="function" href="#Connect.update">update</a>
                        </li>
                        <li>
                                <a class="function" href="#Connect.get_species">get_species</a>
                        </li>
                        <li>
                                <a class="function" href="#Connect.info">info</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.alpha">alpha</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.rate">rate</a>
                        </li>
                        <li>
                                <a class="variable" href="#Connect.delta">delta</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Connection">Connection</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#ConnectionGroup">ConnectionGroup</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ConnectionGroup.__init__">ConnectionGroup</a>
                        </li>
                        <li>
                                <a class="variable" href="#ConnectionGroup.loc">loc</a>
                        </li>
                        <li>
                                <a class="function" href="#ConnectionGroup.update">update</a>
                        </li>
                        <li>
                                <a class="function" href="#ConnectionGroup.info">info</a>
                        </li>
                </ul>

            </li>
    </ul>


                    <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
                        built with <span class="visually-hidden">pdoc</span><img
                            alt="pdoc logo"
                            src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
                    </a>
            </div>
        </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../esbmtk.html">esbmtk</a>.connections    </h1>

                        <div class="docstring"><p><a href="">esbmtk.connections</a></p>

<p>Classes which handle the connections and fluxes between esbmtk objects
like Reservoirs, Sources, and Sinks.</p>

<p>esbmtk: A general purpose Earth Science box model toolkit
Copyright (C), 2020 Ulrich G. Wortmann</p>

<p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="https://www.gnu.org/licenses/">https://www.gnu.org/licenses/</a>.</p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">     esbmtk.connections</span>

<span class="sd">     Classes which handle the connections and fluxes between esbmtk objects</span>
<span class="sd">     like Reservoirs, Sources, and Sinks.</span>

<span class="sd">     esbmtk: A general purpose Earth Science box model toolkit</span>
<span class="sd">     Copyright (C), 2020 Ulrich G. Wortmann</span>

<span class="sd">     This program is free software: you can redistribute it and/or modify</span>
<span class="sd">     it under the terms of the GNU General Public License as published by</span>
<span class="sd">     the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">     (at your option) any later version.</span>

<span class="sd">     This program is distributed in the hope that it will be useful,</span>
<span class="sd">     but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">     GNU General Public License for more details.</span>

<span class="sd">     You should have received a copy of the GNU General Public License</span>
<span class="sd">     along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># from pint import UnitRegistry</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">nptyping</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">set_printoptions</span><span class="p">,</span> <span class="n">arange</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">interp</span><span class="p">,</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span><span class="p">,</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">builtins</span>

<span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">map_units</span>
<span class="kn">from</span> <span class="nn">.processes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.esbmtk</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">Connect</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two reservoirs connect to each other via at least one flux. This</span>
<span class="sd">     module creates the connecting flux and creates a connector object</span>
<span class="sd">     which stores all connection properties.</span>

<span class="sd">     For simple connections, the type flux type is derived implcitly from the specified parameters.</span>
<span class="sd">     For complex connections, the flux type must be set explicitly. See the examples below:</span>

<span class="sd">     Parameters:</span>
<span class="sd">         - name: A string which determines the name of this object. Optional, if not provided</span>
<span class="sd">           the connection name will be derived as &quot;C_Source_2_Sink&quot;</span>
<span class="sd">         - source: An object handle for a Source or Reservoir</span>
<span class="sd">         - sink: An object handle for a Sink or Reservoir</span>
<span class="sd">         - rate: A quantity (e.g., &quot;1 mol/s&quot;), optional</span>
<span class="sd">         - delta: The isotope ratio, optional</span>
<span class="sd">         - ref_reservoirs: Reservoir or flux reference</span>
<span class="sd">         - alpha: A fractionation factor, optional</span>
<span class="sd">         - id: A string wich will become part of the object name, optional</span>
<span class="sd">         - plot: &quot;yes&quot; or &quot;no&quot;, defaults to &quot;yes&quot;</span>
<span class="sd">         - signal: An object handle of signal, optional</span>
<span class="sd">         - pl: A list of process objects, optional</span>
<span class="sd">         - ctype: connection type, optional, this allows to scale a flux in response to other</span>
<span class="sd">           reservoirs and fluxes</span>
<span class="sd">         - bypass :str optional defaults to &quot;None&quot; see scale with flux</span>

<span class="sd">     Connection Types:</span>
<span class="sd">     -----------------</span>
<span class="sd">     Basic Connections (the advanced ones are below):</span>

<span class="sd">     - If both =rate= and =delta= are given, the flux is treated as a</span>
<span class="sd">        fixed flux with a given isotope ratio. This is usually the case for</span>
<span class="sd">        most source objects (they can still be affected by a signal, see</span>
<span class="sd">        above), but makes little sense for reservoirs and sinks.</span>

<span class="sd">     - If both the =rate= and =alpha= are given, the flux rate is fixed</span>
<span class="sd">       (subject to any signals), but the isotopic ratio of the output</span>
<span class="sd">       flux depends on the isotopic ratio of the upstream reservoir</span>
<span class="sd">       plus any isotopic fractionation specified by =alpha=. This is</span>
<span class="sd">       typically the case for fluxes which include an isotopic</span>
<span class="sd">       fractionation (i.e., pyrite burial). This combination is not</span>
<span class="sd">       particularly useful for source objects.</span>

<span class="sd">     - If the connection specifies only =delta= the flux is treated as a</span>
<span class="sd">       variable flux which is computed in such a way that the reservoir</span>
<span class="sd">       maintains steady state with respect to it&#39;s mass.</span>

<span class="sd">     - If the connection specifies only =rate= the flux is treated as a</span>
<span class="sd">       fixed flux which is computed in such a way that the reservoir</span>
<span class="sd">       maintains steady state with respect to it&#39;s isotope ratio.</span>

<span class="sd">     Examples of Basic Connections</span>
<span class="sd">     -----------------------------</span>

<span class="sd">     Connecting a Source to a Reservoir</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     Unless you use a Signal, a source typically provides a steady stream with a given isotope ratio (if used)</span>

<span class="sd">     Example::</span>

<span class="sd">        Connect(source =  Source,</span>
<span class="sd">                sink = downstrean reservoir,</span>
<span class="sd">                rate = &quot;1 mol/s&quot;,</span>
<span class="sd">                delta = optional,</span>
<span class="sd">                signal = optional, see the signal documentation)</span>

<span class="sd">     Connecting a Reservoir to Sink or another Reservoir</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     Here we can distinguish between cases where we use fixed flux, or a flux which reacts to in some way to the</span>
<span class="sd">     upstream reservoir (see the Reservoir to Reservoir section for a more complete treatment):</span>

<span class="sd">     Fixed outflux, with no isotope fractionation</span>

<span class="sd">     Example::</span>

<span class="sd">          Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = Sink,</span>
<span class="sd">                rate = &quot;1 mol/s&quot;,)</span>

<span class="sd">     Fixed outflux, with isotope fractionation</span>

<span class="sd">     Example::</span>

<span class="sd">          Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = Sink,</span>
<span class="sd">                alpha = -28,</span>
<span class="sd">                rate = &quot;1 mol/s&quot;,)</span>

<span class="sd">     Advanced Connections</span>
<span class="sd">     --------------------</span>

<span class="sd">     You can aditionally define connection properties via the ctype</span>
<span class="sd">     keyword. This requires additional keyword parameters. The following values are</span>
<span class="sd">     recognized</span>

<span class="sd">     ctype = &quot;scale_with_flux&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     This will scale a flux relative to another flux:</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_with_flux&quot;,</span>
<span class="sd">                ref_reservoirs = flux handle,</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">                bypass :str = &quot;source&quot;/&quot;sink&quot;</span>
<span class="sd">                )</span>

<span class="sd">    if bypass is set the flux will not affect the upstream or</span>
<span class="sd">    downstream reservoir. This is a more generalized approach than the</span>
<span class="sd">    virtual flux type. This is useful to describe reactions which</span>
<span class="sd">    split into two elements (i.e., deprotonation), or combine fluxes</span>
<span class="sd">    from two reservoirs (say S, and O) into a reservoir which records</span>
<span class="sd">    SO4.</span>

<span class="sd">    ctype = &quot;virtual_flux&quot;</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    This will scale a flux relative to another flux, similar to</span>
<span class="sd">    scaleflux. However, in this case, the flux will only affect the</span>
<span class="sd">    sink, and not the source. This is useful to describe reactions which</span>
<span class="sd">    split into two elements (i.e., deprotonation).</span>

<span class="sd">    Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_with_flux&quot;,</span>
<span class="sd">                ref_reservoirs = flux handle,</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">                )</span>

<span class="sd">     ctype = &quot;scale_with_mass&quot; and &quot;scale_with_concentration&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     This will scale a flux relative to the mass or concentration of a reservoir</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_with_mass&quot;,</span>
<span class="sd">                ref_reservoirs = reservoir handle,</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">    )</span>

<span class="sd">     ctype = &quot;scale_relative_to_multiple_reservoirs&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     This process scales the flux as a function one or more reservoirs</span>
<span class="sd">     or constants which describes the</span>
<span class="sd">     strength of relation between the reservoir concentrations and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = C1 * C2 * k</span>

<span class="sd">     where Ci denotes the concentrartion in one  or more reservoirs, k is one</span>
<span class="sd">     or more constants.</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_relative_to_multiple_reservoirs&quot;</span>
<span class="sd">                ref_reservoirs_reservoirs = [r1, r2, k etc] # you must provide at least one</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">    )</span>

<span class="sd">     scale is an overall scaling factor.</span>


<span class="sd">     ctype = &quot;flux_balance&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    This type can be used to express equilibration fluxes</span>
<span class="sd">    between two reservoirs. This connection type, takes three parameters:</span>

<span class="sd">    - =left= is a list which can contain constants and/or reservoirs. The</span>
<span class="sd">      list must contain at least one valid element. All elements in this</span>
<span class="sd">      list will be multiplied with each other. E.g. if we have a list</span>
<span class="sd">      with one constant and one reservoir, the reservoir concentration</span>
<span class="sd">      will be multiplied with the constant. If we have two reservoirs,</span>
<span class="sd">      the respective reservoir concentrations will be multiplied with</span>
<span class="sd">      each other.</span>
<span class="sd">    - =right= similar to =left= The final flux rate will be computed as</span>
<span class="sd">      the difference between =left= and =right=</span>
<span class="sd">    - =k_value= a constant which will be multiplied with the difference</span>
<span class="sd">      between =left=and =right=</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source=R_CO2,         # target of flux</span>
<span class="sd">                 sink=R_HCO3,          # source of flux</span>
<span class="sd">                 rate=&quot;1 mol/s&quot;,       # flux rate</span>
<span class="sd">                 ctype=&quot;flux_balance&quot;, # connection type</span>
<span class="sd">                 scale=1,            # global scaling factor, optional</span>
<span class="sd">                 left=[K1, R_CO2],     # where K1 is a constant</span>
<span class="sd">                 right=[R_HCO3, R_Hplus])</span>


<span class="sd">     Useful methods in this class</span>
<span class="sd">     ----------------------------</span>
<span class="sd">     The following methods might prove useful</span>

<span class="sd">      - info() will provide a short description of the connection objects.</span>
<span class="sd">      - list_processes() which will list all the processes which are associated with this connection.</span>
<span class="sd">      - update() which allows you to update connection properties after the connection has been created</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The init method of the connector obbjects performs sanity checks e.g.:</span>
<span class="sd">               - whether the reservoirs exist</span>
<span class="sd">               - correct flux properties (this will be handled by the process object)</span>
<span class="sd">               - whether the processes do exist (hmmh, that implies that the optional processes do get registered with the model)</span>
<span class="sd">               - creates the correct default processes</span>
<span class="sd">               - and connects the reservoirs</span>

<span class="sd">        see the class documentation for details and examples</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;ref_value&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;a_value&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;b_value&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;sink&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;k_concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a number or Quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;a_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ref_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number, string, or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;b_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="s2">&quot;Number, list or Reservoir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="s2">&quot;Number, list or Reservoir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;Signal Handle&quot;</span><span class="p">,</span>
                <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="s2">&quot;True or False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;source/sink&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;_alpha&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;_rate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;_delta&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># if kwargs[&quot;id&quot;] != &quot;None&quot;:</span>
        <span class="c1">#    self.name = self.name + f&quot;_{self.id}&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;pl&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>

        <span class="c1"># if no reference reservoir is specified, default to the upstream</span>
        <span class="c1"># reservoir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>

        <span class="c1"># decide if this connection needs isotope calculations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">influx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the default process handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">:</span> <span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">:</span> <span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the current model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes in this connection</span>
        <span class="c1"># get a list of all reservoirs registered for this species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Reservoir</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span>

        <span class="c1"># make sure scale is a number in model units</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="c1"># test what type of Quantity we have</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">([</span><span class="s2">&quot;volume]/[time&quot;</span><span class="p">]):</span>  <span class="c1"># flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">([</span><span class="s2">&quot;mass] / [time&quot;</span><span class="p">]):</span>  <span class="c1"># flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;[mass]/[volume]&quot;</span><span class="p">):</span>  <span class="c1"># concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No conversion to model units for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2"> specified&quot;</span><span class="p">)</span>

        <span class="c1"># if sink and source a regular, the name will be simply C_S_2_S</span>
        <span class="c1"># if we deal with ReservoirGroups we need to reflect this in the</span>
        <span class="c1"># connection name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># this yields something like PO42PO4</span>
        <span class="c1"># if we are part of connection group we need to add this</span>
        <span class="c1"># to the connectiongroup</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>  <span class="c1"># register connection in namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with model</span>

        <span class="c1"># This should probably move to register fluxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

        <span class="c1"># if self.register == &quot;None&quot;:</span>
        <span class="c1">#     print(f&quot;Created connection {self.name}&quot;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(f&quot;Created connection {self.register.name}.{self.name}&quot;)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update connection properties. This will delete existing processes</span>
<span class="sd">        and fluxes, replace existing key-value pairs in the</span>
<span class="sd">        self.kwargs dict, and then re-initialize the connection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_connection__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;In most cases the species is set by r2. However, if we have</span>
<span class="sd">        backward fluxes the species depends on the r2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(f&quot;r1 = {r1.n}, r2 = {r2.n}&quot;)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># in this case we do have an upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r2</span>

        <span class="c1"># test if species was explicitly given</span>
        <span class="k">if</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># this is a quick fix only</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># get the parent species</span>

    <span class="k">def</span> <span class="nf">__create_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create flux object, and register with reservoir and global namespace&quot;&quot;&quot;</span>

        <span class="c1"># test if default arguments present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># self._rate = r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

        <span class="c1"># flux name</span>
        <span class="c1"># if self.groupname == False:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_F&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_F&quot;</span>
        <span class="c1"># else:</span>
        <span class="c1">#    n = &quot;F_&quot; + self.r1.full_name + &quot;_2_&quot; + self.r2.full_name</span>

        <span class="c1"># derive flux unit from species obbject</span>
        <span class="n">funit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># xxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>  <span class="c1"># flux name</span>
            <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span>  <span class="c1"># Species handle</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>  <span class="c1"># delta value of flux</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>  <span class="c1"># flux value</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>  <span class="c1"># display this flux?</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span>  <span class="c1"># is this part of a group?</span>
            <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># register flux with its reservoirs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">influx</span>
            <span class="c1"># add the handle to the list of fluxes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1"># register flux and element in the reservoir.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">Sink</span><span class="p">):</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span>
            <span class="c1"># add flux to the upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1"># register flux and element in the reservoir.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Sink</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
                <span class="s2">&quot;The Sink must be specified as a destination (i.e., as second argument&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;The Source must be specified as first argument&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a regular connection</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">influx</span>
            <span class="c1"># add flux to the upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1"># add flux to the downstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Add flux to the correct element dictionary&quot;&quot;&quot;</span>
        <span class="c1"># test if element key is present in reservoir</span>
        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">eh</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span>
            <span class="c1"># add flux handle to dictionary list</span>
            <span class="n">r</span><span class="o">.</span><span class="n">doe</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">eh</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># add key and first list value</span>
            <span class="n">r</span><span class="o">.</span><span class="n">doe</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">eh</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__register_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Register all flux related processes&quot;&quot;&quot;</span>

        <span class="c1"># first test if we have a signal in the list. If so,</span>
        <span class="c1"># remove signal and replace with process</span>

        <span class="n">p_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_copy</span><span class="p">:</span>  <span class="c1"># loop over process list if provided during init</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">ty</span> <span class="o">==</span> <span class="s2">&quot;addition&quot;</span><span class="p">:</span>
                    <span class="c1"># create AddSignal Process object</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">AddSignal</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_addition_process&quot;</span><span class="p">,</span>
                        <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
                        <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="n">lt</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># signals must come first</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserting </span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal type </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">ty</span><span class="si">}</span><span class="s2"> is not defined&quot;</span><span class="p">)</span>

        <span class="c1"># ensure that vardeltaout is first in list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__move_process_to_top_of_queue__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="n">VarDeltaOut</span><span class="p">)</span>
        <span class="c1"># nwo we can register everythig on lop</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__move_process_to_top_of_queue__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">ptype</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of lop where ptype has been moved to the top of lop&quot;&quot;&quot;</span>
        <span class="n">p_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">lop</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_copy</span><span class="p">:</span>  <span class="c1"># loop over process list if provided during init</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
                <span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">lop</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># insert at top</span>

    <span class="k">def</span> <span class="nf">__set_process_type__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Deduce flux type based on the provided flux properties. The method calls the</span>
<span class="sd">        appropriate method init routine</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span>

        <span class="c1"># if signal is provided but rate is omitted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate</span> <span class="o">=</span> <span class="s2">&quot;0 mmol/y&quot;</span>

        <span class="c1"># if connection type is not set explicitly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;Regular&quot;</span><span class="p">:</span>
            <span class="c1"># set the fundamental flux type based on the flux arguments given</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="c1"># self.__vardeltaout__()</span>
                <span class="k">pass</span>  <span class="c1"># if delta and rate are specified, do nothing</span>
            <span class="c1"># variable flux with fixed delta</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>  <span class="c1"># if delta is set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__passivefluxfixeddelta__</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>  <span class="c1"># if rate is set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__vardeltaout__</span><span class="p">()</span>  <span class="c1"># variable delta with fixed flux</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># if neither are given -&gt; default varflux type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__passiveflux__</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;flux_diff&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__vardeltaout__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__flux_diff__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_flux&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scaleflux__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;virtual_flux&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__virtual_flux__</span><span class="p">()</span>
            <span class="c1"># self.__vardeltaout__()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;copy_flux&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scaleflux__</span><span class="p">()</span>
            <span class="c1"># self.__vardeltaout__()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_mass&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_concentration&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
            <span class="c1"># self.__vardeltaout__()</span>
        <span class="c1"># elif self.ctype == &quot;scale_with_concentration_normalized&quot;:</span>
        <span class="c1">#    self.__rateconstant__()</span>
        <span class="c1"># elif self.ctype == &quot;scale_with_mass_normalized&quot;:</span>
        <span class="c1">#     self.__rateconstant__()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_relative_to_multiple_reservoirs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;flux_balance&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;react_with&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reaction__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;monod_type_limit&quot;</span><span class="p">:</span>
            <span class="c1"># self.__vardeltaout__()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection Type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> is unknown&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown connection type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ctype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Set optional flux processes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__alpha__</span><span class="p">()</span>  <span class="c1"># Set optional flux processes</span>
            <span class="c1"># self.__vardeltaout__()</span>

    <span class="k">def</span> <span class="nf">__passivefluxfixeddelta__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">PassiveFlux_fixed_delta</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pfd&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># initialize a passive flux process object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__vardeltaout__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Unlike a passive flux, this process sets the output flux from a</span>
<span class="sd">        reservoir to a fixed value, but the isotopic ratio of the</span>
<span class="sd">        output flux will be set equal to the isotopic ratio of the</span>
<span class="sd">        upstream reservoir.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">VarDeltaOut</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pvdo&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__scaleflux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scale a flux relative to another flux&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span> <span class="n">Flux</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale reference must be a flux&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scaleflux type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if self.bypass == &quot;source&quot;:</span>
        <span class="c1">#     target = self.sink</span>
        <span class="c1"># elif self.bypass == &quot;sinks&quot;:</span>
        <span class="c1">#     target = self.source</span>
        <span class="c1"># elif self.bypass == &quot;None&quot;:</span>
        <span class="c1">#     target = self.r</span>
        <span class="c1"># else:</span>
        <span class="c1">#     raise ValueError(f&quot;bypass must be None/source/sink but not {self.bypass}&quot;)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleFlux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PSF&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bypass</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

        <span class="c1"># this flux must not affect the source reservoir</span>
        <span class="c1"># self.r.lof.remove(self.fh)</span>

    <span class="k">def</span> <span class="nf">__virtual_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a virtual flux. This is similar to __scaleflux__, however the new flux</span>
<span class="sd">        will only affect the sink, and not the source.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale relative to multiple reservoirs</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">],</span> <span class="n">Flux</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale reference must be a flux&quot;</span><span class="p">)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleFlux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PSFV&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoirs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

        <span class="c1"># this flux must not affect the source reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__flux_diff__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scale a flux relative to the difference between</span>
<span class="sd">        two fluxes</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale relative to multiple reservoirs</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ref must be a list&quot;</span><span class="p">)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">FluxDiff</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PSF&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reaction__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale reference must be a flux&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for reaction type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;RF&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># we need to make sure to remove the flux referenced by</span>
        <span class="c1"># react_with is removed from the list of fluxes in this</span>
        <span class="c1"># reservoir. This should probably move in to the React Class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__passiveflux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">PassiveFlux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_PF&quot;</span><span class="p">,</span> <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span>
        <span class="p">)</span>  <span class="c1"># initialize a passive flux process object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>  <span class="c1"># add this process to the process list</span>

    <span class="k">def</span> <span class="nf">__alpha__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">Fractionation</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Pa&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>  <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__rateconstant__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add rate constant type process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># this process requires that we use the vardeltaout process</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">!=</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="c1"># self.__vardeltaout__()</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_mass&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale with mass type</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleRelativeToMass</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_PkM&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_concentration&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale with concentration type</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span>
            <span class="p">)</span>
            <span class="c1"># print(</span>
            <span class="c1">#    f&quot;Registering PKC with ref = {self.ref.full_name}, scale = {self.scale}&quot;</span>
            <span class="c1"># )</span>

            <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleRelativeToConcentration</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PkC&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># print(f&quot;Process Name {ph.full_name}&quot;)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_relative_to_multiple_reservoirs&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale relative to multiple reservoirs</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span>
            <span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleRelative2otherReservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PkC&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;flux_balance&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span>
            <span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">Flux_Balance</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Pfb&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span>
                <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">k_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;monod_ctype_limit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">Monod</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_PMonod&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">ref_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span><span class="p">,</span>
                <span class="n">a_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a_value</span><span class="p">,</span>
                <span class="n">b_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This should not happen,and points to a keywords problem in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this Connection</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Fluxes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delete_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Updates to the connection properties may change the connection type and thus</span>
<span class="sd">        the processes which are associated with this connection. We thus have to</span>
<span class="sd">        first delete the old processes, before we re-initialize the connection</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># identify which processes we need to delete</span>
        <span class="c1"># unregister process from connection.lop, reservoir.lop, flux.lop, model.lmo</span>
        <span class="c1"># delete process from global name space if present</span>

        <span class="n">lop</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lop</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">):</span>
                    <span class="c1"># remove from Connection group list of model objects</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">__delete_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Updates to the connection properties may change the connection type and thus</span>
<span class="sd">        the processes which are associated with this connection. We thus have to</span>
<span class="sd">        first delete the old flux, before we re-initialize the connection</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># identify which processes we need to delete</span>
        <span class="c1"># unregister process from connection.lop, reservoir.lop, flux.lop, model.lmo</span>
        <span class="c1"># delete process from global name space if present</span>

        <span class="n">lof</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">lof</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">):</span>
                <span class="c1"># remove from Connection group list of model objects</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">f</span>

    <span class="c1"># ---- Property definitions to allow for connection updates --------</span>
    <span class="sd">&quot;&quot;&quot; Changing the below properties requires that we delete all</span>
<span class="sd">    associated objects (processes), and determines the new flux type,</span>
<span class="sd">    and initialize/register these with the connection and model.</span>
<span class="sd">    We also have to update the keyword arguments as these are used</span>
<span class="sd">    for the log entry</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---- alpha ----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span>

    <span class="nd">@alpha</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

    <span class="c1"># ---- rate  ----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rate</span>

    <span class="nd">@rate</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rate</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

    <span class="c1"># ---- delta  ----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">Connect</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for the Connect class&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">ConnectionGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Name:</span>

<span class="sd">        ConnectionGroup</span>

<span class="sd">        Connect reservoir/sink/source groups when at least one of the</span>
<span class="sd">        arguments is a reservoirs_group object. This method will</span>
<span class="sd">        create regular connections for each matching species.</span>

<span class="sd">        Use the connection.update() method to fine tune connections</span>
<span class="sd">        after creation</span>

<span class="sd">    Example::</span>

<span class="sd">        ConnectionGroup(source =  upstream reservoir / upstream reservoir group</span>
<span class="sd">           sink = downstrean reservoir / downstream reservoirs_group</span>
<span class="sd">           delta = defaults to zero and has to be set manually</span>
<span class="sd">           alpha =  defaults to zero and has to be set manually</span>
<span class="sd">           rate = shared between all connections</span>
<span class="sd">           ref_reservoirs = shared between all connections</span>
<span class="sd">           species = list, optional, if present, only these species will be connected</span>
<span class="sd">           ctype = needs to be set for all connections. Use &quot;Regular&quot;</span>
<span class="sd">                   unless you require a specific connection type</span>
<span class="sd">           pl = [list]) process list. optional, shared between all connections</span>
<span class="sd">           id = optional identifier, passed on to individual connection</span>
<span class="sd">           plot = &quot;yes/no&quot; # defaults to yes, shared between all connections</span>
<span class="sd">        )</span>

<span class="sd">        ConnectionGroup(</span>
<span class="sd">                  source=OM_Weathering,</span>
<span class="sd">                  sink=Ocean,</span>
<span class="sd">                  rate={DIC: f&quot;{OM_w} Tmol/yr&quot; ,</span>
<span class="sd">                        ALK: f&quot;{0} Tmol/yr&quot;},</span>
<span class="sd">                  ctype = {DIC: &quot;Regular&quot;,</span>
<span class="sd">                           ALK: &quot;Regular&quot;},</span>
<span class="sd">    )</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_kwargs__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># # self.source.lor is a  list with the object names in the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of connection objects</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_connections__</span><span class="p">()</span>

        <span class="c1"># register connection group in global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a connection to the connection group</span>
<span class="sd">        This will overwrite the original kwargs though</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_kwargs__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_connections__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__parse_kwargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse and register the keyword arguments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">Signal</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sink&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sink&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># set connection group name</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">})</span>  <span class="c1"># and add it to the kwargs</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;sink&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__create_connections__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create Connections&quot;&quot;&quot;</span>
        <span class="c1"># find all sub reservoirs which have been specified by the ctype keyword</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connectiongroup </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> must specify &#39;ctype&#39;. See help(Connectiongroup)&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found species </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># now we need to create defaults for all connections</span>
        <span class="c1"># we setup a dict like this  {SO4:{cid:xxx,plot:xxx}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># connection dictionary</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>  <span class="c1"># [&quot;SO4&quot;, &quot;H2S&quot;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># now we loop trough all keys for this connection and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry like ctype</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="p">]</span>
            <span class="c1"># now we can create the connection</span>

            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">Connect</span><span class="p">(</span>
                <span class="c1"># name=name,</span>
                <span class="n">source</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">),</span>
                <span class="n">sink</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">),</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">ctype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;ctype&quot;</span><span class="p">],</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
                <span class="n">bypass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;bypass&quot;</span><span class="p">],</span>
                <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1">## add connection to list of connections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List all connections in this group&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group Connection from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following Connections are part of this group</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You can query the details of each connection like this:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            </section>
                <section id="Connect">
                                <div class="attr class">
        <a class="headerlink" href="#Connect">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Connect</span>(<span class="base"><a href="esbmtk.html#esbmtkBase">esbmtk.esbmtk.esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Connect</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Two reservoirs connect to each other via at least one flux. This</span>
<span class="sd">     module creates the connecting flux and creates a connector object</span>
<span class="sd">     which stores all connection properties.</span>

<span class="sd">     For simple connections, the type flux type is derived implcitly from the specified parameters.</span>
<span class="sd">     For complex connections, the flux type must be set explicitly. See the examples below:</span>

<span class="sd">     Parameters:</span>
<span class="sd">         - name: A string which determines the name of this object. Optional, if not provided</span>
<span class="sd">           the connection name will be derived as &quot;C_Source_2_Sink&quot;</span>
<span class="sd">         - source: An object handle for a Source or Reservoir</span>
<span class="sd">         - sink: An object handle for a Sink or Reservoir</span>
<span class="sd">         - rate: A quantity (e.g., &quot;1 mol/s&quot;), optional</span>
<span class="sd">         - delta: The isotope ratio, optional</span>
<span class="sd">         - ref_reservoirs: Reservoir or flux reference</span>
<span class="sd">         - alpha: A fractionation factor, optional</span>
<span class="sd">         - id: A string wich will become part of the object name, optional</span>
<span class="sd">         - plot: &quot;yes&quot; or &quot;no&quot;, defaults to &quot;yes&quot;</span>
<span class="sd">         - signal: An object handle of signal, optional</span>
<span class="sd">         - pl: A list of process objects, optional</span>
<span class="sd">         - ctype: connection type, optional, this allows to scale a flux in response to other</span>
<span class="sd">           reservoirs and fluxes</span>
<span class="sd">         - bypass :str optional defaults to &quot;None&quot; see scale with flux</span>

<span class="sd">     Connection Types:</span>
<span class="sd">     -----------------</span>
<span class="sd">     Basic Connections (the advanced ones are below):</span>

<span class="sd">     - If both =rate= and =delta= are given, the flux is treated as a</span>
<span class="sd">        fixed flux with a given isotope ratio. This is usually the case for</span>
<span class="sd">        most source objects (they can still be affected by a signal, see</span>
<span class="sd">        above), but makes little sense for reservoirs and sinks.</span>

<span class="sd">     - If both the =rate= and =alpha= are given, the flux rate is fixed</span>
<span class="sd">       (subject to any signals), but the isotopic ratio of the output</span>
<span class="sd">       flux depends on the isotopic ratio of the upstream reservoir</span>
<span class="sd">       plus any isotopic fractionation specified by =alpha=. This is</span>
<span class="sd">       typically the case for fluxes which include an isotopic</span>
<span class="sd">       fractionation (i.e., pyrite burial). This combination is not</span>
<span class="sd">       particularly useful for source objects.</span>

<span class="sd">     - If the connection specifies only =delta= the flux is treated as a</span>
<span class="sd">       variable flux which is computed in such a way that the reservoir</span>
<span class="sd">       maintains steady state with respect to it&#39;s mass.</span>

<span class="sd">     - If the connection specifies only =rate= the flux is treated as a</span>
<span class="sd">       fixed flux which is computed in such a way that the reservoir</span>
<span class="sd">       maintains steady state with respect to it&#39;s isotope ratio.</span>

<span class="sd">     Examples of Basic Connections</span>
<span class="sd">     -----------------------------</span>

<span class="sd">     Connecting a Source to a Reservoir</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     Unless you use a Signal, a source typically provides a steady stream with a given isotope ratio (if used)</span>

<span class="sd">     Example::</span>

<span class="sd">        Connect(source =  Source,</span>
<span class="sd">                sink = downstrean reservoir,</span>
<span class="sd">                rate = &quot;1 mol/s&quot;,</span>
<span class="sd">                delta = optional,</span>
<span class="sd">                signal = optional, see the signal documentation)</span>

<span class="sd">     Connecting a Reservoir to Sink or another Reservoir</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     Here we can distinguish between cases where we use fixed flux, or a flux which reacts to in some way to the</span>
<span class="sd">     upstream reservoir (see the Reservoir to Reservoir section for a more complete treatment):</span>

<span class="sd">     Fixed outflux, with no isotope fractionation</span>

<span class="sd">     Example::</span>

<span class="sd">          Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = Sink,</span>
<span class="sd">                rate = &quot;1 mol/s&quot;,)</span>

<span class="sd">     Fixed outflux, with isotope fractionation</span>

<span class="sd">     Example::</span>

<span class="sd">          Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = Sink,</span>
<span class="sd">                alpha = -28,</span>
<span class="sd">                rate = &quot;1 mol/s&quot;,)</span>

<span class="sd">     Advanced Connections</span>
<span class="sd">     --------------------</span>

<span class="sd">     You can aditionally define connection properties via the ctype</span>
<span class="sd">     keyword. This requires additional keyword parameters. The following values are</span>
<span class="sd">     recognized</span>

<span class="sd">     ctype = &quot;scale_with_flux&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     This will scale a flux relative to another flux:</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_with_flux&quot;,</span>
<span class="sd">                ref_reservoirs = flux handle,</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">                bypass :str = &quot;source&quot;/&quot;sink&quot;</span>
<span class="sd">                )</span>

<span class="sd">    if bypass is set the flux will not affect the upstream or</span>
<span class="sd">    downstream reservoir. This is a more generalized approach than the</span>
<span class="sd">    virtual flux type. This is useful to describe reactions which</span>
<span class="sd">    split into two elements (i.e., deprotonation), or combine fluxes</span>
<span class="sd">    from two reservoirs (say S, and O) into a reservoir which records</span>
<span class="sd">    SO4.</span>

<span class="sd">    ctype = &quot;virtual_flux&quot;</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    This will scale a flux relative to another flux, similar to</span>
<span class="sd">    scaleflux. However, in this case, the flux will only affect the</span>
<span class="sd">    sink, and not the source. This is useful to describe reactions which</span>
<span class="sd">    split into two elements (i.e., deprotonation).</span>

<span class="sd">    Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_with_flux&quot;,</span>
<span class="sd">                ref_reservoirs = flux handle,</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">                )</span>

<span class="sd">     ctype = &quot;scale_with_mass&quot; and &quot;scale_with_concentration&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     This will scale a flux relative to the mass or concentration of a reservoir</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_with_mass&quot;,</span>
<span class="sd">                ref_reservoirs = reservoir handle,</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">    )</span>

<span class="sd">     ctype = &quot;scale_relative_to_multiple_reservoirs&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">     This process scales the flux as a function one or more reservoirs</span>
<span class="sd">     or constants which describes the</span>
<span class="sd">     strength of relation between the reservoir concentrations and</span>
<span class="sd">     the flux scaling</span>

<span class="sd">     F = C1 * C2 * k</span>

<span class="sd">     where Ci denotes the concentrartion in one  or more reservoirs, k is one</span>
<span class="sd">     or more constants.</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source =  upstream reservoir,</span>
<span class="sd">                sink = downstream reservoir,</span>
<span class="sd">                ctype = &quot;scale_relative_to_multiple_reservoirs&quot;</span>
<span class="sd">                ref_reservoirs_reservoirs = [r1, r2, k etc] # you must provide at least one</span>
<span class="sd">                scale = a scaling factor, optional, defaults to 1</span>
<span class="sd">    )</span>

<span class="sd">     scale is an overall scaling factor.</span>


<span class="sd">     ctype = &quot;flux_balance&quot;</span>
<span class="sd">     ~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    This type can be used to express equilibration fluxes</span>
<span class="sd">    between two reservoirs. This connection type, takes three parameters:</span>

<span class="sd">    - =left= is a list which can contain constants and/or reservoirs. The</span>
<span class="sd">      list must contain at least one valid element. All elements in this</span>
<span class="sd">      list will be multiplied with each other. E.g. if we have a list</span>
<span class="sd">      with one constant and one reservoir, the reservoir concentration</span>
<span class="sd">      will be multiplied with the constant. If we have two reservoirs,</span>
<span class="sd">      the respective reservoir concentrations will be multiplied with</span>
<span class="sd">      each other.</span>
<span class="sd">    - =right= similar to =left= The final flux rate will be computed as</span>
<span class="sd">      the difference between =left= and =right=</span>
<span class="sd">    - =k_value= a constant which will be multiplied with the difference</span>
<span class="sd">      between =left=and =right=</span>

<span class="sd">     Example::</span>

<span class="sd">         Connect(source=R_CO2,         # target of flux</span>
<span class="sd">                 sink=R_HCO3,          # source of flux</span>
<span class="sd">                 rate=&quot;1 mol/s&quot;,       # flux rate</span>
<span class="sd">                 ctype=&quot;flux_balance&quot;, # connection type</span>
<span class="sd">                 scale=1,            # global scaling factor, optional</span>
<span class="sd">                 left=[K1, R_CO2],     # where K1 is a constant</span>
<span class="sd">                 right=[R_HCO3, R_Hplus])</span>


<span class="sd">     Useful methods in this class</span>
<span class="sd">     ----------------------------</span>
<span class="sd">     The following methods might prove useful</span>

<span class="sd">      - info() will provide a short description of the connection objects.</span>
<span class="sd">      - list_processes() which will list all the processes which are associated with this connection.</span>
<span class="sd">      - update() which allows you to update connection properties after the connection has been created</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The init method of the connector obbjects performs sanity checks e.g.:</span>
<span class="sd">               - whether the reservoirs exist</span>
<span class="sd">               - correct flux properties (this will be handled by the process object)</span>
<span class="sd">               - whether the processes do exist (hmmh, that implies that the optional processes do get registered with the model)</span>
<span class="sd">               - creates the correct default processes</span>
<span class="sd">               - and connects the reservoirs</span>

<span class="sd">        see the class documentation for details and examples</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;ref_value&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;a_value&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;b_value&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;sink&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;k_concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a number or Quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;a_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ref_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number, string, or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;b_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="s2">&quot;Number, list or Reservoir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="s2">&quot;Number, list or Reservoir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;Signal Handle&quot;</span><span class="p">,</span>
                <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="s2">&quot;True or False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;source/sink&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;_alpha&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;_rate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;_delta&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># if kwargs[&quot;id&quot;] != &quot;None&quot;:</span>
        <span class="c1">#    self.name = self.name + f&quot;_{self.id}&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;pl&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>

        <span class="c1"># if no reference reservoir is specified, default to the upstream</span>
        <span class="c1"># reservoir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>

        <span class="c1"># decide if this connection needs isotope calculations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">influx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the default process handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">:</span> <span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">:</span> <span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the current model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes in this connection</span>
        <span class="c1"># get a list of all reservoirs registered for this species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Reservoir</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span>

        <span class="c1"># make sure scale is a number in model units</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="c1"># test what type of Quantity we have</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">([</span><span class="s2">&quot;volume]/[time&quot;</span><span class="p">]):</span>  <span class="c1"># flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">([</span><span class="s2">&quot;mass] / [time&quot;</span><span class="p">]):</span>  <span class="c1"># flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;[mass]/[volume]&quot;</span><span class="p">):</span>  <span class="c1"># concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No conversion to model units for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2"> specified&quot;</span><span class="p">)</span>

        <span class="c1"># if sink and source a regular, the name will be simply C_S_2_S</span>
        <span class="c1"># if we deal with ReservoirGroups we need to reflect this in the</span>
        <span class="c1"># connection name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># this yields something like PO42PO4</span>
        <span class="c1"># if we are part of connection group we need to add this</span>
        <span class="c1"># to the connectiongroup</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>  <span class="c1"># register connection in namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with model</span>

        <span class="c1"># This should probably move to register fluxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

        <span class="c1"># if self.register == &quot;None&quot;:</span>
        <span class="c1">#     print(f&quot;Created connection {self.name}&quot;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(f&quot;Created connection {self.register.name}.{self.name}&quot;)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update connection properties. This will delete existing processes</span>
<span class="sd">        and fluxes, replace existing key-value pairs in the</span>
<span class="sd">        self.kwargs dict, and then re-initialize the connection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_connection__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;In most cases the species is set by r2. However, if we have</span>
<span class="sd">        backward fluxes the species depends on the r2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(f&quot;r1 = {r1.n}, r2 = {r2.n}&quot;)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># in this case we do have an upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r2</span>

        <span class="c1"># test if species was explicitly given</span>
        <span class="k">if</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># this is a quick fix only</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># get the parent species</span>

    <span class="k">def</span> <span class="nf">__create_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create flux object, and register with reservoir and global namespace&quot;&quot;&quot;</span>

        <span class="c1"># test if default arguments present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;0 </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># self._rate = r</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

        <span class="c1"># flux name</span>
        <span class="c1"># if self.groupname == False:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_F&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">_F&quot;</span>
        <span class="c1"># else:</span>
        <span class="c1">#    n = &quot;F_&quot; + self.r1.full_name + &quot;_2_&quot; + self.r2.full_name</span>

        <span class="c1"># derive flux unit from species obbject</span>
        <span class="n">funit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">bu</span><span class="p">)</span>  <span class="c1"># xxx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fh</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>  <span class="c1"># flux name</span>
            <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="p">,</span>  <span class="c1"># Species handle</span>
            <span class="n">delta</span><span class="o">=</span><span class="n">d</span><span class="p">,</span>  <span class="c1"># delta value of flux</span>
            <span class="n">rate</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>  <span class="c1"># flux value</span>
            <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span>  <span class="c1"># display this flux?</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">,</span>  <span class="c1"># is this part of a group?</span>
            <span class="n">isotopes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># register flux with its reservoirs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">influx</span>
            <span class="c1"># add the handle to the list of fluxes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1"># register flux and element in the reservoir.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">Sink</span><span class="p">):</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span>
            <span class="c1"># add flux to the upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1"># register flux and element in the reservoir.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Sink</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span>
                <span class="s2">&quot;The Sink must be specified as a destination (i.e., as second argument&quot;</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;The Source must be specified as first argument&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a regular connection</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span>
            <span class="c1"># add the flux name direction/pair</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lio</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">influx</span>
            <span class="c1"># add flux to the upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="c1"># add flux to the downstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">sp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__register_species__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Add flux to the correct element dictionary&quot;&quot;&quot;</span>
        <span class="c1"># test if element key is present in reservoir</span>
        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">eh</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">doe</span><span class="p">:</span>
            <span class="c1"># add flux handle to dictionary list</span>
            <span class="n">r</span><span class="o">.</span><span class="n">doe</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">eh</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># add key and first list value</span>
            <span class="n">r</span><span class="o">.</span><span class="n">doe</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">eh</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__register_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Register all flux related processes&quot;&quot;&quot;</span>

        <span class="c1"># first test if we have a signal in the list. If so,</span>
        <span class="c1"># remove signal and replace with process</span>

        <span class="n">p_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_copy</span><span class="p">:</span>  <span class="c1"># loop over process list if provided during init</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Signal</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">ty</span> <span class="o">==</span> <span class="s2">&quot;addition&quot;</span><span class="p">:</span>
                    <span class="c1"># create AddSignal Process object</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">AddSignal</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="s2">&quot;_addition_process&quot;</span><span class="p">,</span>
                        <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
                        <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                        <span class="n">lt</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>  <span class="c1"># signals must come first</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserting </span><span class="si">{</span><span class="n">n</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Signal type </span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">ty</span><span class="si">}</span><span class="s2"> is not defined&quot;</span><span class="p">)</span>

        <span class="c1"># ensure that vardeltaout is first in list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__move_process_to_top_of_queue__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">,</span> <span class="n">VarDeltaOut</span><span class="p">)</span>
        <span class="c1"># nwo we can register everythig on lop</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">__register__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__move_process_to_top_of_queue__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">ptype</span><span class="p">:</span> <span class="nb">any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of lop where ptype has been moved to the top of lop&quot;&quot;&quot;</span>
        <span class="n">p_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">lop</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p_copy</span><span class="p">:</span>  <span class="c1"># loop over process list if provided during init</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
                <span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">lop</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># insert at top</span>

    <span class="k">def</span> <span class="nf">__set_process_type__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Deduce flux type based on the provided flux properties. The method calls the</span>
<span class="sd">        appropriate method init routine</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r1</span>

        <span class="c1"># if signal is provided but rate is omitted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rate</span> <span class="o">=</span> <span class="s2">&quot;0 mmol/y&quot;</span>

        <span class="c1"># if connection type is not set explicitly</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;Regular&quot;</span><span class="p">:</span>
            <span class="c1"># set the fundamental flux type based on the flux arguments given</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="c1"># self.__vardeltaout__()</span>
                <span class="k">pass</span>  <span class="c1"># if delta and rate are specified, do nothing</span>
            <span class="c1"># variable flux with fixed delta</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>  <span class="c1"># if delta is set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__passivefluxfixeddelta__</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>  <span class="c1"># if rate is set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__vardeltaout__</span><span class="p">()</span>  <span class="c1"># variable delta with fixed flux</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># if neither are given -&gt; default varflux type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__passiveflux__</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;flux_diff&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__vardeltaout__</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__flux_diff__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_flux&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scaleflux__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;virtual_flux&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__virtual_flux__</span><span class="p">()</span>
            <span class="c1"># self.__vardeltaout__()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;copy_flux&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scaleflux__</span><span class="p">()</span>
            <span class="c1"># self.__vardeltaout__()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_mass&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_concentration&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
            <span class="c1"># self.__vardeltaout__()</span>
        <span class="c1"># elif self.ctype == &quot;scale_with_concentration_normalized&quot;:</span>
        <span class="c1">#    self.__rateconstant__()</span>
        <span class="c1"># elif self.ctype == &quot;scale_with_mass_normalized&quot;:</span>
        <span class="c1">#     self.__rateconstant__()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_relative_to_multiple_reservoirs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;flux_balance&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;react_with&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reaction__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;monod_type_limit&quot;</span><span class="p">:</span>
            <span class="c1"># self.__vardeltaout__()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rateconstant__</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;manual&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection Type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ctype</span><span class="si">}</span><span class="s2"> is unknown&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown connection type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ctype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Set optional flux processes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__alpha__</span><span class="p">()</span>  <span class="c1"># Set optional flux processes</span>
            <span class="c1"># self.__vardeltaout__()</span>

    <span class="k">def</span> <span class="nf">__passivefluxfixeddelta__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">PassiveFlux_fixed_delta</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pfd&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># initialize a passive flux process object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__vardeltaout__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Unlike a passive flux, this process sets the output flux from a</span>
<span class="sd">        reservoir to a fixed value, but the isotopic ratio of the</span>
<span class="sd">        output flux will be set equal to the isotopic ratio of the</span>
<span class="sd">        upstream reservoir.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">VarDeltaOut</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Pvdo&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__scaleflux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scale a flux relative to another flux&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span> <span class="n">Flux</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale reference must be a flux&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scaleflux type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if self.bypass == &quot;source&quot;:</span>
        <span class="c1">#     target = self.sink</span>
        <span class="c1"># elif self.bypass == &quot;sinks&quot;:</span>
        <span class="c1">#     target = self.source</span>
        <span class="c1"># elif self.bypass == &quot;None&quot;:</span>
        <span class="c1">#     target = self.r</span>
        <span class="c1"># else:</span>
        <span class="c1">#     raise ValueError(f&quot;bypass must be None/source/sink but not {self.bypass}&quot;)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleFlux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PSF&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bypass</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bypass</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

        <span class="c1"># this flux must not affect the source reservoir</span>
        <span class="c1"># self.r.lof.remove(self.fh)</span>

    <span class="k">def</span> <span class="nf">__virtual_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a virtual flux. This is similar to __scaleflux__, however the new flux</span>
<span class="sd">        will only affect the sink, and not the source.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale relative to multiple reservoirs</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">],</span> <span class="n">Flux</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale reference must be a flux&quot;</span><span class="p">)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleFlux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PSFV&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reservoirs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

        <span class="c1"># this flux must not affect the source reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__flux_diff__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scale a flux relative to the difference between</span>
<span class="sd">        two fluxes</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale relative to multiple reservoirs</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ref must be a list&quot;</span><span class="p">)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">FluxDiff</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PSF&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reaction__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span> <span class="p">(</span><span class="n">Flux</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale reference must be a flux&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for reaction type</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;RF&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># we need to make sure to remove the flux referenced by</span>
        <span class="c1"># react_with is removed from the list of fluxes in this</span>
        <span class="c1"># reservoir. This should probably move in to the React Class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__passiveflux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">PassiveFlux</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_PF&quot;</span><span class="p">,</span> <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span>
        <span class="p">)</span>  <span class="c1"># initialize a passive flux process object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>  <span class="c1"># add this process to the process list</span>

    <span class="k">def</span> <span class="nf">__alpha__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Just a wrapper to keep the if statement manageable&quot;&quot;&quot;</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="n">Fractionation</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Pa&quot;</span><span class="p">,</span>
            <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
            <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>  <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__rateconstant__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add rate constant type process&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># this process requires that we use the vardeltaout process</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_type</span> <span class="o">!=</span> <span class="s2">&quot;mass_only&quot;</span><span class="p">:</span>
            <span class="c1"># self.__vardeltaout__()</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_mass&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale with mass type</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">m_unit</span><span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleRelativeToMass</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_PkM&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_with_concentration&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale with concentration type</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span>
            <span class="p">)</span>
            <span class="c1"># print(</span>
            <span class="c1">#    f&quot;Registering PKC with ref = {self.ref.full_name}, scale = {self.scale}&quot;</span>
            <span class="c1"># )</span>

            <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleRelativeToConcentration</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PkC&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># print(f&quot;Process Name {ph.full_name}&quot;)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;scale_relative_to_multiple_reservoirs&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Warning: use scale instead of k_value for scale relative to multiple reservoirs</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span>
            <span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">ScaleRelative2otherReservoir</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;PkC&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;flux_balance&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">k_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span>
            <span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">Flux_Balance</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_Pfb&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">left</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span>
                <span class="n">right</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">k_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k_value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;monod_ctype_limit&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span> <span class="o">=</span> <span class="n">map_units</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span>
            <span class="n">ph</span> <span class="o">=</span> <span class="n">Monod</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;_PMonod&quot;</span><span class="p">,</span>
                <span class="n">reservoir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span><span class="p">,</span>
                <span class="n">flux</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="p">,</span>
                <span class="n">ref_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_value</span><span class="p">,</span>
                <span class="n">a_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a_value</span><span class="p">,</span>
                <span class="n">b_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;This should not happen,and points to a keywords problem in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ph</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this Connection</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Fluxes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delete_process__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Updates to the connection properties may change the connection type and thus</span>
<span class="sd">        the processes which are associated with this connection. We thus have to</span>
<span class="sd">        first delete the old processes, before we re-initialize the connection</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># identify which processes we need to delete</span>
        <span class="c1"># unregister process from connection.lop, reservoir.lop, flux.lop, model.lmo</span>
        <span class="c1"># delete process from global name space if present</span>

        <span class="n">lop</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lop</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">):</span>
                    <span class="c1"># remove from Connection group list of model objects</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fh</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">__delete_flux__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Updates to the connection properties may change the connection type and thus</span>
<span class="sd">        the processes which are associated with this connection. We thus have to</span>
<span class="sd">        first delete the old flux, before we re-initialize the connection</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># identify which processes we need to delete</span>
        <span class="c1"># unregister process from connection.lop, reservoir.lop, flux.lop, model.lmo</span>
        <span class="c1"># delete process from global name space if present</span>

        <span class="n">lof</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">lof</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">register</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">):</span>
                <span class="c1"># remove from Connection group list of model objects</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lmo</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">f</span>

    <span class="c1"># ---- Property definitions to allow for connection updates --------</span>
    <span class="sd">&quot;&quot;&quot; Changing the below properties requires that we delete all</span>
<span class="sd">    associated objects (processes), and determines the new flux type,</span>
<span class="sd">    and initialize/register these with the connection and model.</span>
<span class="sd">    We also have to update the keyword arguments as these are used</span>
<span class="sd">    for the log entry</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ---- alpha ----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span>

    <span class="nd">@alpha</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_alpha</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

    <span class="c1"># ---- rate  ----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rate</span>

    <span class="nd">@rate</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rate</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

    <span class="c1"># ---- delta  ----</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span>

    <span class="nd">@delta</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">Number</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delta</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Two reservoirs connect to each other via at least one flux. This
 module creates the connecting flux and creates a connector object
 which stores all connection properties.</p>

<p>For simple connections, the type flux type is derived implcitly from the specified parameters.
 For complex connections, the flux type must be set explicitly. See the examples below:</p>

<p>Parameters:
     - name: A string which determines the name of this object. Optional, if not provided
       the connection name will be derived as "C_Source_2_Sink"
     - source: An object handle for a Source or Reservoir
     - sink: An object handle for a Sink or Reservoir
     - rate: A quantity (e.g., "1 mol/s"), optional
     - delta: The isotope ratio, optional
     - ref_reservoirs: Reservoir or flux reference
     - alpha: A fractionation factor, optional
     - id: A string wich will become part of the object name, optional
     - plot: "yes" or "no", defaults to "yes"
     - signal: An object handle of signal, optional
     - pl: A list of process objects, optional
     - ctype: connection type, optional, this allows to scale a flux in response to other
       reservoirs and fluxes
     - bypass :str optional defaults to "None" see scale with flux</p>

<p>Connection Types:</p>

<hr />

<p>Basic Connections (the advanced ones are below):</p>

<ul>
<li><p>If both =rate= and =delta= are given, the flux is treated as a
fixed flux with a given isotope ratio. This is usually the case for
most source objects (they can still be affected by a signal, see
above), but makes little sense for reservoirs and sinks.</p></li>
<li><p>If both the =rate= and =alpha= are given, the flux rate is fixed
(subject to any signals), but the isotopic ratio of the output
flux depends on the isotopic ratio of the upstream reservoir
plus any isotopic fractionation specified by =alpha=. This is
typically the case for fluxes which include an isotopic
fractionation (i.e., pyrite burial). This combination is not
particularly useful for source objects.</p></li>
<li><p>If the connection specifies only =delta= the flux is treated as a
variable flux which is computed in such a way that the reservoir
maintains steady state with respect to it's mass.</p></li>
<li><p>If the connection specifies only =rate= the flux is treated as a
fixed flux which is computed in such a way that the reservoir
maintains steady state with respect to it's isotope ratio.</p>

<p>Examples of Basic Connections</p></li>
</ul>

<hr />

<p>Connecting a Source to a Reservoir
 <strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~~~</p>

<p>Unless you use a Signal, a source typically provides a steady stream with a given isotope ratio (if used)</p>

<p>Example::</p>

<pre><code>Connect(source =  Source,
        sink = downstrean reservoir,
        rate = "1 mol/s",
        delta = optional,
        signal = optional, see the signal documentation)
</code></pre>

<p>Connecting a Reservoir to Sink or another Reservoir
 <strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~</p>

<p>Here we can distinguish between cases where we use fixed flux, or a flux which reacts to in some way to the
 upstream reservoir (see the Reservoir to Reservoir section for a more complete treatment):</p>

<p>Fixed outflux, with no isotope fractionation</p>

<p>Example::</p>

<pre><code>  Connect(source =  upstream reservoir,
        sink = Sink,
        rate = "1 mol/s",)
</code></pre>

<p>Fixed outflux, with isotope fractionation</p>

<p>Example::</p>

<pre><code>  Connect(source =  upstream reservoir,
        sink = Sink,
        alpha = -28,
        rate = "1 mol/s",)
</code></pre>

<p>Advanced Connections</p>

<hr />

<p>You can aditionally define connection properties via the ctype
 keyword. This requires additional keyword parameters. The following values are
 recognized</p>

<p>ctype = "scale_with_flux"
 <strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike></p>

<p>This will scale a flux relative to another flux:</p>

<p>Example::</p>

<pre><code> Connect(source =  upstream reservoir,
        sink = downstream reservoir,
        ctype = "scale_with_flux",
        ref_reservoirs = flux handle,
        scale = a scaling factor, optional, defaults to 1
        bypass :str = "source"/"sink"
        )
</code></pre>

<p>if bypass is set the flux will not affect the upstream or
downstream reservoir. This is a more generalized approach than the
virtual flux type. This is useful to describe reactions which
split into two elements (i.e., deprotonation), or combine fluxes
from two reservoirs (say S, and O) into a reservoir which records
SO4.</p>

<p>ctype = "virtual_flux"
<strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike></p>

<p>This will scale a flux relative to another flux, similar to
scaleflux. However, in this case, the flux will only affect the
sink, and not the source. This is useful to describe reactions which
split into two elements (i.e., deprotonation).</p>

<p>Example::</p>

<pre><code> Connect(source =  upstream reservoir,
        sink = downstream reservoir,
        ctype = "scale_with_flux",
        ref_reservoirs = flux handle,
        scale = a scaling factor, optional, defaults to 1
        )
</code></pre>

<p>ctype = "scale_with_mass" and "scale_with_concentration"
 <strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~</p>

<p>This will scale a flux relative to the mass or concentration of a reservoir</p>

<p>Example::</p>

<pre><code> Connect(source =  upstream reservoir,
        sink = downstream reservoir,
        ctype = "scale_with_mass",
        ref_reservoirs = reservoir handle,
        scale = a scaling factor, optional, defaults to 1
</code></pre>

<p>)</p>

<p>ctype = "scale_relative_to_multiple_reservoirs"
 <strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~</p>

<p>This process scales the flux as a function one or more reservoirs
 or constants which describes the
 strength of relation between the reservoir concentrations and
 the flux scaling</p>

<p>F = C1 * C2 * k</p>

<p>where Ci denotes the concentrartion in one  or more reservoirs, k is one
 or more constants.</p>

<p>Example::</p>

<pre><code> Connect(source =  upstream reservoir,
        sink = downstream reservoir,
        ctype = "scale_relative_to_multiple_reservoirs"
        ref_reservoirs_reservoirs = [r1, r2, k etc] # you must provide at least one
        scale = a scaling factor, optional, defaults to 1
</code></pre>

<p>)</p>

<p>scale is an overall scaling factor.</p>

<p>ctype = "flux_balance"
 <strike>~</strike><strike>~</strike><strike>~</strike><strike>~</strike>~~</p>

<p>This type can be used to express equilibration fluxes
between two reservoirs. This connection type, takes three parameters:</p>

<ul>
<li>=left= is a list which can contain constants and/or reservoirs. The
list must contain at least one valid element. All elements in this
list will be multiplied with each other. E.g. if we have a list
with one constant and one reservoir, the reservoir concentration
will be multiplied with the constant. If we have two reservoirs,
the respective reservoir concentrations will be multiplied with
each other.</li>
<li>=right= similar to =left= The final flux rate will be computed as
the difference between =left= and =right=</li>
<li><p>=k_value= a constant which will be multiplied with the difference
between =left=and =right=</p>

<p>Example::</p>

<p>Connect(source=R_CO2,         # target of flux
         sink=R_HCO3,          # source of flux
         rate="1 mol/s",       # flux rate
         ctype="flux_balance", # connection type
         scale=1,            # global scaling factor, optional
         left=[K1, R_CO2],     # where K1 is a constant
         right=[R_HCO3, R_Hplus])</p>

<p>Useful methods in this class</p></li>
</ul>

<hr />

<p>The following methods might prove useful</p>

<ul>
<li>info() will provide a short description of the connection objects.</li>
<li>list_processes() which will list all the processes which are associated with this connection.</li>
<li>update() which allows you to update connection properties after the connection has been created</li>
</ul>
</div>


                            <div id="Connect.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Connect.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Connect</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The init method of the connector obbjects performs sanity checks e.g.:</span>
<span class="sd">               - whether the reservoirs exist</span>
<span class="sd">               - correct flux properties (this will be handled by the process object)</span>
<span class="sd">               - whether the processes do exist (hmmh, that implies that the optional processes do get registered with the model)</span>
<span class="sd">               - creates the correct default processes</span>
<span class="sd">               - and connects the reservoirs</span>

<span class="sd">        see the class documentation for details and examples</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">ureg</span><span class="p">,</span> <span class="n">Q_</span>

        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Source</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Sink</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="n">Species</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Flux</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;ratio&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;ref_value&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Q_</span><span class="p">),</span>
            <span class="s2">&quot;a_value&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;b_value&quot;</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="s2">&quot;register&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">,</span> <span class="n">ConnectionGroup</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">),</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;sink&quot;</span><span class="p">]</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isotopes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># validate and initialize instance variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initerrormessages__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bem</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;k_concentration&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k_mass&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;k_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;a number or Quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;a_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ref_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number, string, or quantity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;b_value&quot;</span><span class="p">:</span> <span class="s2">&quot;a number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;a string&quot;</span><span class="p">,</span>
                <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="s2">&quot;Number, list or Reservoir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="s2">&quot;Number, list or Reservoir&quot;</span><span class="p">,</span>
                <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="s2">&quot;Signal Handle&quot;</span><span class="p">,</span>
                <span class="s2">&quot;groupname&quot;</span><span class="p">:</span> <span class="s2">&quot;True or False&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;source/sink&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drn</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;_alpha&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;_rate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;_delta&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># if kwargs[&quot;id&quot;] != &quot;None&quot;:</span>
        <span class="c1">#    self.name = self.name + f&quot;_{self.id}&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;pl&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Process</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">!=</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>

        <span class="c1"># if no reference reservoir is specified, default to the upstream</span>
        <span class="c1"># reservoir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_reservoirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>

        <span class="c1"># decide if this connection needs isotope calculations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">isotopes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">isotopes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isotopes</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># legacy names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">influx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outflux</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the default process handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">:</span> <span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">:</span> <span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Reservoir</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_species</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">mo</span>  <span class="c1"># the current model handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Flux</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of fluxes in this connection</span>
        <span class="c1"># get a list of all reservoirs registered for this species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Reservoir</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">lor</span>

        <span class="c1"># make sure scale is a number in model units</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">Q_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">Q_</span><span class="p">):</span>
            <span class="c1"># test what type of Quantity we have</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">([</span><span class="s2">&quot;volume]/[time&quot;</span><span class="p">]):</span>  <span class="c1"># flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">r_unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">([</span><span class="s2">&quot;mass] / [time&quot;</span><span class="p">]):</span>  <span class="c1"># flux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">f_unit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="s2">&quot;[mass]/[volume]&quot;</span><span class="p">):</span>  <span class="c1"># concentration</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">c_unit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No conversion to model units for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2"> specified&quot;</span><span class="p">)</span>

        <span class="c1"># if sink and source a regular, the name will be simply C_S_2_S</span>
        <span class="c1"># if we deal with ReservoirGroups we need to reflect this in the</span>
        <span class="c1"># connection name</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_2_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># this yields something like PO42PO4</span>
        <span class="c1"># if we are part of connection group we need to add this</span>
        <span class="c1"># to the connectiongroup</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_flux__</span><span class="p">()</span>  <span class="c1"># Source/Sink/Regular</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__set_process_type__</span><span class="p">()</span>  <span class="c1"># derive flux type and create flux(es)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>  <span class="c1"># register connection in namespace</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with reservoir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># register connector with model</span>

        <span class="c1"># This should probably move to register fluxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_process__</span><span class="p">()</span>

        <span class="c1"># if self.register == &quot;None&quot;:</span>
        <span class="c1">#     print(f&quot;Created connection {self.name}&quot;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     print(f&quot;Created connection {self.register.name}.{self.name}&quot;)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">full_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>The init method of the connector obbjects performs sanity checks e.g.:
       - whether the reservoirs exist
       - correct flux properties (this will be handled by the process object)
       - whether the processes do exist (hmmh, that implies that the optional processes do get registered with the model)
       - creates the correct default processes
       - and connects the reservoirs</p>

<p>see the class documentation for details and examples</p>
</div>


                            </div>
                            <div id="Connect.lkk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.lkk">#&nbsp;&nbsp</a>

        <span class="name">lkk</span><span class="annotation">: Dict[str, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Connect.lrk" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.lrk">#&nbsp;&nbsp</a>

        <span class="name">lrk</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="Connect.lod" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.lod">#&nbsp;&nbsp</a>

        <span class="name">lod</span><span class="annotation">: Dict[&lt;built-in function any&gt;, &lt;built-in function any&gt;]</span>
    </div>

    

                            </div>
                            <div id="Connect.influx" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.influx">#&nbsp;&nbsp</a>

        <span class="name">influx</span><span class="annotation">: int</span>
    </div>

    

                            </div>
                            <div id="Connect.outflux" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.outflux">#&nbsp;&nbsp</a>

        <span class="name">outflux</span><span class="annotation">: int</span>
    </div>

    

                            </div>
                            <div id="Connect.mo" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.mo">#&nbsp;&nbsp</a>

        <span class="name">mo</span><span class="annotation">: <a href="esbmtk.html#Model">esbmtk.esbmtk.Model</a></span>
    </div>

    

                            </div>
                            <div id="Connect.r1" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.r1">#&nbsp;&nbsp</a>

        <span class="name">r1</span><span class="annotation">: &#39;(Process, Reservoir)&#39;</span>
    </div>

    

                            </div>
                            <div id="Connect.r2" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.r2">#&nbsp;&nbsp</a>

        <span class="name">r2</span><span class="annotation">: &#39;(Process, Reservoir)&#39;</span>
    </div>

    

                            </div>
                            <div id="Connect.lof" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.lof">#&nbsp;&nbsp</a>

        <span class="name">lof</span><span class="annotation">: &#39;list[Flux]&#39;</span>
    </div>

    

                            </div>
                            <div id="Connect.lor" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.lor">#&nbsp;&nbsp</a>

        <span class="name">lor</span><span class="annotation">: &#39;list[Reservoir]&#39;</span>
    </div>

    

                            </div>
                            <div id="Connect.update" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Connect.update">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update</span><span class="signature">(self, **kwargs)</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update connection properties. This will delete existing processes</span>
<span class="sd">        and fluxes, replace existing key-value pairs in the</span>
<span class="sd">        self.kwargs dict, and then re-initialize the connection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_process__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delete_flux__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_connection__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Update connection properties. This will delete existing processes
and fluxes, replace existing key-value pairs in the
self.kwargs dict, and then re-initialize the connection.</p>
</div>


                            </div>
                            <div id="Connect.get_species" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Connect.get_species">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">get_species</span><span class="signature">(self, r1, r2) -&gt; NoneType</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">get_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;In most cases the species is set by r2. However, if we have</span>
<span class="sd">        backward fluxes the species depends on the r2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(f&quot;r1 = {r1.n}, r2 = {r2.n}&quot;)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># in this case we do have an upstream reservoir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r2</span>

        <span class="c1"># test if species was explicitly given</span>
        <span class="k">if</span> <span class="s2">&quot;species&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># this is a quick fix only</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span>  <span class="c1"># get the parent species</span>
</pre></div>

        </details>

            <div class="docstring"><p>In most cases the species is set by r2. However, if we have
backward fluxes the species depends on the r2</p>
</div>


                            </div>
                            <div id="Connect.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Connect.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self, **kwargs) -&gt; NoneType</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Show an overview of the object properties.</span>
<span class="sd">        Optional arguments are</span>
<span class="sd">        index  :int = 0 this will show data at the given index</span>
<span class="sd">        indent :int = 0 indentation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">off</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;  &quot;</span>
        <span class="k">if</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;indent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;indent&quot;</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span>

        <span class="c1"># print basic data bout this Connection</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s2">Fluxes:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lof</span><span class="p">):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Show an overview of the object properties.
Optional arguments are
index  :int = 0 this will show data at the given index
indent :int = 0 indentation</p>
</div>


                            </div>
                            <div id="Connect.alpha" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.alpha">#&nbsp;&nbsp</a>

        <span class="name">alpha</span><span class="annotation">: numbers.Number</span>
    </div>

    

                            </div>
                            <div id="Connect.rate" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.rate">#&nbsp;&nbsp</a>

        <span class="name">rate</span><span class="annotation">: numbers.Number</span>
    </div>

    

                            </div>
                            <div id="Connect.delta" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#Connect.delta">#&nbsp;&nbsp</a>

        <span class="name">delta</span><span class="annotation">: numbers.Number</span>
    </div>

    

                            </div>
                </section>
                <section id="Connection">
                                <div class="attr class">
        <a class="headerlink" href="#Connection">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Connection</span>(<span class="base"><a href="#Connect">Connect</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="n">Connect</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alias for the Connect class&quot;&quot;&quot;</span>
</pre></div>

        </details>

            <div class="docstring"><p>Alias for the Connect class</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#Connect">Connect</a></dt>
                                <dd id="Connection.__init__" class="function"><a href="#Connect.__init__">Connect</a></dd>
                <dd id="Connection.lkk" class="variable"><a href="#Connect.lkk">lkk</a></dd>
                <dd id="Connection.lrk" class="variable"><a href="#Connect.lrk">lrk</a></dd>
                <dd id="Connection.lod" class="variable"><a href="#Connect.lod">lod</a></dd>
                <dd id="Connection.influx" class="variable"><a href="#Connect.influx">influx</a></dd>
                <dd id="Connection.outflux" class="variable"><a href="#Connect.outflux">outflux</a></dd>
                <dd id="Connection.mo" class="variable"><a href="#Connect.mo">mo</a></dd>
                <dd id="Connection.r1" class="variable"><a href="#Connect.r1">r1</a></dd>
                <dd id="Connection.r2" class="variable"><a href="#Connect.r2">r2</a></dd>
                <dd id="Connection.lof" class="variable"><a href="#Connect.lof">lof</a></dd>
                <dd id="Connection.lor" class="variable"><a href="#Connect.lor">lor</a></dd>
                <dd id="Connection.update" class="function"><a href="#Connect.update">update</a></dd>
                <dd id="Connection.get_species" class="function"><a href="#Connect.get_species">get_species</a></dd>
                <dd id="Connection.info" class="function"><a href="#Connect.info">info</a></dd>
                <dd id="Connection.alpha" class="variable"><a href="#Connect.alpha">alpha</a></dd>
                <dd id="Connection.rate" class="variable"><a href="#Connect.rate">rate</a></dd>
                <dd id="Connection.delta" class="variable"><a href="#Connect.delta">delta</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ConnectionGroup">
                                <div class="attr class">
        <a class="headerlink" href="#ConnectionGroup">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">ConnectionGroup</span>(<span class="base"><a href="esbmtk.html#esbmtkBase">esbmtk.esbmtk.esbmtkBase</a></span>):
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">ConnectionGroup</span><span class="p">(</span><span class="n">esbmtkBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Name:</span>

<span class="sd">        ConnectionGroup</span>

<span class="sd">        Connect reservoir/sink/source groups when at least one of the</span>
<span class="sd">        arguments is a reservoirs_group object. This method will</span>
<span class="sd">        create regular connections for each matching species.</span>

<span class="sd">        Use the connection.update() method to fine tune connections</span>
<span class="sd">        after creation</span>

<span class="sd">    Example::</span>

<span class="sd">        ConnectionGroup(source =  upstream reservoir / upstream reservoir group</span>
<span class="sd">           sink = downstrean reservoir / downstream reservoirs_group</span>
<span class="sd">           delta = defaults to zero and has to be set manually</span>
<span class="sd">           alpha =  defaults to zero and has to be set manually</span>
<span class="sd">           rate = shared between all connections</span>
<span class="sd">           ref_reservoirs = shared between all connections</span>
<span class="sd">           species = list, optional, if present, only these species will be connected</span>
<span class="sd">           ctype = needs to be set for all connections. Use &quot;Regular&quot;</span>
<span class="sd">                   unless you require a specific connection type</span>
<span class="sd">           pl = [list]) process list. optional, shared between all connections</span>
<span class="sd">           id = optional identifier, passed on to individual connection</span>
<span class="sd">           plot = &quot;yes/no&quot; # defaults to yes, shared between all connections</span>
<span class="sd">        )</span>

<span class="sd">        ConnectionGroup(</span>
<span class="sd">                  source=OM_Weathering,</span>
<span class="sd">                  sink=Ocean,</span>
<span class="sd">                  rate={DIC: f&quot;{OM_w} Tmol/yr&quot; ,</span>
<span class="sd">                        ALK: f&quot;{0} Tmol/yr&quot;},</span>
<span class="sd">                  ctype = {DIC: &quot;Regular&quot;,</span>
<span class="sd">                           ALK: &quot;Regular&quot;},</span>
<span class="sd">    )</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_kwargs__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># # self.source.lor is a  list with the object names in the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of connection objects</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_connections__</span><span class="p">()</span>

        <span class="c1"># register connection group in global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a connection to the connection group</span>
<span class="sd">        This will overwrite the original kwargs though</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_kwargs__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_connections__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__parse_kwargs__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse and register the keyword arguments</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># provide a dict of all known keywords and their type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lkk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SourceGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;sink&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">SinkGroup</span><span class="p">,</span> <span class="n">ReservoirGroup</span><span class="p">),</span>
            <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;pl&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">Signal</span><span class="p">,</span>
            <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;species&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># list of default values if none provided</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">any</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">2</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sink&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;2&quot;</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;sink&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">n</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;C_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># set connection group name</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">})</span>  <span class="c1"># and add it to the kwargs</span>

        <span class="c1"># provide a list of absolutely required keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrk</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;sink&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__validateandregister__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__create_connections__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create Connections&quot;&quot;&quot;</span>
        <span class="c1"># find all sub reservoirs which have been specified by the ctype keyword</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">lor</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Connectiongroup </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> must specify &#39;ctype&#39;. See help(Connectiongroup)&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found species </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># now we need to create defaults for all connections</span>
        <span class="c1"># we setup a dict like this  {SO4:{cid:xxx,plot:xxx}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># connection dictionary</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>  <span class="c1"># [&quot;SO4&quot;, &quot;H2S&quot;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;plot&quot;</span><span class="p">:</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ctype&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bypass&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># now we loop trough all keys for this connection and see</span>
            <span class="c1"># if we find a corresponding item in the kwargs</span>
            <span class="k">for</span> <span class="n">kcd</span><span class="p">,</span> <span class="n">vcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">kcd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>  <span class="c1"># found entry like ctype</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">]:</span>  <span class="c1"># {SO4: xxx}</span>
                        <span class="c1"># update the entry</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="n">kcd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">kcd</span><span class="p">][</span><span class="n">r</span><span class="o">.</span><span class="n">sp</span><span class="p">]</span>
            <span class="c1"># now we can create the connection</span>

            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">Connect</span><span class="p">(</span>
                <span class="c1"># name=name,</span>
                <span class="n">source</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">),</span>
                <span class="n">sink</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">),</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;rate&quot;</span><span class="p">],</span>
                <span class="n">delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;delta&quot;</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;alpha&quot;</span><span class="p">],</span>
                <span class="n">plot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;plot&quot;</span><span class="p">],</span>
                <span class="n">ctype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;ctype&quot;</span><span class="p">],</span>
                <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;scale&quot;</span><span class="p">],</span>
                <span class="n">bypass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;bypass&quot;</span><span class="p">],</span>
                <span class="n">ref_reservoirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cd</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;ref_reservoirs&quot;</span><span class="p">],</span>
                <span class="n">groupname</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">register</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1">## add connection to list of connections</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List all connections in this group&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group Connection from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following Connections are part of this group</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You can query the details of each connection like this:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Name:</p>

<pre><code>ConnectionGroup

Connect reservoir/sink/source groups when at least one of the
arguments is a reservoirs_group object. This method will
create regular connections for each matching species.

Use the connection.update() method to fine tune connections
after creation
</code></pre>

<p>Example::</p>

<pre><code>ConnectionGroup(source =  upstream reservoir / upstream reservoir group
   sink = downstrean reservoir / downstream reservoirs_group
   delta = defaults to zero and has to be set manually
   alpha =  defaults to zero and has to be set manually
   rate = shared between all connections
   ref_reservoirs = shared between all connections
   species = list, optional, if present, only these species will be connected
   ctype = needs to be set for all connections. Use "Regular"
           unless you require a specific connection type
   pl = [list]) process list. optional, shared between all connections
   id = optional identifier, passed on to individual connection
   plot = "yes/no" # defaults to yes, shared between all connections
)

ConnectionGroup(
          source=OM_Weathering,
          sink=Ocean,
          rate={DIC: f"{OM_w} Tmol/yr" ,
                ALK: f"{0} Tmol/yr"},
          ctype = {DIC: "Regular",
                   ALK: "Regular"},
</code></pre>

<p>)</p>
</div>


                            <div id="ConnectionGroup.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConnectionGroup.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">ConnectionGroup</span><span class="signature">(**kwargs)</span>
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_kwargs__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># # self.source.lor is a  list with the object names in the group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">lor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of connection objects</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__create_connections__</span><span class="p">()</span>

        <span class="c1"># register connection group in global namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__register_name__</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="ConnectionGroup.loc" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#ConnectionGroup.loc">#&nbsp;&nbsp</a>

        <span class="name">loc</span><span class="annotation">: list</span>
    </div>

    

                            </div>
                            <div id="ConnectionGroup.update" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConnectionGroup.update">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">update</span><span class="signature">(self, **kwargs) -&gt; NoneType</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a connection to the connection group</span>
<span class="sd">        This will overwrite the original kwargs though</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__parse_kwargs__</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__create_connections__</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Add a connection to the connection group
This will overwrite the original kwargs though</p>
</div>


                            </div>
                            <div id="ConnectionGroup.info" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#ConnectionGroup.info">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">info</span><span class="signature">(self) -&gt; NoneType</span>:
    </div>

                <details>
            <summary>View Source</summary>
            <div class="codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List all connections in this group&quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group Connection from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following Connections are part of this group</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;You can query the details of each connection like this:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.info()&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>List all connections in this group</p>
</div>


                            </div>
                </section>
    </main>
</body>
</html>